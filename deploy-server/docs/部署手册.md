# ClickHouse 通用部署手册

## 概述

本手册提供在 RHEL 兼容发行版和 Ubuntu LTS / Debian 系统上部署ClickHouse的完整方案，包括自动化部署和手动部署两种方式。自动化部署可以大大节省部署时间，推荐在生产环境中使用。

## 系统要求

### 硬件要求

- **CPU**: 4核 (推荐8核)
- **内存**: 16GB (推荐32GB)
- **存储**: 150GB NVMe SSD (推荐300GB)
- **网络**: 1Gbps带宽

### 软件要求

#### 支持的操作系统

**RHEL 兼容发行版:**

- RHEL 7.x/8.x/9.x
- CentOS 7.x/8.x
- Rocky Linux 8.x/9.x
- AlmaLinux 8.x/9.x
- Fedora 35+

**Ubuntu/Debian:**

- Ubuntu 20.04 LTS+
- Debian 11+
- Debian 12+

#### ClickHouse版本

- ClickHouse 23.8 或更高版本

## 部署方式选择

### 方式一：自动化部署（推荐）

**执行时间**: 10-15分钟
**适用场景**: 生产环境、快速部署

```bash
sudo ./scripts/auto-deploy.sh
```

### 方式二：手动部署

**执行时间**: 30-60分钟
**适用场景**: 学习、定制化部署

## 自动化部署

### 一键部署（最简单）

```bash
# 1. 下载项目文件
git clone <repository-url>
cd clickhouse/deploy-server

# 2. 给脚本添加执行权限
chmod +x scripts/*.sh

# 3. 执行一键部署
sudo ./scripts/auto-deploy.sh
```

### 分步自动化部署

```bash
# 1. 平台兼容性测试
sudo ./scripts/platform-test.sh

# 2. 系统环境准备
sudo ./scripts/setup-system.sh

# 3. 安装ClickHouse
sudo ./scripts/install-clickhouse.sh

# 4. 配置优化
sudo ./scripts/setup-config.sh

# 5. 启动服务
sudo ./scripts/start-service.sh

# 6. 健康检查
./scripts/health-check.sh

# 7. 用户测试
./scripts/test-users.sh

# 7. 用户测试
./scripts/test-users.sh
```

### 自动化脚本说明

| 脚本名称 | 功能 | 执行时间 | 平台支持 |
|---------|------|----------|----------|
| `auto-deploy.sh` | 一键完成所有部署步骤 | 10-15分钟 | 全平台 |
| `platform-test.sh` | 平台兼容性测试 | 1-2分钟 | 全平台 |
| `setup-system.sh` | 系统环境准备和优化 | 3-5分钟 | 全平台 |
| `install-clickhouse.sh` | 安装ClickHouse服务 | 2-3分钟 | 全平台 |
| `setup-config.sh` | 配置优化和安全设置（包含模块化配置） | 2-3分钟 | 全平台 |
| `start-service.sh` | 启动ClickHouse服务 | 30秒 | 全平台 |
| `health-check.sh` | 健康检查和验证 | 30秒 | 全平台 |
| `test-users.sh` | 用户配置测试 | 30秒 | 全平台 |
| `monitor.sh` | 实时监控服务 | 持续运行 | 全平台 |
| `backup.sh` | 数据备份 | 根据数据量 | 全平台 |
| `test-users.sh` | 用户配置测试 | 30秒 | 全平台 |
| `monitor.sh` | 实时监控服务 | 持续运行 | 全平台 |
| `backup.sh` | 数据备份 | 根据数据量 | 全平台 |

### 自动化部署流程详解

#### 1. 平台兼容性测试 (platform-test.sh)

自动检测系统兼容性，包括：
- 操作系统类型和版本
- 系统架构 (x86_64/amd64)
- 硬件配置 (CPU、内存、磁盘)
- 网络连接
- 依赖包检查

#### 2. 系统环境准备 (setup-system.sh)




## 目录

- [1. 环境准备](#1-环境准备)
- [2. ClickHouse安装](#2-clickhouse安装)
- [3. 基础配置](#3-基础配置)
- [4. 数据库初始化](#4-数据库初始化)
- [5. 监控部署](#5-监控部署)
- [6. 安全配置](#6-安全配置)
- [7. 备份策略](#7-备份策略)
- [8. 验证测试](#8-验证测试)
- [9. 故障排查](#9-故障排查)

---

## 1. 环境准备

### 1.1 系统要求检查

```bash
# 使用平台测试脚本
./scripts/platform-test.sh

# 手动检查系统信息
cat /etc/os-release
uname -m
free -h
df -h
nproc
```

### 1.2 系统更新

**RHEL 兼容发行版:**

```bash
# 使用 yum (CentOS 7, RHEL 7)
sudo yum update -y

# 使用 dnf (CentOS 8+, RHEL 8+, Rocky, Alma)
sudo dnf update -y
```

**Ubuntu/Debian:**

```bash
sudo apt update -y
sudo apt upgrade -y
```

### 1.3 安装基础工具

**RHEL 兼容发行版:**

```bash
# 使用 yum
sudo yum install -y wget curl git vim net-tools bc

# 使用 dnf
sudo dnf install -y wget curl git vim net-tools bc
```

**Ubuntu/Debian:**

```bash
sudo apt install -y wget curl git vim net-tools bc
```

### 1.4 创建ClickHouse用户

```bash
# 创建系统用户
sudo useradd -r -s /bin/false -d /var/lib/clickhouse clickhouse

# 创建必要目录
sudo mkdir -p /var/lib/clickhouse
sudo mkdir -p /var/log/clickhouse-server
sudo mkdir -p /etc/clickhouse-server
sudo mkdir -p /etc/clickhouse-server/config.d
sudo mkdir -p /etc/clickhouse-server/users.d
sudo mkdir -p /opt/clickhouse/backups
sudo mkdir -p /opt/clickhouse/logs

# 设置目录权限
sudo chown -R clickhouse:clickhouse /var/lib/clickhouse
sudo chown -R clickhouse:clickhouse /var/log/clickhouse-server
sudo chown -R clickhouse:clickhouse /etc/clickhouse-server
sudo chown -R clickhouse:clickhouse /opt/clickhouse
```

### 1.5 系统参数优化

```bash
# 编辑系统参数
sudo tee -a /etc/sysctl.conf << EOF
# ClickHouse优化参数
fs.file-max = 65536
fs.nr_open = 65536
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 5000
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 1200
net.ipv4.tcp_max_tw_buckets = 5000
vm.swappiness = 1
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
EOF

# 应用系统参数
sudo sysctl -p
```

### 1.6 用户限制配置

```bash
# 编辑用户限制
sudo tee -a /etc/security/limits.conf << EOF
# ClickHouse用户限制
clickhouse soft nofile 65536
clickhouse hard nofile 65536
clickhouse soft nproc 32768
clickhouse hard nproc 32768
EOF
```

### 1.7 防火墙配置

**RHEL 兼容发行版:**

```bash
# 配置firewall-cmd
sudo firewall-cmd --permanent --add-port=8123/tcp
sudo firewall-cmd --permanent --add-port=9000/tcp
sudo firewall-cmd --reload
```

**Ubuntu/Debian:**

```bash
# 配置UFW
sudo ufw allow 8123/tcp
sudo ufw allow 9000/tcp

# 或者配置iptables
sudo iptables -A INPUT -p tcp --dport 8123 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 9000 -j ACCEPT
```

### 1.8 安全策略配置

**SELinux (RHEL 兼容发行版):**

```bash
# 检查SELinux状态
sudo sestatus

# 如果启用，配置ClickHouse策略
if sudo sestatus | grep -q "enabled"; then
    sudo setsebool -P clickhouse_can_network_connect 1
    sudo setsebool -P clickhouse_can_network_connect_db 1
fi
```

**AppArmor (Ubuntu/Debian):**

```bash
# 检查AppArmor状态
sudo apparmor_status

# 如果ClickHouse有AppArmor配置文件，重新加载
if [ -f /etc/apparmor.d/usr.bin.clickhouse-server ]; then
    sudo apparmor_parser -r /etc/apparmor.d/usr.bin.clickhouse-server
fi
```

---

## 2. ClickHouse安装

### 2.1 添加官方仓库

**RHEL 兼容发行版:**

```bash
# 使用 yum
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://packages.clickhouse.com/rpm/clickhouse.repo

# 使用 dnf
sudo dnf install -y yum-utils
sudo dnf config-manager --add-repo https://packages.clickhouse.com/rpm/clickhouse.repo
```

**Ubuntu/Debian:**

```bash
sudo apt install -y apt-transport-https ca-certificates dirmngr
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 8919F6BD2B48D754
echo "deb https://packages.clickhouse.com/deb stable main" | sudo tee /etc/apt/sources.list.d/clickhouse.list
sudo apt update
```

### 2.2 安装ClickHouse

**RHEL 兼容发行版:**

```bash
# 使用 yum
sudo yum install -y clickhouse-server clickhouse-client

# 使用 dnf
sudo dnf install -y clickhouse-server clickhouse-client
```

**Ubuntu/Debian:**

```bash
sudo apt install -y clickhouse-server clickhouse-client
```

### 2.3 验证安装

```bash
# 检查ClickHouse版本
clickhouse-server --version
clickhouse-client --version

# 检查服务状态
sudo systemctl status clickhouse-server
```

---

## 3. 基础配置

### 3.1 配置文件结构

```bash
# 配置文件目录
/etc/clickhouse-server/
├── config.d/               # 配置片段目录
│   └── config.xml          # 主配置文件（性能优化、日志、网络等）
└── users.d/                # 用户配置片段目录
    └── users.xml           # 用户配置文件（用户权限、配额等）
```

**重要说明**: 新的配置结构使用模块化方式，将主配置和用户配置分别放在 `config.d` 和 `users.d` 目录中，便于管理和维护。自动部署脚本会自动清理旧的配置文件并设置正确的权限。

**配置特点**:
- 自动备份原始配置
- 使用模块化配置管理
- 自动清理旧的default-user.xml文件
- 重新定义默认用户配置
- 设置正确的文件权限

### 3.2 主配置文件 (config.d/config.xml)

**文件位置**: `/etc/clickhouse-server/config.d/config.xml`

```xml
<clickhouse>
    <timezone>UTC</timezone>
    
    <!-- 日志配置优化 -->
    <logger>
        <level>warning</level>
        <log_remove_reason>0</log_remove_reason>
        <system_logs_level>warning</system_logs_level>
        <log>/var/log/clickhouse-server/clickhouse-server.log</log>
        <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>
        <size>1000M</size>
        <count>10</count>
        <console>0</console>
    </logger>

    <!-- 系统级优化配置 -->
    <system>
        <async_insert_threads>8</async_insert_threads>
        <async_insert>1</async_insert>
        <system_tables_cleanup_interval>3600</system_tables_cleanup_interval>
        <tmp_path>/var/lib/clickhouse/tmp</tmp_path>
        <max_temporary_data_on_disk_size>0</max_temporary_data_on_disk_size>
        
        <!-- 禁用大部分系统日志以提高性能 -->
        <metric_log_enabled>0</metric_log_enabled>
        <asynchronous_metric_log_enabled>0</asynchronous_metric_log_enabled>
        <query_log_enabled>0</query_log_enabled>
        <text_log_enabled>0</text_log_enabled>
        <trace_log_enabled>0</trace_log_enabled>
        <processors_profile_log_enabled>0</processors_profile_log_enabled>
        <latency_log_enabled>0</latency_log_enabled>
        <error_log_enabled>0</error_log_enabled>
    </system>

    <!-- 网络配置 -->
    <listen_host>0.0.0.0</listen_host>
    <http_port>8123</http_port>
    <tcp_port>9000</tcp_port>
    <max_connections>4096</max_connections>
    <keep_alive_timeout>3</keep_alive_timeout>
    <max_concurrent_queries>10</max_concurrent_queries>

    <!-- 内存和缓存配置 (16GB总内存) -->
    <max_server_memory_usage>12884901888</max_server_memory_usage> <!-- 12GB -->
    <uncompressed_cache_size>6442450944</uncompressed_cache_size>  <!-- 6GB -->
    <mark_cache_size>3221225472</mark_cache_size>                 <!-- 3GB -->

    <!-- MergeTree调优 (150GB NVMe) -->
    <merge_tree>
        <parts_to_delay_insert>150</parts_to_delay_insert>
        <parts_to_throw_insert>300</parts_to_throw_insert>
        <max_bytes_to_merge_at_max_space_in_pool>107374182400</max_bytes_to_merge_at_max_space_in_pool> <!-- 100GB -->
        <max_bytes_to_merge_at_min_space_in_pool>53687091200</max_bytes_to_merge_at_min_space_in_pool>  <!-- 50GB -->
        <index_granularity>8192</index_granularity>
        <index_granularity_bytes>0</index_granularity_bytes>
        <min_bytes_for_wide_part>0</min_bytes_for_wide_part>
        <min_rows_for_wide_part>0</min_rows_for_wide_part>
    </merge_tree>

    <!-- 性能优化配置 -->
    <performance>
        <background_pool_size>4</background_pool_size>
        <background_schedule_pool_size>4</background_schedule_pool_size>
    </performance>

    <!-- 错误处理和权限优化 -->
    <error_handling>
        <ignore_file_permission_errors>1</ignore_file_permission_errors>
        <max_retries_for_file_operations>1</max_retries_for_file_operations>
    </error_handling>

    <!-- 系统日志配置 -->
    <query_log>
        <database>system</database>
        <table>query_log</table>
        <partition_by>toYYYYMM(event_date)</partition_by>
        <flush_interval_milliseconds>30000</flush_interval_milliseconds>
    </query_log>

    <!-- 系统表 TTL 配置 -->
    <system_tables_ttl>
        <asynchronous_metric_log>
            <ttl>event_time + INTERVAL 1 DAY</ttl>
        </asynchronous_metric_log>
        <query_log>
            <ttl>event_time + INTERVAL 6 HOUR</ttl>
        </query_log>
        <text_log>
            <ttl>event_time + INTERVAL 6 HOUR</ttl>
        </text_log>
    </system_tables_ttl>

    <remote_servers /> 
</clickhouse>
```

### 3.3 用户配置文件 (users.d/users.xml)

**文件位置**: `/etc/clickhouse-server/users.d/users.xml`

**重要说明**: 默认用户配置已更新，移除了原有的default用户并重新定义，确保配置的一致性和安全性。

```xml
<clickhouse>
    <users>
        <!-- 移除默认用户 -->
        <default remove="remove">
        </default>

        <!-- 重新定义默认用户 -->
        <default>
            <profile>default</profile>
            <networks>
                <ip>::/0</ip>
            </networks>
            <password><![CDATA[clickhouse123]]></password>
            <quota>default</quota>
            <access_management>1</access_management>
        </default>

        <!-- 管理员用户 -->
        <admin>
            <password>Admin_2024_Secure!</password>
            <networks>
                <ip>127.0.0.1</ip>
                <ip>10.0.0.0/8</ip>
                <ip>172.16.0.0/12</ip>
                <ip>192.168.0.0/16</ip>
            </networks>
            <profile>default</profile>
            <access_management>1</access_management>
        </admin>

        <!-- Web用户 -->
        <webuser>
            <password>WebUser_2024_Secure!</password>
            <networks>
                <ip>::/0</ip>
            </networks>
            <profile>default</profile>
            <access_management>0</access_management>
        </webuser>
        
        <!-- 演示用户 -->
        <demouser>
            <password>DemoUser_2024_Secure!</password>
            <networks>
                <ip>::/0</ip>
            </networks>
            <profile>default</profile>
            <access_management>0</access_management>
            <readonly>1</readonly>
            <default_database>demo</default_database>
            <max_memory_usage_for_user_for_all_queries>12884901888</max_memory_usage_for_user_for_all_queries>
        </demouser>
    </users>
    
    <profiles>
        <default>
            <max_threads>4</max_threads>
            <max_insert_threads>4</max_insert_threads>
            <max_memory_usage>12884901888</max_memory_usage>
            <max_memory_usage_for_user>12884901888</max_memory_usage_for_user>
            <max_memory_usage_for_all_queries>12884901888</max_memory_usage_for_all_queries>
            
            <!-- 超时设置 -->
            <connect_timeout>10</connect_timeout>
            <receive_timeout>300</receive_timeout>
            <send_timeout>300</send_timeout>

            <!-- 异步插入 -->
            <async_insert>1</async_insert>
            <async_insert_threads>4</async_insert_threads>
        </default>
    </profiles>
</clickhouse>
```

---

## 4. 数据库初始化

### 4.1 启动服务

```bash
# 启动ClickHouse服务
sudo systemctl start clickhouse-server

# 设置开机自启
sudo systemctl enable clickhouse-server

# 检查服务状态
sudo systemctl status clickhouse-server
```

### 4.2 连接测试

```bash
# 使用客户端连接
clickhouse-client

# 或者指定密码
clickhouse-client --password=clickhouse123

# 测试查询
clickhouse-client --query "SELECT version()"

# 测试所有用户
./scripts/test-users.sh

# 测试所有用户
./scripts/test-users.sh
```

### 4.3 创建测试数据库

```sql
-- 创建测试数据库
CREATE DATABASE IF NOT EXISTS test;

-- 创建测试表
CREATE TABLE test.test_table (
    id UInt32,
    name String,
    created_at DateTime
) ENGINE = MergeTree()
ORDER BY id;

-- 插入测试数据
INSERT INTO test.test_table VALUES (1, 'test1', now()), (2, 'test2', now());

-- 查询测试
SELECT * FROM test.test_table;
```

---

## 5. 监控部署

### 5.1 系统监控

```bash
# 使用监控脚本
./scripts/monitor.sh
```

```bash
# 使用监控脚本
./scripts/monitor.sh

# 创建监控脚本
sudo tee /opt/clickhouse/monitor.sh << 'EOF'
#!/bin/bash

echo "=== ClickHouse 监控报告 ==="
echo "时间: $(date)"
echo ""

# 服务状态
echo "服务状态:"
systemctl is-active clickhouse-server
echo ""

# 内存使用
echo "内存使用:"
free -h
echo ""

# 磁盘使用
echo "磁盘使用:"
df -h /var/lib/clickhouse/
echo ""

# ClickHouse进程
echo "ClickHouse进程:"
ps aux | grep clickhouse
echo ""

# 端口监听
echo "端口监听:"
netstat -tlnp | grep clickhouse
echo ""
EOF

chmod +x /opt/clickhouse/monitor.sh
```

### 5.2 性能监控

```sql
-- 查看系统指标
SELECT metric, value 
FROM system.metrics 
WHERE metric IN ('MemoryUsage', 'CPUUtilization', 'Query')
ORDER BY value DESC;

-- 查看慢查询
SELECT query, query_duration_ms, memory_usage
FROM system.query_log 
WHERE query_duration_ms > 1000
ORDER BY query_duration_ms DESC
LIMIT 10;
```

### 5.3 健康检查

```bash
# 使用健康检查脚本
./scripts/health-check.sh

# 配置健康检查
cp scripts/health-check.conf.example health-check.conf
# 编辑配置文件设置告警阈值
```

### 5.3 健康检查

```bash
# 使用健康检查脚本
./scripts/health-check.sh

# 配置健康检查
cp scripts/health-check.conf.example health-check.conf
# 编辑配置文件设置告警阈值
```

---

## 6. 安全配置

### 6.1 网络安全

```xml
<!-- 网络安全配置 -->
<listen_host>0.0.0.0</listen_host>
<listen_host>::</listen_host>

<!-- SSL配置 -->
<https_port>8443</https_port>
<ssl_certificates>
    <certificate>
        <cert_file>/path/to/cert.pem</cert_file>
        <key_file>/path/to/key.pem</key_file>
    </certificate>
</ssl_certificates>
```

### 6.2 访问控制

```xml
<!-- 用户权限配置 -->
<users>
    <readonly>
        <password>ReadOnlyPass123!</password>
        <networks>
            <ip>192.168.1.0/24</ip>
        </networks>
        <profile>readonly</profile>
        <quota>readonly</quota>
    </readonly>
</users>

<profiles>
    <readonly>
        <readonly>1</readonly>
        <max_memory_usage>5000000000</max_memory_usage>
    </readonly>
</profiles>
```

---

## 7. 备份策略

### 7.1 数据备份

```bash
# 使用备份脚本
./scripts/backup.sh full        # 完整备份
./scripts/backup.sh incremental # 增量备份
./scripts/backup.sh config      # 配置备份
```

```bash
# 使用备份脚本
./scripts/backup.sh full        # 完整备份
./scripts/backup.sh incremental # 增量备份
./scripts/backup.sh config      # 配置备份

# 创建备份脚本
sudo tee /opt/clickhouse/backup.sh << 'EOF'
#!/bin/bash

BACKUP_DIR="/opt/clickhouse/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="clickhouse_backup_$DATE"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 停止ClickHouse
systemctl stop clickhouse-server

# 备份数据目录
tar -czf $BACKUP_DIR/${BACKUP_NAME}_data.tar.gz -C /var/lib/clickhouse .

# 备份配置文件
tar -czf $BACKUP_DIR/${BACKUP_NAME}_config.tar.gz -C /etc clickhouse-server

# 启动ClickHouse
systemctl start clickhouse-server

echo "备份完成: $BACKUP_DIR/${BACKUP_NAME}_*.tar.gz"
EOF

chmod +x /opt/clickhouse/backup.sh
```

### 7.2 自动备份

```bash
# 添加到crontab
echo "0 2 * * * /opt/clickhouse/backup.sh" | sudo crontab -
```

---

## 8. 验证测试

### 8.1 健康检查

```bash
# 检查服务状态
systemctl is-active clickhouse-server

# 检查端口监听
netstat -tlnp | grep -E "(8123|9000)"

# 测试HTTP接口
curl -s http://localhost:8123/ping

# 测试客户端连接
clickhouse-client --query "SELECT 1"

# 检查配置文件结构
ls -la /etc/clickhouse-server/config.d/
ls -la /etc/clickhouse-server/users.d/

# 验证默认用户配置
clickhouse-client --password=clickhouse123 --query "SELECT currentUser(), version()"

# 使用健康检查脚本
./scripts/health-check.sh

# 使用健康检查脚本
./scripts/health-check.sh
```

### 8.2 性能测试

```sql
-- 创建测试表
CREATE TABLE test.performance_test (
    id UInt32,
    value Float64,
    timestamp DateTime
) ENGINE = MergeTree()
ORDER BY (timestamp, id);

-- 插入测试数据
INSERT INTO test.performance_test
SELECT 
    number as id,
    rand() as value,
    now() + number as timestamp
FROM numbers(1000000);

-- 性能查询测试
SELECT 
    count(),
    avg(value),
    min(timestamp),
    max(timestamp)
FROM test.performance_test
WHERE timestamp >= now() - INTERVAL 1 DAY;
```

### 8.3 用户测试

```bash
# 测试所有用户配置
./scripts/test-users.sh

# 手动测试用户连接
clickhouse-client --user=admin --password=Admin_2024_Secure! --query "SELECT 1"
clickhouse-client --user=webuser --password=WebUser_2024_Secure! --query "SELECT 1"
clickhouse-client --user=default --password=clickhouse123 --query "SELECT 1"
```

### 8.3 用户测试

```bash
# 测试所有用户配置
./scripts/test-users.sh

# 手动测试用户连接
clickhouse-client --user=admin --password=Admin_2024_Secure! --query "SELECT 1"
clickhouse-client --user=webuser --password=WebUser_2024_Secure! --query "SELECT 1"
clickhouse-client --user=default --password=clickhouse123 --query "SELECT 1"
```

---

## 9. 故障排查

### 9.1 常见问题

#### 服务启动失败

```bash
# 检查配置文件
clickhouse-server --config-file=/etc/clickhouse-server/config.xml --test-config

# 检查配置文件结构
ls -la /etc/clickhouse-server/config.d/
ls -la /etc/clickhouse-server/users.d/

# 查看详细日志
journalctl -u clickhouse-server -n 50
```

#### 内存不足

```bash
# 检查内存使用
free -h
clickhouse-client --query "SELECT * FROM system.metrics WHERE metric LIKE '%memory%'"
```

#### 磁盘空间不足

```bash
# 检查磁盘使用
df -h
du -sh /var/lib/clickhouse/
```

### 9.2 日志分析

```bash
# 查看ClickHouse日志
tail -f /var/log/clickhouse-server/clickhouse-server.log

# 查看错误日志
tail -f /var/log/clickhouse-server/clickhouse-server.err.log

# 查看系统日志
journalctl -u clickhouse-server -f
```

### 9.3 性能诊断

```sql
-- 查看系统指标
SELECT metric, value 
FROM system.metrics 
ORDER BY value DESC;

-- 查看慢查询
SELECT query, query_duration_ms, memory_usage
FROM system.query_log 
WHERE query_duration_ms > 1000
ORDER BY query_duration_ms DESC
LIMIT 10;

-- 查看连接数
SELECT count() FROM system.processes;
```

---

## 总结

本手册提供了在 RHEL 兼容发行版和 Ubuntu LTS / Debian 系统上部署ClickHouse的完整指南。通过自动化脚本可以快速部署，通过手动步骤可以深入了解部署过程。

**主要特点：**

1. **自动化部署**: 提供完整的一键部署脚本，包含平台测试、系统准备、安装配置、健康检查等全流程
2. **模块化配置**: 使用config.d和users.d目录进行配置管理，便于维护和扩展
3. **默认用户优化**: 重新定义默认用户配置，确保安全性和一致性
4. **性能优化**: 针对4核CPU、16GB内存、150GB NVMe SSD进行了全面优化
5. **错误处理**: 新增错误处理配置，提高系统稳定性
6. **安全配置**: 合理的用户权限和网络访问控制
7. **监控工具**: 提供健康检查和监控脚本，支持告警配置
8. **备份策略**: 支持完整备份、增量备份和配置备份

**部署后访问信息:**
- HTTP接口: http://localhost:8123
- Native接口: localhost:9000
- 默认用户: default
- 默认密码: clickhouse123
- 管理员用户: admin
- 管理员密码: Admin_2024_Secure!
- Web用户: webuser
- Web用户密码: WebUser_2024_Secure!

**部署后访问信息:**
- HTTP接口: http://localhost:8123
- Native接口: localhost:9000
- 默认用户: default
- 默认密码: clickhouse123
- 管理员用户: admin
- 管理员密码: Admin_2024_Secure!
- Web用户: webuser
- Web用户密码: WebUser_2024_Secure!

建议在实际部署时，根据具体的硬件配置和业务需求对相关参数进行微调，以达到最佳的性能表现。
