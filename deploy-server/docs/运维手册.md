# ClickHouse Server è¿ç»´æ‰‹å†Œ

## æ¦‚è¿°

æœ¬è¿ç»´æ‰‹å†Œæä¾›ClickHouseä¼ ç»ŸæœåŠ¡å™¨éƒ¨ç½²çš„å®Œæ•´è¿ç»´æŒ‡å—ï¼ŒåŒ…æ‹¬æ—¥å¸¸è¿ç»´æ“ä½œã€ç›‘æ§ç®¡ç†ã€æ•…éšœæ’æŸ¥ã€æ€§èƒ½ä¼˜åŒ–ç­‰å†…å®¹ã€‚é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒçš„è¿ç»´äººå‘˜ä½¿ç”¨ã€‚

## ğŸ“‹ è¿ç»´ç›®å½•

1. [ç³»ç»Ÿç›‘æ§](#ç³»ç»Ÿç›‘æ§)
2. [æœåŠ¡ç®¡ç†](#æœåŠ¡ç®¡ç†)
3. [æ•°æ®ç®¡ç†](#æ•°æ®ç®¡ç†)
4. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
5. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
6. [å®‰å…¨ç»´æŠ¤](#å®‰å…¨ç»´æŠ¤)
7. [å¤‡ä»½æ¢å¤](#å¤‡ä»½æ¢å¤)
8. [å‡çº§ç»´æŠ¤](#å‡çº§ç»´æŠ¤)

## 1. ç³»ç»Ÿç›‘æ§

### 1.1 ç³»ç»Ÿèµ„æºç›‘æ§

#### 1.1.1 å†…å­˜ç›‘æ§

```bash
# æ£€æŸ¥ç³»ç»Ÿå†…å­˜ä½¿ç”¨
free -h

# æ£€æŸ¥ClickHouseå†…å­˜ä½¿ç”¨
clickhouse-client --query "
SELECT 
    metric,
    value,
    description
FROM system.metrics 
WHERE metric LIKE '%memory%'
ORDER BY value DESC;
"

# æ£€æŸ¥å†…å­˜ä½¿ç”¨è¯¦æƒ…
clickhouse-client --query "
SELECT 
    name,
    value,
    type
FROM system.memory_usage
ORDER BY value DESC;
"
```

#### 1.1.2 CPUç›‘æ§

```bash
# æ£€æŸ¥ç³»ç»ŸCPUä½¿ç”¨
top -p $(pgrep clickhouse-server)

# æ£€æŸ¥ClickHouse CPUä½¿ç”¨
clickhouse-client --query "
SELECT 
    metric,
    value
FROM system.metrics 
WHERE metric LIKE '%cpu%' OR metric LIKE '%thread%'
ORDER BY value DESC;
"
```

#### 1.1.3 ç£ç›˜ç›‘æ§

```bash
# æ£€æŸ¥ç£ç›˜ä½¿ç”¨
df -h

# æ£€æŸ¥ClickHouseæ•°æ®ç›®å½•å¤§å°
du -sh /var/lib/clickhouse/

# æ£€æŸ¥è¡¨å¤§å°
clickhouse-client --query "
SELECT 
    database,
    table,
    formatReadableSize(total_bytes) as size,
    total_rows
FROM system.tables
WHERE database NOT IN ('system', 'information_schema')
ORDER BY total_bytes DESC;
"
```

### 1.2 ClickHouseæœåŠ¡ç›‘æ§

#### 1.2.1 æœåŠ¡çŠ¶æ€æ£€æŸ¥

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status clickhouse-server

# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep clickhouse

# æ£€æŸ¥è¿›ç¨‹
ps aux | grep clickhouse
```

#### 1.2.2 è¿æ¥ç›‘æ§

```bash
# æ£€æŸ¥å½“å‰è¿æ¥æ•°
clickhouse-client --query "
SELECT 
    count() as connections,
    user,
    client_hostname,
    client_name
FROM system.processes 
GROUP BY user, client_hostname, client_name
ORDER BY connections DESC;
"

# æ£€æŸ¥è¿æ¥è¯¦æƒ…
clickhouse-client --query "
SELECT 
    user,
    client_hostname,
    client_name,
    query,
    query_start_time,
    query_duration_ms
FROM system.processes
ORDER BY query_duration_ms DESC;
"
```

#### 1.2.3 æŸ¥è¯¢ç›‘æ§

```bash
# æ£€æŸ¥æ…¢æŸ¥è¯¢
clickhouse-client --query "
SELECT 
    query,
    query_duration_ms,
    memory_usage,
    read_rows,
    read_bytes,
    written_rows,
    written_bytes,
    user,
    client_hostname
FROM system.query_log 
WHERE query_duration_ms > 1000
ORDER BY query_duration_ms DESC
LIMIT 10;
"

# æ£€æŸ¥æŸ¥è¯¢ç»Ÿè®¡
clickhouse-client --query "
SELECT 
    user,
    count() as query_count,
    avg(query_duration_ms) as avg_duration,
    max(query_duration_ms) as max_duration,
    sum(read_bytes) as total_read,
    sum(written_bytes) as total_written
FROM system.query_log 
WHERE event_date >= today() - 1
GROUP BY user
ORDER BY query_count DESC;
"
```

### 1.3 æ—¥å¿—ç›‘æ§

#### 1.3.1 é”™è¯¯æ—¥å¿—æ£€æŸ¥

```bash
# æ£€æŸ¥é”™è¯¯æ—¥å¿—
tail -f /var/log/clickhouse-server/clickhouse-server.err.log

# æ£€æŸ¥ç³»ç»Ÿé”™è¯¯
clickhouse-client --query "
SELECT 
    event_time,
    level,
    message
FROM system.text_log 
WHERE level >= 'Error'
ORDER BY event_time DESC
LIMIT 20;
"
```

#### 1.3.2 æŸ¥è¯¢æ—¥å¿—åˆ†æ

```bash
# åˆ†ææŸ¥è¯¢æ¨¡å¼
clickhouse-client --query "
SELECT 
    query,
    count() as execution_count,
    avg(query_duration_ms) as avg_duration,
    max(query_duration_ms) as max_duration,
    sum(read_bytes) as total_read,
    sum(written_bytes) as total_written
FROM system.query_log 
WHERE event_date >= today() - 7
GROUP BY query
HAVING execution_count > 10
ORDER BY avg_duration DESC
LIMIT 20;
"
```

## 2. æœåŠ¡ç®¡ç†

### 2.1 æœåŠ¡å¯åœ

#### 2.1.1 å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨ClickHouseæœåŠ¡
sudo systemctl start clickhouse-server

# æ£€æŸ¥å¯åŠ¨çŠ¶æ€
sudo systemctl status clickhouse-server

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable clickhouse-server
```

#### 2.1.2 åœæ­¢æœåŠ¡

```bash
# ä¼˜é›…åœæ­¢æœåŠ¡
sudo systemctl stop clickhouse-server

# å¼ºåˆ¶åœæ­¢æœåŠ¡ï¼ˆä¸æ¨èï¼‰
sudo systemctl kill clickhouse-server

# æ£€æŸ¥åœæ­¢çŠ¶æ€
sudo systemctl status clickhouse-server
```

#### 2.1.3 é‡å¯æœåŠ¡

```bash
# é‡å¯æœåŠ¡
sudo systemctl restart clickhouse-server

# æ£€æŸ¥é‡å¯åçŠ¶æ€
sudo systemctl status clickhouse-server
```

### 2.2 é…ç½®ç®¡ç†

#### 2.2.1 é…ç½®æ–‡ä»¶æ£€æŸ¥

```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
clickhouse-server --config-file=/etc/clickhouse-server/config.yml --test-config

# æ£€æŸ¥é…ç½®æ–‡ä»¶è·¯å¾„
ls -la /etc/clickhouse-server/

# å¤‡ä»½é…ç½®æ–‡ä»¶
sudo cp /etc/clickhouse-server/config.yml /etc/clickhouse-server/config.yml.backup.$(date +%Y%m%d)
```

#### 2.2.2 é…ç½®é‡è½½

```bash
# é‡è½½é…ç½®ï¼ˆéƒ¨åˆ†é…ç½®ï¼‰
clickhouse-client --query "SYSTEM RELOAD CONFIG"

# é‡è½½ç”¨æˆ·é…ç½®
clickhouse-client --query "SYSTEM RELOAD USERS"

# é‡è½½å­—å…¸
clickhouse-client --query "SYSTEM RELOAD DICTIONARIES"
```

### 2.3 æœåŠ¡å¥åº·æ£€æŸ¥

#### 2.3.1 åŸºç¡€å¥åº·æ£€æŸ¥

```bash
#!/bin/bash
# /opt/clickhouse/scripts/health-check.sh

echo "=== ClickHouse å¥åº·æ£€æŸ¥ ==="

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
if systemctl is-active --quiet clickhouse-server; then
    echo "âœ“ æœåŠ¡è¿è¡Œæ­£å¸¸"
else
    echo "âœ— æœåŠ¡æœªè¿è¡Œ"
    exit 1
fi

# æ£€æŸ¥ç«¯å£ç›‘å¬
if netstat -tlnp | grep -q ":8123 "; then
    echo "âœ“ HTTPç«¯å£ç›‘å¬æ­£å¸¸"
else
    echo "âœ— HTTPç«¯å£æœªç›‘å¬"
fi

if netstat -tlnp | grep -q ":9000 "; then
    echo "âœ“ Nativeç«¯å£ç›‘å¬æ­£å¸¸"
else
    echo "âœ— Nativeç«¯å£æœªç›‘å¬"
fi

# æ£€æŸ¥è¿æ¥
if clickhouse-client --query "SELECT 1" > /dev/null 2>&1; then
    echo "âœ“ æ•°æ®åº“è¿æ¥æ­£å¸¸"
else
    echo "âœ— æ•°æ®åº“è¿æ¥å¤±è´¥"
    exit 1
fi

# æ£€æŸ¥ç³»ç»Ÿè¡¨
if clickhouse-client --query "SELECT count() FROM system.tables" > /dev/null 2>&1; then
    echo "âœ“ ç³»ç»Ÿè¡¨è®¿é—®æ­£å¸¸"
else
    echo "âœ— ç³»ç»Ÿè¡¨è®¿é—®å¤±è´¥"
fi

echo "=== å¥åº·æ£€æŸ¥å®Œæˆ ==="
```

#### 2.3.2 æ€§èƒ½å¥åº·æ£€æŸ¥

```bash
#!/bin/bash
# /opt/clickhouse/scripts/performance-check.sh

echo "=== ClickHouse æ€§èƒ½æ£€æŸ¥ ==="

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
MEMORY_USAGE=$(clickhouse-client --query "
SELECT value 
FROM system.metrics 
WHERE metric = 'MemoryUsage'
")

echo "å†…å­˜ä½¿ç”¨: $MEMORY_USAGE bytes"

# æ£€æŸ¥æŸ¥è¯¢æ€§èƒ½
QUERY_TIME=$(clickhouse-client --query "
SELECT query_duration_ms
FROM system.query_log 
WHERE query LIKE 'SELECT 1'
ORDER BY event_time DESC 
LIMIT 1
")

echo "åŸºç¡€æŸ¥è¯¢å“åº”æ—¶é—´: ${QUERY_TIME}ms"

# æ£€æŸ¥å¹¶å‘è¿æ¥
CONNECTIONS=$(clickhouse-client --query "
SELECT count() 
FROM system.processes
")

echo "å½“å‰è¿æ¥æ•°: $CONNECTIONS"

# æ£€æŸ¥ç£ç›˜ä½¿ç”¨
DISK_USAGE=$(du -sh /var/lib/clickhouse/ | awk '{print $1}')

echo "æ•°æ®ç›®å½•å¤§å°: $DISK_USAGE"

echo "=== æ€§èƒ½æ£€æŸ¥å®Œæˆ ==="
```

## 3. æ•°æ®ç®¡ç†

### 3.1 æ•°æ®åº“ç®¡ç†

#### 3.1.1 æ•°æ®åº“æ“ä½œ

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE IF NOT EXISTS app_db;

-- æŸ¥çœ‹æ‰€æœ‰æ•°æ®åº“
SHOW DATABASES;

-- åˆ é™¤æ•°æ®åº“ï¼ˆè°¨æ…æ“ä½œï¼‰
DROP DATABASE IF EXISTS app_db;
```

#### 3.1.2 è¡¨ç®¡ç†

```sql
-- æŸ¥çœ‹è¡¨ç»“æ„
DESCRIBE TABLE app_db.table_name;

-- æŸ¥çœ‹è¡¨å¤§å°
SELECT 
    table,
    formatReadableSize(total_bytes) as size,
    total_rows,
    partition_count
FROM system.tables
WHERE database = 'app_db';

-- æŸ¥çœ‹è¡¨åˆ†åŒº
SELECT 
    partition,
    name,
    formatReadableSize(bytes_on_disk) as size,
    rows
FROM system.parts
WHERE database = 'app_db' AND table = 'table_name'
ORDER BY partition DESC;
```

### 3.2 æ•°æ®ç»´æŠ¤

#### 3.2.1 æ•°æ®æ¸…ç†

```sql
-- æ¸…ç†è¿‡æœŸæ•°æ®
ALTER TABLE app_db.table_name DELETE WHERE event_date < today() - 30;

-- æ¸…ç†é‡å¤æ•°æ®
ALTER TABLE app_db.table_name DELETE WHERE id IN (
    SELECT id FROM (
        SELECT id, ROW_NUMBER() OVER (PARTITION BY id ORDER BY event_time DESC) as rn
        FROM app_db.table_name
    ) t WHERE rn > 1
);
```

#### 3.2.2 è¡¨ä¼˜åŒ–

```sql
-- å¼ºåˆ¶åˆå¹¶åˆ†åŒº
OPTIMIZE TABLE app_db.table_name FINAL;

-- æ¸…ç†æœªä½¿ç”¨çš„æ•°æ®
OPTIMIZE TABLE app_db.table_name DEDUPLICATE;

-- é‡å»ºç´¢å¼•
ALTER TABLE app_db.table_name MATERIALIZE INDEX index_name;
```

### 3.3 æ•°æ®å¯¼å…¥å¯¼å‡º

#### 3.3.1 æ•°æ®å¯¼å…¥

```bash
# ä»CSVæ–‡ä»¶å¯¼å…¥
clickhouse-client --query "
INSERT INTO app_db.table_name 
SELECT * FROM file('data.csv', 'CSV', 'column1 String, column2 UInt32')
"

# ä»JSONæ–‡ä»¶å¯¼å…¥
clickhouse-client --query "
INSERT INTO app_db.table_name 
SELECT * FROM file('data.json', 'JSONEachRow')
"
```

#### 3.3.2 æ•°æ®å¯¼å‡º

```bash
# å¯¼å‡ºä¸ºCSV
clickhouse-client --query "
SELECT * FROM app_db.table_name 
WHERE event_date >= today() - 7
" --format CSV > export.csv

# å¯¼å‡ºä¸ºJSON
clickhouse-client --query "
SELECT * FROM app_db.table_name 
WHERE event_date >= today() - 7
" --format JSONEachRow > export.json
```

## 4. æ€§èƒ½ä¼˜åŒ–

### 4.1 æŸ¥è¯¢ä¼˜åŒ–

#### 4.1.1 æ…¢æŸ¥è¯¢åˆ†æ

```sql
-- åˆ†ææ…¢æŸ¥è¯¢
SELECT 
    query,
    query_duration_ms,
    memory_usage,
    read_rows,
    read_bytes,
    written_rows,
    written_bytes,
    user,
    client_hostname,
    event_time
FROM system.query_log 
WHERE query_duration_ms > 5000
ORDER BY query_duration_ms DESC
LIMIT 20;
```

#### 4.1.2 æŸ¥è¯¢ä¼˜åŒ–å»ºè®®

```sql
-- æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT 
    table,
    index_name,
    type,
    expr
FROM system.data_skipping_indices
WHERE database = 'app_db';

-- æ£€æŸ¥åˆ†åŒºè£å‰ª
EXPLAIN indexes = 1
SELECT * FROM app_db.table_name 
WHERE event_date >= today() - 7;
```

### 4.2 ç³»ç»Ÿä¼˜åŒ–

#### 4.2.1 å†…å­˜ä¼˜åŒ–

```sql
-- æ£€æŸ¥å†…å­˜ä½¿ç”¨è¯¦æƒ…
SELECT 
    name,
    value,
    type
FROM system.memory_usage
ORDER BY value DESC;

-- è°ƒæ•´å†…å­˜è®¾ç½®
SET max_memory_usage = 10737418240; -- 10GB
SET max_memory_usage_for_user = 8589934592; -- 8GB
```

#### 4.2.2 å¹¶å‘ä¼˜åŒ–

```sql
-- æ£€æŸ¥å¹¶å‘è®¾ç½®
SELECT 
    name,
    value
FROM system.settings
WHERE name LIKE '%concurrent%' OR name LIKE '%thread%';

-- è°ƒæ•´å¹¶å‘è®¾ç½®
SET max_concurrent_queries = 10;
SET max_threads = 4;
```

### 4.3 å­˜å‚¨ä¼˜åŒ–

#### 4.3.1 å­˜å‚¨åˆ†æ

```sql
-- æ£€æŸ¥å­˜å‚¨ä½¿ç”¨
SELECT 
    database,
    table,
    formatReadableSize(total_bytes) as size,
    total_rows,
    partition_count
FROM system.tables
ORDER BY total_bytes DESC;

-- æ£€æŸ¥åˆ†åŒºå¤§å°
SELECT 
    database,
    table,
    partition,
    formatReadableSize(bytes_on_disk) as size,
    rows
FROM system.parts
ORDER BY bytes_on_disk DESC
LIMIT 20;
```

#### 4.3.2 å­˜å‚¨ä¼˜åŒ–

```sql
-- å¼ºåˆ¶åˆå¹¶å°åˆ†åŒº
OPTIMIZE TABLE app_db.table_name FINAL;

-- æ¸…ç†è¿‡æœŸåˆ†åŒº
ALTER TABLE app_db.table_name DROP PARTITION '2023-01-01';

-- å‹ç¼©æ•°æ®
ALTER TABLE app_db.table_name MODIFY SETTING min_bytes_for_wide_part = 0;
```

## 5. æ•…éšœæ’æŸ¥

### 5.1 å¸¸è§é—®é¢˜æ’æŸ¥

#### 5.1.1 æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶
clickhouse-server --config-file=/etc/clickhouse-server/config.yml --test-config

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep -E ":(8123|9000)"

# æ£€æŸ¥æƒé™
ls -la /var/lib/clickhouse/
ls -la /var/log/clickhouse-server/

# æ£€æŸ¥æ—¥å¿—
tail -f /var/log/clickhouse-server/clickhouse-server.log
```

#### 5.1.2 å†…å­˜ä¸è¶³

```bash
# æ£€æŸ¥å†…å­˜ä½¿ç”¨
free -h
clickhouse-client --query "SELECT * FROM system.metrics WHERE metric LIKE '%memory%'"

# æ£€æŸ¥å†…å­˜è®¾ç½®
clickhouse-client --query "
SELECT name, value 
FROM system.settings 
WHERE name LIKE '%memory%'
ORDER BY name;
"
```

#### 5.1.3 ç£ç›˜ç©ºé—´ä¸è¶³

```bash
# æ£€æŸ¥ç£ç›˜ä½¿ç”¨
df -h
du -sh /var/lib/clickhouse/

# æ£€æŸ¥å¤§è¡¨
clickhouse-client --query "
SELECT 
    database,
    table,
    formatReadableSize(total_bytes) as size
FROM system.tables
ORDER BY total_bytes DESC
LIMIT 10;
"
```

### 5.2 æ€§èƒ½é—®é¢˜æ’æŸ¥

#### 5.2.1 æ…¢æŸ¥è¯¢åˆ†æ

```sql
-- åˆ†ææ…¢æŸ¥è¯¢æ¨¡å¼
SELECT 
    query,
    count() as execution_count,
    avg(query_duration_ms) as avg_duration,
    max(query_duration_ms) as max_duration,
    sum(read_bytes) as total_read
FROM system.query_log 
WHERE query_duration_ms > 1000
GROUP BY query
ORDER BY avg_duration DESC
LIMIT 10;
```

#### 5.2.2 èµ„æºç“¶é¢ˆåˆ†æ

```sql
-- æ£€æŸ¥CPUä½¿ç”¨
SELECT 
    metric,
    value
FROM system.metrics 
WHERE metric LIKE '%cpu%' OR metric LIKE '%thread%'
ORDER BY value DESC;

-- æ£€æŸ¥å†…å­˜ä½¿ç”¨
SELECT 
    name,
    value,
    type
FROM system.memory_usage
ORDER BY value DESC;
```

### 5.3 è¿æ¥é—®é¢˜æ’æŸ¥

#### 5.3.1 è¿æ¥æ•°è¿‡å¤š

```sql
-- æ£€æŸ¥è¿æ¥è¯¦æƒ…
SELECT 
    user,
    client_hostname,
    client_name,
    query,
    query_duration_ms
FROM system.processes
ORDER BY query_duration_ms DESC;

-- æ£€æŸ¥è¿æ¥é™åˆ¶
SELECT 
    name,
    value
FROM system.settings
WHERE name LIKE '%connection%' OR name LIKE '%max_connections%';
```

#### 5.3.2 ç½‘ç»œé—®é¢˜

```bash
# æ£€æŸ¥ç½‘ç»œè¿æ¥
telnet localhost 8123
telnet localhost 9000

# æ£€æŸ¥é˜²ç«å¢™
iptables -L | grep -E "(8123|9000)"

# æ£€æŸ¥ç½‘ç»œé…ç½®
netstat -tlnp | grep clickhouse
```

## 6. å®‰å…¨ç»´æŠ¤

### 6.1 ç”¨æˆ·ç®¡ç†

#### 6.1.1 ç”¨æˆ·æ“ä½œ

```sql
-- åˆ›å»ºç”¨æˆ·
CREATE USER IF NOT EXISTS app_user IDENTIFIED BY 'StrongPassword123!';

-- æŸ¥çœ‹ç”¨æˆ·
SELECT name, id, storage FROM system.users;

-- åˆ é™¤ç”¨æˆ·
DROP USER IF EXISTS app_user;
```

#### 6.1.2 æƒé™ç®¡ç†

```sql
-- æˆäºˆæƒé™
GRANT SELECT, INSERT ON app_db.* TO app_user;

-- æŸ¥çœ‹æƒé™
SHOW GRANTS FOR app_user;

-- æ’¤é”€æƒé™
REVOKE INSERT ON app_db.* FROM app_user;
```

### 6.2 ç½‘ç»œå®‰å…¨

#### 6.2.1 é˜²ç«å¢™é…ç½®

```bash
# å¼€æ”¾ClickHouseç«¯å£
sudo firewall-cmd --permanent --add-port=8123/tcp
sudo firewall-cmd --permanent --add-port=9000/tcp
sudo firewall-cmd --reload

# æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
sudo firewall-cmd --list-ports
```

#### 6.2.2 SSLé…ç½®

```bash
# ç”ŸæˆSSLè¯ä¹¦
sudo openssl req -x509 -newkey rsa:4096 -keyout /etc/clickhouse-server/server.key -out /etc/clickhouse-server/server.crt -days 365 -nodes

# è®¾ç½®è¯ä¹¦æƒé™
sudo chown clickhouse:clickhouse /etc/clickhouse-server/server.key /etc/clickhouse-server/server.crt
sudo chmod 600 /etc/clickhouse-server/server.key
sudo chmod 644 /etc/clickhouse-server/server.crt
```

### 6.3 å®¡è®¡æ—¥å¿—

#### 6.3.1 å®¡è®¡é…ç½®

```yaml
# /etc/clickhouse-server/config.yml
clickhouse:
  query_log:
    database: system
    table: query_log
    partition_by: toYYYYMM(event_date)
    flush_interval_milliseconds: 7500
    log_query_settings: 0
    log_query_threads: 0
```

#### 6.3.2 å®¡è®¡åˆ†æ

```sql
-- åˆ†æç”¨æˆ·æ´»åŠ¨
SELECT 
    user,
    count() as query_count,
    count(DISTINCT client_hostname) as unique_hosts,
    avg(query_duration_ms) as avg_duration
FROM system.query_log 
WHERE event_date >= today() - 7
GROUP BY user
ORDER BY query_count DESC;

-- æ£€æŸ¥å¼‚å¸¸è®¿é—®
SELECT 
    user,
    client_hostname,
    count() as access_count,
    max(event_time) as last_access
FROM system.query_log 
WHERE event_date >= today() - 1
GROUP BY user, client_hostname
HAVING access_count > 1000
ORDER BY access_count DESC;
```

## 7. å¤‡ä»½æ¢å¤

### 7.1 å¤‡ä»½ç­–ç•¥

#### 7.1.1 è‡ªåŠ¨å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# /opt/clickhouse/scripts/backup.sh

BACKUP_DIR="/opt/clickhouse/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="clickhouse_backup_$DATE"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# åœæ­¢æœåŠ¡ï¼ˆå¯é€‰ï¼Œç”¨äºä¸€è‡´æ€§å¤‡ä»½ï¼‰
# sudo systemctl stop clickhouse-server

# å¤‡ä»½æ•°æ®ç›®å½•
sudo tar -czf "$BACKUP_DIR/${BACKUP_NAME}.tar.gz" \
    -C /var/lib/clickhouse/ . \
    --exclude='tmp' \
    --exclude='user_files'

# å¤‡ä»½é…ç½®æ–‡ä»¶
sudo tar -czf "$BACKUP_DIR/config_${BACKUP_NAME}.tar.gz" \
    -C /etc/clickhouse-server/ .

# å¯åŠ¨æœåŠ¡ï¼ˆå¦‚æœä¹‹å‰åœæ­¢äº†ï¼‰
# sudo systemctl start clickhouse-server

# æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™7å¤©ï¼‰
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "å¤‡ä»½å®Œæˆ: $BACKUP_NAME"
```

#### 7.1.2 å¢é‡å¤‡ä»½

```bash
#!/bin/bash
# /opt/clickhouse/scripts/incremental-backup.sh

BACKUP_DIR="/opt/clickhouse/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="incremental_backup_$DATE"

# åˆ›å»ºå¢é‡å¤‡ä»½
clickhouse-client --query "
BACKUP TABLE app_db.table_name 
TO '$BACKUP_DIR/$BACKUP_NAME'
"

# å‹ç¼©å¤‡ä»½
tar -czf "$BACKUP_DIR/${BACKUP_NAME}.tar.gz" -C "$BACKUP_DIR" "$BACKUP_NAME"

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -rf "$BACKUP_DIR/$BACKUP_NAME"

echo "å¢é‡å¤‡ä»½å®Œæˆ: $BACKUP_NAME"
```

### 7.2 æ¢å¤ç­–ç•¥

#### 7.2.1 å®Œæ•´æ¢å¤

```bash
#!/bin/bash
# /opt/clickhouse/scripts/restore.sh

BACKUP_FILE="$1"
RESTORE_DIR="/tmp/clickhouse_restore"

if [ -z "$BACKUP_FILE" ]; then
    echo "è¯·æŒ‡å®šå¤‡ä»½æ–‡ä»¶è·¯å¾„"
    exit 1
fi

# åœæ­¢æœåŠ¡
sudo systemctl stop clickhouse-server

# æ¸…ç†æ•°æ®ç›®å½•
sudo rm -rf /var/lib/clickhouse/*

# è§£å‹å¤‡ä»½
mkdir -p $RESTORE_DIR
tar -xzf "$BACKUP_FILE" -C $RESTORE_DIR

# æ¢å¤æ•°æ®
sudo cp -r $RESTORE_DIR/* /var/lib/clickhouse/

# è®¾ç½®æƒé™
sudo chown -R clickhouse:clickhouse /var/lib/clickhouse/

# å¯åŠ¨æœåŠ¡
sudo systemctl start clickhouse-server

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -rf $RESTORE_DIR

echo "æ¢å¤å®Œæˆ"
```

#### 7.2.2 è¡¨çº§æ¢å¤

```sql
-- æ¢å¤ç‰¹å®šè¡¨
RESTORE TABLE app_db.table_name 
FROM '/opt/clickhouse/backups/table_backup';

-- æ£€æŸ¥æ¢å¤ç»“æœ
SELECT 
    table,
    formatReadableSize(total_bytes) as size,
    total_rows
FROM system.tables
WHERE database = 'app_db' AND table = 'table_name';
```

### 7.3 å¤‡ä»½éªŒè¯

#### 7.3.1 å¤‡ä»½å®Œæ•´æ€§æ£€æŸ¥

```bash
#!/bin/bash
# /opt/clickhouse/scripts/verify-backup.sh

BACKUP_FILE="$1"

if [ -z "$BACKUP_FILE" ]; then
    echo "è¯·æŒ‡å®šå¤‡ä»½æ–‡ä»¶è·¯å¾„"
    exit 1
fi

# æ£€æŸ¥å¤‡ä»½æ–‡ä»¶
if [ ! -f "$BACKUP_FILE" ]; then
    echo "å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨: $BACKUP_FILE"
    exit 1
fi

# æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§
tar -tzf "$BACKUP_FILE" > /dev/null
if [ $? -eq 0 ]; then
    echo "âœ“ å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡"
else
    echo "âœ— å¤‡ä»½æ–‡ä»¶æŸå"
    exit 1
fi

# æ£€æŸ¥æ–‡ä»¶å¤§å°
BACKUP_SIZE=$(stat -c%s "$BACKUP_FILE")
echo "å¤‡ä»½æ–‡ä»¶å¤§å°: $(numfmt --to=iec $BACKUP_SIZE)"

echo "å¤‡ä»½éªŒè¯å®Œæˆ"
```

## 8. å‡çº§ç»´æŠ¤

### 8.1 ç‰ˆæœ¬å‡çº§

#### 8.1.1 å‡çº§å‡†å¤‡

```bash
# æ£€æŸ¥å½“å‰ç‰ˆæœ¬
clickhouse-server --version

# å¤‡ä»½é‡è¦æ•°æ®
sudo /opt/clickhouse/scripts/backup.sh

# æ£€æŸ¥ç³»ç»Ÿå…¼å®¹æ€§
sudo yum check-update clickhouse-server
```

#### 8.1.2 æ‰§è¡Œå‡çº§

```bash
# åœæ­¢æœåŠ¡
sudo systemctl stop clickhouse-server

# å‡çº§ClickHouse
sudo yum update clickhouse-server clickhouse-client

# å¯åŠ¨æœåŠ¡
sudo systemctl start clickhouse-server

# æ£€æŸ¥å‡çº§ç»“æœ
clickhouse-server --version
sudo systemctl status clickhouse-server
```

### 8.2 é…ç½®æ›´æ–°

#### 8.2.1 é…ç½®å¤‡ä»½

```bash
# å¤‡ä»½å½“å‰é…ç½®
sudo cp /etc/clickhouse-server/config.yml /etc/clickhouse-server/config.yml.backup.$(date +%Y%m%d)
sudo cp /etc/clickhouse-server/users.yml /etc/clickhouse-server/users.yml.backup.$(date +%Y%m%d)
```

#### 8.2.2 é…ç½®æ›´æ–°

```bash
# æ›´æ–°é…ç½®æ–‡ä»¶
sudo cp /opt/clickhouse/config/config.yml /etc/clickhouse-server/
sudo cp /opt/clickhouse/config/users.yml /etc/clickhouse-server/

# é‡è½½é…ç½®
clickhouse-client --query "SYSTEM RELOAD CONFIG"
clickhouse-client --query "SYSTEM RELOAD USERS"
```

### 8.3 å›æ»šç­–ç•¥

#### 8.3.1 æœåŠ¡å›æ»š

```bash
# åœæ­¢æœåŠ¡
sudo systemctl stop clickhouse-server

# æ¢å¤é…ç½®æ–‡ä»¶
sudo cp /etc/clickhouse-server/config.yml.backup.* /etc/clickhouse-server/config.yml
sudo cp /etc/clickhouse-server/users.yml.backup.* /etc/clickhouse-server/users.yml

# å¯åŠ¨æœåŠ¡
sudo systemctl start clickhouse-server

# éªŒè¯å›æ»š
sudo systemctl status clickhouse-server
```

#### 8.3.2 æ•°æ®å›æ»š

```bash
# æ¢å¤æ•°æ®å¤‡ä»½
sudo /opt/clickhouse/scripts/restore.sh /opt/clickhouse/backups/latest_backup.tar.gz

# éªŒè¯æ•°æ®å®Œæ•´æ€§
clickhouse-client --query "
SELECT 
    database,
    table,
    total_rows
FROM system.tables
WHERE database NOT IN ('system', 'information_schema')
ORDER BY total_rows DESC;
"
```

## 9. ç›‘æ§å‘Šè­¦

### 9.1 ç›‘æ§æŒ‡æ ‡

#### 9.1.1 å…³é”®æŒ‡æ ‡

```sql
-- ç³»ç»Ÿå¥åº·æŒ‡æ ‡
SELECT 
    metric,
    value,
    description
FROM system.metrics 
WHERE metric IN (
    'MemoryUsage',
    'CPUUtilization',
    'DiskUsage',
    'Query',
    'QueryThread',
    'TCPConnection'
)
ORDER BY metric;
```

#### 9.1.2 æ€§èƒ½æŒ‡æ ‡

```sql
-- æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡
SELECT 
    avg(query_duration_ms) as avg_duration,
    max(query_duration_ms) as max_duration,
    count() as query_count,
    sum(read_bytes) as total_read,
    sum(written_bytes) as total_written
FROM system.query_log 
WHERE event_date >= today() - 1;
```

### 9.2 å‘Šè­¦é…ç½®

#### 9.2.1 å‘Šè­¦è„šæœ¬

```bash
#!/bin/bash
# /opt/clickhouse/scripts/alert.sh

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
MEMORY_USAGE=$(clickhouse-client --query "
SELECT value 
FROM system.metrics 
WHERE metric = 'MemoryUsage'
")

MEMORY_LIMIT=12884901888  # 12GB

if [ $MEMORY_USAGE -gt $MEMORY_LIMIT ]; then
    echo "å‘Šè­¦: ClickHouseå†…å­˜ä½¿ç”¨è¿‡é«˜ - ${MEMORY_USAGE} bytes"
    # å‘é€å‘Šè­¦é€šçŸ¥
fi

# æ£€æŸ¥è¿æ¥æ•°
CONNECTIONS=$(clickhouse-client --query "
SELECT count() 
FROM system.processes
")

CONNECTION_LIMIT=100

if [ $CONNECTIONS -gt $CONNECTION_LIMIT ]; then
    echo "å‘Šè­¦: ClickHouseè¿æ¥æ•°è¿‡å¤š - ${CONNECTIONS}"
    # å‘é€å‘Šè­¦é€šçŸ¥
fi

# æ£€æŸ¥æ…¢æŸ¥è¯¢
SLOW_QUERIES=$(clickhouse-client --query "
SELECT count() 
FROM system.query_log 
WHERE query_duration_ms > 5000 
AND event_date >= today()
")

if [ $SLOW_QUERIES -gt 10 ]; then
    echo "å‘Šè­¦: ClickHouseæ…¢æŸ¥è¯¢è¿‡å¤š - ${SLOW_QUERIES}"
    # å‘é€å‘Šè­¦é€šçŸ¥
fi
```

#### 9.2.2 å®šæ—¶ç›‘æ§

```bash
# æ·»åŠ åˆ°crontab
# æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡å¥åº·æ£€æŸ¥
*/5 * * * * /opt/clickhouse/scripts/health-check.sh >> /var/log/clickhouse/health.log 2>&1

# æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡æ€§èƒ½æ£€æŸ¥
0 * * * * /opt/clickhouse/scripts/performance-check.sh >> /var/log/clickhouse/performance.log 2>&1

# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå¤‡ä»½
0 2 * * * /opt/clickhouse/scripts/backup.sh >> /var/log/clickhouse/backup.log 2>&1
```

## 10. è¿ç»´å·¥å…·

### 10.1 å¸¸ç”¨è„šæœ¬

#### 10.1.1 å¿«é€Ÿè¯Šæ–­è„šæœ¬

```bash
#!/bin/bash
# /opt/clickhouse/scripts/diagnose.sh

echo "=== ClickHouse å¿«é€Ÿè¯Šæ–­ ==="

# ç³»ç»Ÿä¿¡æ¯
echo "ç³»ç»Ÿä¿¡æ¯:"
uname -a
echo ""

# ç¡¬ä»¶ä¿¡æ¯
echo "ç¡¬ä»¶ä¿¡æ¯:"
free -h
df -h
echo ""

# æœåŠ¡çŠ¶æ€
echo "æœåŠ¡çŠ¶æ€:"
systemctl status clickhouse-server --no-pager
echo ""

# ç«¯å£ç›‘å¬
echo "ç«¯å£ç›‘å¬:"
netstat -tlnp | grep clickhouse
echo ""

# è¿æ¥çŠ¶æ€
echo "è¿æ¥çŠ¶æ€:"
clickhouse-client --query "SELECT count() FROM system.processes"
echo ""

# å†…å­˜ä½¿ç”¨
echo "å†…å­˜ä½¿ç”¨:"
clickhouse-client --query "
SELECT 
    metric,
    value
FROM system.metrics 
WHERE metric LIKE '%memory%'
ORDER BY value DESC;
"
echo ""

echo "=== è¯Šæ–­å®Œæˆ ==="
```

#### 10.1.2 æ€§èƒ½åˆ†æè„šæœ¬

```bash
#!/bin/bash
# /opt/clickhouse/scripts/analyze.sh

echo "=== ClickHouse æ€§èƒ½åˆ†æ ==="

# æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡
echo "æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡:"
clickhouse-client --query "
SELECT 
    count() as total_queries,
    avg(query_duration_ms) as avg_duration,
    max(query_duration_ms) as max_duration,
    sum(read_bytes) as total_read,
    sum(written_bytes) as total_written
FROM system.query_log 
WHERE event_date >= today() - 1;
"
echo ""

# æ…¢æŸ¥è¯¢TOP10
echo "æ…¢æŸ¥è¯¢TOP10:"
clickhouse-client --query "
SELECT 
    query,
    query_duration_ms,
    memory_usage,
    read_rows
FROM system.query_log 
WHERE query_duration_ms > 1000
ORDER BY query_duration_ms DESC
LIMIT 10;
"
echo ""

# è¡¨å¤§å°ç»Ÿè®¡
echo "è¡¨å¤§å°ç»Ÿè®¡:"
clickhouse-client --query "
SELECT 
    database,
    table,
    formatReadableSize(total_bytes) as size,
    total_rows
FROM system.tables
ORDER BY total_bytes DESC
LIMIT 10;
"
echo ""

echo "=== åˆ†æå®Œæˆ ==="
```

### 10.2 ç›‘æ§é¢æ¿

#### 10.2.1 Grafanaé…ç½®

```yaml
# /etc/grafana/provisioning/dashboards/clickhouse.yml
apiVersion: 1

providers:
  - name: 'ClickHouse'
    orgId: 1
    folder: ''
    type: file
    disableDeletion: false
    updateIntervalSeconds: 10
    allowUiUpdates: true
    options:
      path: /var/lib/grafana/dashboards
```

#### 10.2.2 Prometheusé…ç½®

```yaml
# /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'clickhouse'
    static_configs:
      - targets: ['localhost:9116']
    scrape_interval: 15s
```

---

## æ€»ç»“

æœ¬è¿ç»´æ‰‹å†Œæä¾›äº†ClickHouseä¼ ç»ŸæœåŠ¡å™¨éƒ¨ç½²çš„å®Œæ•´è¿ç»´æŒ‡å—ï¼Œæ¶µç›–äº†ä»æ—¥å¸¸ç›‘æ§åˆ°æ•…éšœæ’æŸ¥çš„å„ä¸ªæ–¹é¢ã€‚é€šè¿‡åˆç†çš„è¿ç»´ç®¡ç†ï¼Œå¯ä»¥ç¡®ä¿ClickHouseç³»ç»Ÿçš„ç¨³å®šè¿è¡Œå’Œè‰¯å¥½æ€§èƒ½ã€‚

å»ºè®®è¿ç»´äººå‘˜æ ¹æ®å®é™…ç¯å¢ƒå’Œä¸šåŠ¡éœ€æ±‚ï¼Œåˆ¶å®šé€‚åˆçš„è¿ç»´æµç¨‹å’Œç›‘æ§ç­–ç•¥ï¼Œå¹¶å®šæœŸæ›´æ–°å’Œå®Œå–„è¿ç»´æ–‡æ¡£ã€‚ 