# ClickHouse Server 运维手册

## 概述

本运维手册提供ClickHouse传统服务器部署的完整运维指南，包括日常运维操作、监控管理、故障排查、性能优化等内容。适用于生产环境的运维人员使用。

## 📋 运维目录

1. [系统监控](#系统监控)
2. [服务管理](#服务管理)
3. [数据管理](#数据管理)
4. [性能优化](#性能优化)
5. [故障排查](#故障排查)
6. [安全维护](#安全维护)
7. [备份恢复](#备份恢复)
8. [升级维护](#升级维护)

## 1. 系统监控

### 1.1 系统资源监控

#### 1.1.1 内存监控

```bash
# 检查系统内存使用
free -h

# 检查ClickHouse内存使用
clickhouse-client --query "
SELECT 
    metric,
    value,
    description
FROM system.metrics 
WHERE metric LIKE '%memory%'
ORDER BY value DESC;
"

# 检查内存使用详情
clickhouse-client --query "
SELECT 
    name,
    value,
    type
FROM system.memory_usage
ORDER BY value DESC;
"
```

#### 1.1.2 CPU监控

```bash
# 检查系统CPU使用
top -p $(pgrep clickhouse-server)

# 检查ClickHouse CPU使用
clickhouse-client --query "
SELECT 
    metric,
    value
FROM system.metrics 
WHERE metric LIKE '%cpu%' OR metric LIKE '%thread%'
ORDER BY value DESC;
"
```

#### 1.1.3 磁盘监控

```bash
# 检查磁盘使用
df -h

# 检查ClickHouse数据目录大小
du -sh /var/lib/clickhouse/

# 检查表大小
clickhouse-client --query "
SELECT 
    database,
    table,
    formatReadableSize(total_bytes) as size,
    total_rows
FROM system.tables
WHERE database NOT IN ('system', 'information_schema')
ORDER BY total_bytes DESC;
"
```

### 1.2 ClickHouse服务监控

#### 1.2.1 服务状态检查

```bash
# 检查服务状态
systemctl status clickhouse-server

# 检查端口监听
netstat -tlnp | grep clickhouse

# 检查进程
ps aux | grep clickhouse
```

#### 1.2.2 连接监控

```bash
# 检查当前连接数
clickhouse-client --query "
SELECT 
    count() as connections,
    user,
    client_hostname,
    client_name
FROM system.processes 
GROUP BY user, client_hostname, client_name
ORDER BY connections DESC;
"

# 检查连接详情
clickhouse-client --query "
SELECT 
    user,
    client_hostname,
    client_name,
    query,
    query_start_time,
    query_duration_ms
FROM system.processes
ORDER BY query_duration_ms DESC;
"
```

#### 1.2.3 查询监控

```bash
# 检查慢查询
clickhouse-client --query "
SELECT 
    query,
    query_duration_ms,
    memory_usage,
    read_rows,
    read_bytes,
    written_rows,
    written_bytes,
    user,
    client_hostname
FROM system.query_log 
WHERE query_duration_ms > 1000
ORDER BY query_duration_ms DESC
LIMIT 10;
"

# 检查查询统计
clickhouse-client --query "
SELECT 
    user,
    count() as query_count,
    avg(query_duration_ms) as avg_duration,
    max(query_duration_ms) as max_duration,
    sum(read_bytes) as total_read,
    sum(written_bytes) as total_written
FROM system.query_log 
WHERE event_date >= today() - 1
GROUP BY user
ORDER BY query_count DESC;
"
```

### 1.3 日志监控

#### 1.3.1 错误日志检查

```bash
# 检查错误日志
tail -f /var/log/clickhouse-server/clickhouse-server.err.log

# 检查系统错误
clickhouse-client --query "
SELECT 
    event_time,
    level,
    message
FROM system.text_log 
WHERE level >= 'Error'
ORDER BY event_time DESC
LIMIT 20;
"
```

#### 1.3.2 查询日志分析

```bash
# 分析查询模式
clickhouse-client --query "
SELECT 
    query,
    count() as execution_count,
    avg(query_duration_ms) as avg_duration,
    max(query_duration_ms) as max_duration,
    sum(read_bytes) as total_read,
    sum(written_bytes) as total_written
FROM system.query_log 
WHERE event_date >= today() - 7
GROUP BY query
HAVING execution_count > 10
ORDER BY avg_duration DESC
LIMIT 20;
"
```

## 2. 服务管理

### 2.1 服务启停

#### 2.1.1 启动服务

```bash
# 启动ClickHouse服务
sudo systemctl start clickhouse-server

# 检查启动状态
sudo systemctl status clickhouse-server

# 设置开机自启
sudo systemctl enable clickhouse-server
```

#### 2.1.2 停止服务

```bash
# 优雅停止服务
sudo systemctl stop clickhouse-server

# 强制停止服务（不推荐）
sudo systemctl kill clickhouse-server

# 检查停止状态
sudo systemctl status clickhouse-server
```

#### 2.1.3 重启服务

```bash
# 重启服务
sudo systemctl restart clickhouse-server

# 检查重启后状态
sudo systemctl status clickhouse-server
```

### 2.2 配置管理

#### 2.2.1 配置文件检查

```bash
# 检查配置文件语法
clickhouse-server --config-file=/etc/clickhouse-server/config.yml --test-config

# 检查配置文件路径
ls -la /etc/clickhouse-server/

# 备份配置文件
sudo cp /etc/clickhouse-server/config.yml /etc/clickhouse-server/config.yml.backup.$(date +%Y%m%d)
```

#### 2.2.2 配置重载

```bash
# 重载配置（部分配置）
clickhouse-client --query "SYSTEM RELOAD CONFIG"

# 重载用户配置
clickhouse-client --query "SYSTEM RELOAD USERS"

# 重载字典
clickhouse-client --query "SYSTEM RELOAD DICTIONARIES"
```

### 2.3 服务健康检查

#### 2.3.1 基础健康检查

```bash
#!/bin/bash
# /opt/clickhouse/scripts/health-check.sh

echo "=== ClickHouse 健康检查 ==="

# 检查服务状态
if systemctl is-active --quiet clickhouse-server; then
    echo "✓ 服务运行正常"
else
    echo "✗ 服务未运行"
    exit 1
fi

# 检查端口监听
if netstat -tlnp | grep -q ":8123 "; then
    echo "✓ HTTP端口监听正常"
else
    echo "✗ HTTP端口未监听"
fi

if netstat -tlnp | grep -q ":9000 "; then
    echo "✓ Native端口监听正常"
else
    echo "✗ Native端口未监听"
fi

# 检查连接
if clickhouse-client --query "SELECT 1" > /dev/null 2>&1; then
    echo "✓ 数据库连接正常"
else
    echo "✗ 数据库连接失败"
    exit 1
fi

# 检查系统表
if clickhouse-client --query "SELECT count() FROM system.tables" > /dev/null 2>&1; then
    echo "✓ 系统表访问正常"
else
    echo "✗ 系统表访问失败"
fi

echo "=== 健康检查完成 ==="
```

#### 2.3.2 性能健康检查

```bash
#!/bin/bash
# /opt/clickhouse/scripts/performance-check.sh

echo "=== ClickHouse 性能检查 ==="

# 检查内存使用
MEMORY_USAGE=$(clickhouse-client --query "
SELECT value 
FROM system.metrics 
WHERE metric = 'MemoryUsage'
")

echo "内存使用: $MEMORY_USAGE bytes"

# 检查查询性能
QUERY_TIME=$(clickhouse-client --query "
SELECT query_duration_ms
FROM system.query_log 
WHERE query LIKE 'SELECT 1'
ORDER BY event_time DESC 
LIMIT 1
")

echo "基础查询响应时间: ${QUERY_TIME}ms"

# 检查并发连接
CONNECTIONS=$(clickhouse-client --query "
SELECT count() 
FROM system.processes
")

echo "当前连接数: $CONNECTIONS"

# 检查磁盘使用
DISK_USAGE=$(du -sh /var/lib/clickhouse/ | awk '{print $1}')

echo "数据目录大小: $DISK_USAGE"

echo "=== 性能检查完成 ==="
```

## 3. 数据管理

### 3.1 数据库管理

#### 3.1.1 数据库操作

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS app_db;

-- 查看所有数据库
SHOW DATABASES;

-- 删除数据库（谨慎操作）
DROP DATABASE IF EXISTS app_db;
```

#### 3.1.2 表管理

```sql
-- 查看表结构
DESCRIBE TABLE app_db.table_name;

-- 查看表大小
SELECT 
    table,
    formatReadableSize(total_bytes) as size,
    total_rows,
    partition_count
FROM system.tables
WHERE database = 'app_db';

-- 查看表分区
SELECT 
    partition,
    name,
    formatReadableSize(bytes_on_disk) as size,
    rows
FROM system.parts
WHERE database = 'app_db' AND table = 'table_name'
ORDER BY partition DESC;
```

### 3.2 数据维护

#### 3.2.1 数据清理

```sql
-- 清理过期数据
ALTER TABLE app_db.table_name DELETE WHERE event_date < today() - 30;

-- 清理重复数据
ALTER TABLE app_db.table_name DELETE WHERE id IN (
    SELECT id FROM (
        SELECT id, ROW_NUMBER() OVER (PARTITION BY id ORDER BY event_time DESC) as rn
        FROM app_db.table_name
    ) t WHERE rn > 1
);
```

#### 3.2.2 表优化

```sql
-- 强制合并分区
OPTIMIZE TABLE app_db.table_name FINAL;

-- 清理未使用的数据
OPTIMIZE TABLE app_db.table_name DEDUPLICATE;

-- 重建索引
ALTER TABLE app_db.table_name MATERIALIZE INDEX index_name;
```

### 3.3 数据导入导出

#### 3.3.1 数据导入

```bash
# 从CSV文件导入
clickhouse-client --query "
INSERT INTO app_db.table_name 
SELECT * FROM file('data.csv', 'CSV', 'column1 String, column2 UInt32')
"

# 从JSON文件导入
clickhouse-client --query "
INSERT INTO app_db.table_name 
SELECT * FROM file('data.json', 'JSONEachRow')
"
```

#### 3.3.2 数据导出

```bash
# 导出为CSV
clickhouse-client --query "
SELECT * FROM app_db.table_name 
WHERE event_date >= today() - 7
" --format CSV > export.csv

# 导出为JSON
clickhouse-client --query "
SELECT * FROM app_db.table_name 
WHERE event_date >= today() - 7
" --format JSONEachRow > export.json
```

## 4. 性能优化

### 4.1 查询优化

#### 4.1.1 慢查询分析

```sql
-- 分析慢查询
SELECT 
    query,
    query_duration_ms,
    memory_usage,
    read_rows,
    read_bytes,
    written_rows,
    written_bytes,
    user,
    client_hostname,
    event_time
FROM system.query_log 
WHERE query_duration_ms > 5000
ORDER BY query_duration_ms DESC
LIMIT 20;
```

#### 4.1.2 查询优化建议

```sql
-- 检查索引使用情况
SELECT 
    table,
    index_name,
    type,
    expr
FROM system.data_skipping_indices
WHERE database = 'app_db';

-- 检查分区裁剪
EXPLAIN indexes = 1
SELECT * FROM app_db.table_name 
WHERE event_date >= today() - 7;
```

### 4.2 系统优化

#### 4.2.1 内存优化

```sql
-- 检查内存使用详情
SELECT 
    name,
    value,
    type
FROM system.memory_usage
ORDER BY value DESC;

-- 调整内存设置
SET max_memory_usage = 10737418240; -- 10GB
SET max_memory_usage_for_user = 8589934592; -- 8GB
```

#### 4.2.2 并发优化

```sql
-- 检查并发设置
SELECT 
    name,
    value
FROM system.settings
WHERE name LIKE '%concurrent%' OR name LIKE '%thread%';

-- 调整并发设置
SET max_concurrent_queries = 10;
SET max_threads = 4;
```

### 4.3 存储优化

#### 4.3.1 存储分析

```sql
-- 检查存储使用
SELECT 
    database,
    table,
    formatReadableSize(total_bytes) as size,
    total_rows,
    partition_count
FROM system.tables
ORDER BY total_bytes DESC;

-- 检查分区大小
SELECT 
    database,
    table,
    partition,
    formatReadableSize(bytes_on_disk) as size,
    rows
FROM system.parts
ORDER BY bytes_on_disk DESC
LIMIT 20;
```

#### 4.3.2 存储优化

```sql
-- 强制合并小分区
OPTIMIZE TABLE app_db.table_name FINAL;

-- 清理过期分区
ALTER TABLE app_db.table_name DROP PARTITION '2023-01-01';

-- 压缩数据
ALTER TABLE app_db.table_name MODIFY SETTING min_bytes_for_wide_part = 0;
```

## 5. 故障排查

### 5.1 常见问题排查

#### 5.1.1 服务无法启动

```bash
# 检查配置文件
clickhouse-server --config-file=/etc/clickhouse-server/config.yml --test-config

# 检查端口占用
netstat -tlnp | grep -E ":(8123|9000)"

# 检查权限
ls -la /var/lib/clickhouse/
ls -la /var/log/clickhouse-server/

# 检查日志
tail -f /var/log/clickhouse-server/clickhouse-server.log
```

#### 5.1.2 内存不足

```bash
# 检查内存使用
free -h
clickhouse-client --query "SELECT * FROM system.metrics WHERE metric LIKE '%memory%'"

# 检查内存设置
clickhouse-client --query "
SELECT name, value 
FROM system.settings 
WHERE name LIKE '%memory%'
ORDER BY name;
"
```

#### 5.1.3 磁盘空间不足

```bash
# 检查磁盘使用
df -h
du -sh /var/lib/clickhouse/

# 检查大表
clickhouse-client --query "
SELECT 
    database,
    table,
    formatReadableSize(total_bytes) as size
FROM system.tables
ORDER BY total_bytes DESC
LIMIT 10;
"
```

### 5.2 性能问题排查

#### 5.2.1 慢查询分析

```sql
-- 分析慢查询模式
SELECT 
    query,
    count() as execution_count,
    avg(query_duration_ms) as avg_duration,
    max(query_duration_ms) as max_duration,
    sum(read_bytes) as total_read
FROM system.query_log 
WHERE query_duration_ms > 1000
GROUP BY query
ORDER BY avg_duration DESC
LIMIT 10;
```

#### 5.2.2 资源瓶颈分析

```sql
-- 检查CPU使用
SELECT 
    metric,
    value
FROM system.metrics 
WHERE metric LIKE '%cpu%' OR metric LIKE '%thread%'
ORDER BY value DESC;

-- 检查内存使用
SELECT 
    name,
    value,
    type
FROM system.memory_usage
ORDER BY value DESC;
```

### 5.3 连接问题排查

#### 5.3.1 连接数过多

```sql
-- 检查连接详情
SELECT 
    user,
    client_hostname,
    client_name,
    query,
    query_duration_ms
FROM system.processes
ORDER BY query_duration_ms DESC;

-- 检查连接限制
SELECT 
    name,
    value
FROM system.settings
WHERE name LIKE '%connection%' OR name LIKE '%max_connections%';
```

#### 5.3.2 网络问题

```bash
# 检查网络连接
telnet localhost 8123
telnet localhost 9000

# 检查防火墙
iptables -L | grep -E "(8123|9000)"

# 检查网络配置
netstat -tlnp | grep clickhouse
```

## 6. 安全维护

### 6.1 用户管理

#### 6.1.1 用户操作

```sql
-- 创建用户
CREATE USER IF NOT EXISTS app_user IDENTIFIED BY 'StrongPassword123!';

-- 查看用户
SELECT name, id, storage FROM system.users;

-- 删除用户
DROP USER IF EXISTS app_user;
```

#### 6.1.2 权限管理

```sql
-- 授予权限
GRANT SELECT, INSERT ON app_db.* TO app_user;

-- 查看权限
SHOW GRANTS FOR app_user;

-- 撤销权限
REVOKE INSERT ON app_db.* FROM app_user;
```

### 6.2 网络安全

#### 6.2.1 防火墙配置

```bash
# 开放ClickHouse端口
sudo firewall-cmd --permanent --add-port=8123/tcp
sudo firewall-cmd --permanent --add-port=9000/tcp
sudo firewall-cmd --reload

# 检查防火墙状态
sudo firewall-cmd --list-ports
```

#### 6.2.2 SSL配置

```bash
# 生成SSL证书
sudo openssl req -x509 -newkey rsa:4096 -keyout /etc/clickhouse-server/server.key -out /etc/clickhouse-server/server.crt -days 365 -nodes

# 设置证书权限
sudo chown clickhouse:clickhouse /etc/clickhouse-server/server.key /etc/clickhouse-server/server.crt
sudo chmod 600 /etc/clickhouse-server/server.key
sudo chmod 644 /etc/clickhouse-server/server.crt
```

### 6.3 审计日志

#### 6.3.1 审计配置

```yaml
# /etc/clickhouse-server/config.yml
clickhouse:
  query_log:
    database: system
    table: query_log
    partition_by: toYYYYMM(event_date)
    flush_interval_milliseconds: 7500
    log_query_settings: 0
    log_query_threads: 0
```

#### 6.3.2 审计分析

```sql
-- 分析用户活动
SELECT 
    user,
    count() as query_count,
    count(DISTINCT client_hostname) as unique_hosts,
    avg(query_duration_ms) as avg_duration
FROM system.query_log 
WHERE event_date >= today() - 7
GROUP BY user
ORDER BY query_count DESC;

-- 检查异常访问
SELECT 
    user,
    client_hostname,
    count() as access_count,
    max(event_time) as last_access
FROM system.query_log 
WHERE event_date >= today() - 1
GROUP BY user, client_hostname
HAVING access_count > 1000
ORDER BY access_count DESC;
```

## 7. 备份恢复

### 7.1 备份策略

#### 7.1.1 自动备份脚本

```bash
#!/bin/bash
# /opt/clickhouse/scripts/backup.sh

BACKUP_DIR="/opt/clickhouse/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="clickhouse_backup_$DATE"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 停止服务（可选，用于一致性备份）
# sudo systemctl stop clickhouse-server

# 备份数据目录
sudo tar -czf "$BACKUP_DIR/${BACKUP_NAME}.tar.gz" \
    -C /var/lib/clickhouse/ . \
    --exclude='tmp' \
    --exclude='user_files'

# 备份配置文件
sudo tar -czf "$BACKUP_DIR/config_${BACKUP_NAME}.tar.gz" \
    -C /etc/clickhouse-server/ .

# 启动服务（如果之前停止了）
# sudo systemctl start clickhouse-server

# 清理旧备份（保留7天）
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "备份完成: $BACKUP_NAME"
```

#### 7.1.2 增量备份

```bash
#!/bin/bash
# /opt/clickhouse/scripts/incremental-backup.sh

BACKUP_DIR="/opt/clickhouse/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="incremental_backup_$DATE"

# 创建增量备份
clickhouse-client --query "
BACKUP TABLE app_db.table_name 
TO '$BACKUP_DIR/$BACKUP_NAME'
"

# 压缩备份
tar -czf "$BACKUP_DIR/${BACKUP_NAME}.tar.gz" -C "$BACKUP_DIR" "$BACKUP_NAME"

# 清理临时文件
rm -rf "$BACKUP_DIR/$BACKUP_NAME"

echo "增量备份完成: $BACKUP_NAME"
```

### 7.2 恢复策略

#### 7.2.1 完整恢复

```bash
#!/bin/bash
# /opt/clickhouse/scripts/restore.sh

BACKUP_FILE="$1"
RESTORE_DIR="/tmp/clickhouse_restore"

if [ -z "$BACKUP_FILE" ]; then
    echo "请指定备份文件路径"
    exit 1
fi

# 停止服务
sudo systemctl stop clickhouse-server

# 清理数据目录
sudo rm -rf /var/lib/clickhouse/*

# 解压备份
mkdir -p $RESTORE_DIR
tar -xzf "$BACKUP_FILE" -C $RESTORE_DIR

# 恢复数据
sudo cp -r $RESTORE_DIR/* /var/lib/clickhouse/

# 设置权限
sudo chown -R clickhouse:clickhouse /var/lib/clickhouse/

# 启动服务
sudo systemctl start clickhouse-server

# 清理临时文件
rm -rf $RESTORE_DIR

echo "恢复完成"
```

#### 7.2.2 表级恢复

```sql
-- 恢复特定表
RESTORE TABLE app_db.table_name 
FROM '/opt/clickhouse/backups/table_backup';

-- 检查恢复结果
SELECT 
    table,
    formatReadableSize(total_bytes) as size,
    total_rows
FROM system.tables
WHERE database = 'app_db' AND table = 'table_name';
```

### 7.3 备份验证

#### 7.3.1 备份完整性检查

```bash
#!/bin/bash
# /opt/clickhouse/scripts/verify-backup.sh

BACKUP_FILE="$1"

if [ -z "$BACKUP_FILE" ]; then
    echo "请指定备份文件路径"
    exit 1
fi

# 检查备份文件
if [ ! -f "$BACKUP_FILE" ]; then
    echo "备份文件不存在: $BACKUP_FILE"
    exit 1
fi

# 检查文件完整性
tar -tzf "$BACKUP_FILE" > /dev/null
if [ $? -eq 0 ]; then
    echo "✓ 备份文件完整性检查通过"
else
    echo "✗ 备份文件损坏"
    exit 1
fi

# 检查文件大小
BACKUP_SIZE=$(stat -c%s "$BACKUP_FILE")
echo "备份文件大小: $(numfmt --to=iec $BACKUP_SIZE)"

echo "备份验证完成"
```

## 8. 升级维护

### 8.1 版本升级

#### 8.1.1 升级准备

```bash
# 检查当前版本
clickhouse-server --version

# 备份重要数据
sudo /opt/clickhouse/scripts/backup.sh

# 检查系统兼容性
sudo yum check-update clickhouse-server
```

#### 8.1.2 执行升级

```bash
# 停止服务
sudo systemctl stop clickhouse-server

# 升级ClickHouse
sudo yum update clickhouse-server clickhouse-client

# 启动服务
sudo systemctl start clickhouse-server

# 检查升级结果
clickhouse-server --version
sudo systemctl status clickhouse-server
```

### 8.2 配置更新

#### 8.2.1 配置备份

```bash
# 备份当前配置
sudo cp /etc/clickhouse-server/config.yml /etc/clickhouse-server/config.yml.backup.$(date +%Y%m%d)
sudo cp /etc/clickhouse-server/users.yml /etc/clickhouse-server/users.yml.backup.$(date +%Y%m%d)
```

#### 8.2.2 配置更新

```bash
# 更新配置文件
sudo cp /opt/clickhouse/config/config.yml /etc/clickhouse-server/
sudo cp /opt/clickhouse/config/users.yml /etc/clickhouse-server/

# 重载配置
clickhouse-client --query "SYSTEM RELOAD CONFIG"
clickhouse-client --query "SYSTEM RELOAD USERS"
```

### 8.3 回滚策略

#### 8.3.1 服务回滚

```bash
# 停止服务
sudo systemctl stop clickhouse-server

# 恢复配置文件
sudo cp /etc/clickhouse-server/config.yml.backup.* /etc/clickhouse-server/config.yml
sudo cp /etc/clickhouse-server/users.yml.backup.* /etc/clickhouse-server/users.yml

# 启动服务
sudo systemctl start clickhouse-server

# 验证回滚
sudo systemctl status clickhouse-server
```

#### 8.3.2 数据回滚

```bash
# 恢复数据备份
sudo /opt/clickhouse/scripts/restore.sh /opt/clickhouse/backups/latest_backup.tar.gz

# 验证数据完整性
clickhouse-client --query "
SELECT 
    database,
    table,
    total_rows
FROM system.tables
WHERE database NOT IN ('system', 'information_schema')
ORDER BY total_rows DESC;
"
```

## 9. 监控告警

### 9.1 监控指标

#### 9.1.1 关键指标

```sql
-- 系统健康指标
SELECT 
    metric,
    value,
    description
FROM system.metrics 
WHERE metric IN (
    'MemoryUsage',
    'CPUUtilization',
    'DiskUsage',
    'Query',
    'QueryThread',
    'TCPConnection'
)
ORDER BY metric;
```

#### 9.1.2 性能指标

```sql
-- 查询性能指标
SELECT 
    avg(query_duration_ms) as avg_duration,
    max(query_duration_ms) as max_duration,
    count() as query_count,
    sum(read_bytes) as total_read,
    sum(written_bytes) as total_written
FROM system.query_log 
WHERE event_date >= today() - 1;
```

### 9.2 告警配置

#### 9.2.1 告警脚本

```bash
#!/bin/bash
# /opt/clickhouse/scripts/alert.sh

# 检查内存使用
MEMORY_USAGE=$(clickhouse-client --query "
SELECT value 
FROM system.metrics 
WHERE metric = 'MemoryUsage'
")

MEMORY_LIMIT=12884901888  # 12GB

if [ $MEMORY_USAGE -gt $MEMORY_LIMIT ]; then
    echo "告警: ClickHouse内存使用过高 - ${MEMORY_USAGE} bytes"
    # 发送告警通知
fi

# 检查连接数
CONNECTIONS=$(clickhouse-client --query "
SELECT count() 
FROM system.processes
")

CONNECTION_LIMIT=100

if [ $CONNECTIONS -gt $CONNECTION_LIMIT ]; then
    echo "告警: ClickHouse连接数过多 - ${CONNECTIONS}"
    # 发送告警通知
fi

# 检查慢查询
SLOW_QUERIES=$(clickhouse-client --query "
SELECT count() 
FROM system.query_log 
WHERE query_duration_ms > 5000 
AND event_date >= today()
")

if [ $SLOW_QUERIES -gt 10 ]; then
    echo "告警: ClickHouse慢查询过多 - ${SLOW_QUERIES}"
    # 发送告警通知
fi
```

#### 9.2.2 定时监控

```bash
# 添加到crontab
# 每5分钟执行一次健康检查
*/5 * * * * /opt/clickhouse/scripts/health-check.sh >> /var/log/clickhouse/health.log 2>&1

# 每小时执行一次性能检查
0 * * * * /opt/clickhouse/scripts/performance-check.sh >> /var/log/clickhouse/performance.log 2>&1

# 每天凌晨2点执行备份
0 2 * * * /opt/clickhouse/scripts/backup.sh >> /var/log/clickhouse/backup.log 2>&1
```

## 10. 运维工具

### 10.1 常用脚本

#### 10.1.1 快速诊断脚本

```bash
#!/bin/bash
# /opt/clickhouse/scripts/diagnose.sh

echo "=== ClickHouse 快速诊断 ==="

# 系统信息
echo "系统信息:"
uname -a
echo ""

# 硬件信息
echo "硬件信息:"
free -h
df -h
echo ""

# 服务状态
echo "服务状态:"
systemctl status clickhouse-server --no-pager
echo ""

# 端口监听
echo "端口监听:"
netstat -tlnp | grep clickhouse
echo ""

# 连接状态
echo "连接状态:"
clickhouse-client --query "SELECT count() FROM system.processes"
echo ""

# 内存使用
echo "内存使用:"
clickhouse-client --query "
SELECT 
    metric,
    value
FROM system.metrics 
WHERE metric LIKE '%memory%'
ORDER BY value DESC;
"
echo ""

echo "=== 诊断完成 ==="
```

#### 10.1.2 性能分析脚本

```bash
#!/bin/bash
# /opt/clickhouse/scripts/analyze.sh

echo "=== ClickHouse 性能分析 ==="

# 查询性能统计
echo "查询性能统计:"
clickhouse-client --query "
SELECT 
    count() as total_queries,
    avg(query_duration_ms) as avg_duration,
    max(query_duration_ms) as max_duration,
    sum(read_bytes) as total_read,
    sum(written_bytes) as total_written
FROM system.query_log 
WHERE event_date >= today() - 1;
"
echo ""

# 慢查询TOP10
echo "慢查询TOP10:"
clickhouse-client --query "
SELECT 
    query,
    query_duration_ms,
    memory_usage,
    read_rows
FROM system.query_log 
WHERE query_duration_ms > 1000
ORDER BY query_duration_ms DESC
LIMIT 10;
"
echo ""

# 表大小统计
echo "表大小统计:"
clickhouse-client --query "
SELECT 
    database,
    table,
    formatReadableSize(total_bytes) as size,
    total_rows
FROM system.tables
ORDER BY total_bytes DESC
LIMIT 10;
"
echo ""

echo "=== 分析完成 ==="
```

### 10.2 监控面板

#### 10.2.1 Grafana配置

```yaml
# /etc/grafana/provisioning/dashboards/clickhouse.yml
apiVersion: 1

providers:
  - name: 'ClickHouse'
    orgId: 1
    folder: ''
    type: file
    disableDeletion: false
    updateIntervalSeconds: 10
    allowUiUpdates: true
    options:
      path: /var/lib/grafana/dashboards
```

#### 10.2.2 Prometheus配置

```yaml
# /etc/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'clickhouse'
    static_configs:
      - targets: ['localhost:9116']
    scrape_interval: 15s
```

---

## 总结

本运维手册提供了ClickHouse传统服务器部署的完整运维指南，涵盖了从日常监控到故障排查的各个方面。通过合理的运维管理，可以确保ClickHouse系统的稳定运行和良好性能。

建议运维人员根据实际环境和业务需求，制定适合的运维流程和监控策略，并定期更新和完善运维文档。 