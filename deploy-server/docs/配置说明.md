# ClickHouse Server 配置说明文档

## 概述

本文档详细说明ClickHouse传统服务器部署中的各个配置文件的作用、参数含义和配置建议。配置文件已根据硬件配置建议（4核CPU、16GB内存、150GB NVMe SSD）进行了全面优化，达到最佳实践标准。

## 🖥️ 硬件配置基准

| 组件 | 规格 | 优化重点 |
|------|------|----------|
| **CPU** | 4核 | 线程池优化、并发控制 |
| **内存** | 16GB | 缓存分配、内存限制 |
| **存储** | 150GB NVMe SSD | 合并策略、IO优化 |
| **网络** | 1Gbps | 连接池、超时设置 |

## 📊 配置优化说明

### 内存分配优化 (16GB总内存)

```json
总内存使用限制: 12GB (75%)
├── 查询内存限制: 12GB (75%)
├── 用户内存限制: 12GB (75%)
└── 缓存分配:
    ├── 未压缩缓存: 6GB (37.5%)
    ├── 标记缓存: 3GB (18.75%)
    └── 系统预留: 3GB (18.75%)
```

### CPU线程优化 (4核CPU)

```json
最大线程数: 4 (1:1对应CPU核心)
插入线程数: 4
异步插入线程: 8
后台任务线程: 4
并发查询数: 10 (CPU核心数 × 2 + 2)
```

### 存储优化 (150GB NVMe SSD)

```json
最大合并空间: 100GB (67%)
最小合并空间: 50GB (33%)
索引粒度: 8192
```

## 配置文件结构

```json
deploy-server/clickhouse/config/
├── config.d/
│   └── config.xml              # 主配置文件（基础配置、日志、网络、存储、性能优化）
└── users.d/
    └── users.xml               # 用户配置文件（用户权限、配额管理、配置文件）
```

## 1. 主配置文件 (config.d/config.xml)

### 1.1 基础配置

```xml
<clickhouse>
    <timezone>UTC</timezone>
    
    <!-- 日志配置优化 - 减少警告输出 -->
    <logger>
        <level>warning</level>  <!-- 生产环境使用warning级别减少日志输出 -->
        <log_remove_reason>0</log_remove_reason>
        <system_logs_level>warning</system_logs_level>
        
        <log>/var/log/clickhouse-server/clickhouse-server.log</log>
        <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>
        <size>1000M</size>
        <count>10</count>
        <console>0</console>
    </logger>

    <!-- 网络配置 -->
    <listen_host>0.0.0.0</listen_host>
    <http_port>8123</http_port>
    <tcp_port>9000</tcp_port>
    <max_connections>4096</max_connections>
    <keep_alive_timeout>3</keep_alive_timeout>
    
    <!-- 并发限制 (4核CPU) -->
    <max_concurrent_queries>10</max_concurrent_queries>
</clickhouse>
```

**参数说明：**

- `logger.level`: 日志级别，生产环境使用warning减少日志输出
- `http_port`: HTTP接口端口，用于Web界面和HTTP API
- `tcp_port`: Native协议端口，用于ClickHouse客户端连接
- `max_connections`: 最大连接数，根据内存配置调整
- `max_concurrent_queries`: 最大并发查询数，建议为CPU核心数×2+2

### 1.2 内存和缓存配置

```xml
<!-- 内存和缓存配置 (16GB总内存) -->
<max_server_memory_usage>12884901888</max_server_memory_usage> <!-- 12GB -->
<uncompressed_cache_size>6442450944</uncompressed_cache_size>  <!-- 6GB -->
<mark_cache_size>3221225472</mark_cache_size>                 <!-- 3GB -->
```

**缓存分配说明：**

- `max_server_memory_usage`: 服务器最大内存使用量
- `uncompressed_cache_size`: 未压缩数据缓存，用于加速查询
- `mark_cache_size`: 标记缓存，用于加速索引查找

### 1.3 存储配置

```xml
<!-- MergeTree调优 (150GB NVMe) -->
<merge_tree>
    <parts_to_delay_insert>150</parts_to_delay_insert>
    <parts_to_throw_insert>300</parts_to_throw_insert>
    <max_bytes_to_merge_at_max_space_in_pool>107374182400</max_bytes_to_merge_at_max_space_in_pool> <!-- 100GB -->
    <max_bytes_to_merge_at_min_space_in_pool>53687091200</max_bytes_to_merge_at_min_space_in_pool>  <!-- 50GB -->
    <index_granularity>8192</index_granularity>
    <index_granularity_bytes>0</index_granularity_bytes>
    <min_bytes_for_wide_part>0</min_bytes_for_wide_part>
    <min_rows_for_wide_part>0</min_rows_for_wide_part>
</merge_tree>
```

**存储优化说明：**

- `parts_to_delay_insert`: 延迟插入的部件数量
- `parts_to_throw_insert`: 抛出插入错误的部件数量
- `max_bytes_to_merge_at_max_space_in_pool`: 最大合并空间
- `max_bytes_to_merge_at_min_space_in_pool`: 最小合并空间

### 1.4 系统优化配置

```xml
<!-- 系统级优化配置 -->
<system>
    <!-- 异步插入优化 -->
    <async_insert_threads>8</async_insert_threads>
    <async_insert>1</async_insert>
    
    <!-- 系统表优化 -->
    <system_tables_cleanup_interval>3600</system_tables_cleanup_interval>
    
    <!-- 临时文件优化 -->
    <tmp_path>/var/lib/clickhouse/tmp</tmp_path>
    <max_temporary_data_on_disk_size>0</max_temporary_data_on_disk_size>
    
    <!-- 启用系统日志 - 用于监控和调试 -->
    <metric_log_enabled>1</metric_log_enabled>
    <asynchronous_metric_log_enabled>1</asynchronous_metric_log_enabled>
    <query_log_enabled>1</query_log_enabled>
    <text_log_enabled>1</text_log_enabled>
    <trace_log_enabled>1</trace_log_enabled>
    <processors_profile_log_enabled>1</processors_profile_log_enabled>
    <latency_log_enabled>1</latency_log_enabled>
    <error_log_enabled>1</error_log_enabled>
</system>

<!-- 性能优化配置 -->
<performance>
    <background_pool_size>4</background_pool_size>
    <background_schedule_pool_size>4</background_schedule_pool_size>
</performance>
```

### 1.5 错误处理配置

```xml
<!-- 错误处理和权限优化 -->
<error_handling>
    <!-- 忽略文件权限错误 -->
    <ignore_file_permission_errors>1</ignore_file_permission_errors>
    <!-- 减少错误重试次数 -->
    <max_retries_for_file_operations>1</max_retries_for_file_operations>
</error_handling>
```

**错误处理说明：**

- `ignore_file_permission_errors`: 忽略文件权限错误，避免服务中断
- `max_retries_for_file_operations`: 文件操作最大重试次数，减少重试开销

### 1.6 系统日志配置

```xml
<!-- 系统日志配置 - 已启用用于监控 -->
<query_log>
    <database>system</database>
    <table>query_log</table>
    <partition_by>toYYYYMM(event_date)</partition_by>
    <flush_interval_milliseconds>30000</flush_interval_milliseconds>
</query_log>

<query_thread_log>
    <database>system</database>
    <table>query_thread_log</table>
    <partition_by>toYYYYMM(event_date)</partition_by>
    <flush_interval_milliseconds>30000</flush_interval_milliseconds>
</query_thread_log>

<text_log>
    <database>system</database>
    <table>text_log</table>
    <partition_by>toYYYYMM(event_date)</partition_by>
    <flush_interval_milliseconds>30000</flush_interval_milliseconds>
</text_log>

<trace_log>
    <database>system</database>
    <table>trace_log</table>
    <partition_by>toYYYYMM(event_date)</partition_by>
    <flush_interval_milliseconds>30000</flush_interval_milliseconds>
</trace_log>

<metric_log>
    <database>system</database>
    <table>metric_log</table>
    <flush_interval_milliseconds>30000</flush_interval_milliseconds>
</metric_log>

<asynchronous_metric_log>
    <database>system</database>
    <table>asynchronous_metric_log</table>
    <flush_interval_milliseconds>30000</flush_interval_milliseconds>
</asynchronous_metric_log>

<!-- 系统表 TTL 配置 -->
<system_tables_ttl>
    <!-- 异步指标日志保留1天 -->
    <asynchronous_metric_log>
        <ttl>event_time + INTERVAL 1 DAY</ttl>
    </asynchronous_metric_log>
    
    <!-- 查询日志保留6小时 -->
    <query_log>
        <ttl>event_time + INTERVAL 6 HOUR</ttl>
    </query_log>
    
    <!-- 文本日志保留6小时 -->
    <text_log>
        <ttl>event_time + INTERVAL 6 HOUR</ttl>
    </text_log>
    
    <!-- 延迟日志保留6小时 -->
    <latency_log>
        <ttl>event_time + INTERVAL 6 HOUR</ttl>
    </latency_log>
    
    <!-- 处理器性能日志保留6小时 -->
    <processors_profile_log>
        <ttl>event_time + INTERVAL 6 HOUR</ttl>
    </processors_profile_log>
    
    <!-- 跟踪日志保留6小时 -->
    <trace_log>
        <ttl>event_time + INTERVAL 6 HOUR</ttl>
    </trace_log>
    
    <!-- 指标日志保留1天 -->
    <metric_log>
        <ttl>event_time + INTERVAL 1 DAY</ttl>
    </metric_log>
</system_tables_ttl>
```

## 2. 用户配置文件 (users.d/users.xml)

### 2.1 用户配置

```xml
<clickhouse>
    <users>
        <!-- 移除默认用户 -->
        <default remove="remove">
        </default>

        <!-- 重新定义默认用户 -->
        <default>
            <profile>default</profile>
            <networks>
                <ip>::/0</ip>
            </networks>
            <password><![CDATA[clickhouse123]]></password>
            <quota>default</quota>
            <access_management>1</access_management>
        </default>

        <!-- 管理员用户 - 拥有所有权限 -->
        <admin>
            <password>Admin_2024_Secure!</password>
            <networks>
                <ip>127.0.0.1</ip>
                <ip>10.0.0.0/8</ip>
                <ip>172.16.0.0/12</ip>
                <ip>192.168.0.0/16</ip>
            </networks>
            <profile>default</profile>
            <access_management>1</access_management>
        </admin>

        <!-- 普通Web用户 - 只有基本权限 -->
        <webuser>
            <password>WebUser_2024_Secure!</password>
            <networks>
                <ip>::/0</ip>
            </networks>
            <profile>default</profile>
            <access_management>0</access_management>
        </webuser>
        
        <!-- 演示用户 - 只读权限 -->
        <demouser>
            <password>DemoUser_2024_Secure!</password>
            <networks>
                <ip>::/0</ip>
            </networks>
            <profile>default</profile>
            <access_management>0</access_management>
            <readonly>1</readonly>
            <default_database>demo</default_database>
            <max_memory_usage_for_user_for_all_queries>12884901888</max_memory_usage_for_user_for_all_queries>
        </demouser>
    </users>
</clickhouse>
```

**用户配置说明：**

- `default`: 默认用户，允许从任何IP访问，启用访问管理
- `admin`: 管理员用户，限制网络访问，拥有所有权限
- `webuser`: Web应用用户，允许从任何IP访问，禁用访问管理
- `demouser`: 演示用户，只读权限，限制内存使用

### 2.2 配置文件

```xml
<profiles>
    <default>
        <max_threads>4</max_threads>
        <max_insert_threads>4</max_insert_threads>
        <max_memory_usage>12884901888</max_memory_usage>
        <max_memory_usage_for_user>12884901888</max_memory_usage_for_user>
        <max_memory_usage_for_all_queries>12884901888</max_memory_usage_for_all_queries>
        
        <!-- 超时设置 -->
        <connect_timeout>10</connect_timeout>
        <receive_timeout>300</receive_timeout>
        <send_timeout>300</send_timeout>

        <!-- 异步插入 -->
        <async_insert>1</async_insert>
        <async_insert_threads>4</async_insert_threads>
    </default>
</profiles>
```

**配置文件说明：**

- `max_threads`: 最大线程数，设置为CPU核心数
- `max_memory_usage`: 单次查询最大内存使用量
- `max_memory_usage_for_user`: 用户最大内存使用量
- `max_memory_usage_for_all_queries`: 所有查询最大内存使用量
- `async_insert`: 启用异步插入以提高性能

## 3. 配置优化特点

### 3.1 性能优化

1. **内存优化**
   - 总内存限制：12GB（16GB的75%）
   - 缓存分配：6GB未压缩缓存 + 3GB标记缓存
   - 用户内存限制：12GB

2. **CPU优化**
   - 最大线程数：4（对应4核CPU）
   - 异步插入线程：8
   - 后台任务线程：4
   - 并发查询数：10

3. **存储优化**
   - 最大合并空间：100GB
   - 最小合并空间：50GB
   - 索引粒度：8192

### 3.2 日志优化

1. **日志级别**
   - 主日志级别：warning（减少输出）
   - 系统日志级别：warning
   - 控制台输出：禁用

2. **系统日志**
   - **已启用所有系统日志**用于监控和调试
   - 日志刷新间隔：30秒
   - 日志TTL设置为6小时到1天

### 3.3 错误处理优化

1. **文件权限处理**
   - 忽略文件权限错误，避免服务中断
   - 减少文件操作重试次数

2. **系统稳定性**
   - 优化错误处理机制
   - 减少不必要的重试开销

### 3.4 安全配置

1. **用户权限**
   - 默认用户：允许任何IP访问
   - 管理员用户：限制网络访问
   - 演示用户：只读权限

2. **网络访问**
   - HTTP端口：8123
   - TCP端口：9000
   - 最大连接数：4096

## 4. 系统参数优化

### 4.1 内核参数优化

```bash
# /etc/sysctl.conf
# 文件描述符限制
fs.file-max = 65536
fs.nr_open = 65536

# 网络参数优化
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 5000
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 1200
net.ipv4.tcp_max_tw_buckets = 5000

# 内存参数优化
vm.swappiness = 1
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
```

### 4.2 用户限制优化

```bash
# /etc/security/limits.conf
clickhouse soft nofile 65536
clickhouse hard nofile 65536
clickhouse soft nproc 32768
clickhouse hard nproc 32768
```

## 5. 监控配置

### 5.1 系统监控

```yaml
# Prometheus配置
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'clickhouse'
    static_configs:
      - targets: ['localhost:9116']
```

### 5.2 ClickHouse监控

```sql
-- 检查系统资源使用
SELECT 
    metric,
    value
FROM system.metrics
WHERE metric IN ('MemoryUsage', 'CPUUtilization', 'DiskUsage');

-- 检查慢查询
SELECT 
    query,
    query_duration_ms,
    memory_usage,
    read_rows,
    read_bytes
FROM system.query_log 
WHERE query_duration_ms > 1000
ORDER BY query_duration_ms DESC
LIMIT 10;
```

## 6. 备份配置

### 6.1 自动备份

```bash
#!/bin/bash
# /opt/clickhouse/scripts/backup.sh

BACKUP_DIR="/opt/clickhouse/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="clickhouse_backup_$DATE"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 执行备份
clickhouse-client --query "BACKUP TABLE database_name.table_name TO '$BACKUP_DIR/$BACKUP_NAME'"

# 压缩备份
tar -czf "$BACKUP_DIR/${BACKUP_NAME}.tar.gz" -C "$BACKUP_DIR" "$BACKUP_NAME"

# 清理临时文件
rm -rf "$BACKUP_DIR/$BACKUP_NAME"

# 保留最近7天的备份
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete
```

## 7. 故障排查

### 7.1 常见问题

1. **内存不足**
   ```bash
   # 检查内存使用
   free -h
   # 检查ClickHouse内存使用
   clickhouse-client --query "SELECT * FROM system.metrics WHERE metric LIKE '%memory%'"
   ```

2. **磁盘空间不足**
   ```bash
   # 检查磁盘使用
   df -h
   # 检查ClickHouse数据目录
   du -sh /var/lib/clickhouse/
   ```

3. **连接数过多**
   ```bash
   # 检查连接数
   clickhouse-client --query "SELECT * FROM system.processes"
   ```

### 7.2 性能诊断

```sql
-- 检查系统资源使用
SELECT 
    metric,
    value
FROM system.metrics
WHERE metric IN ('MemoryUsage', 'CPUUtilization', 'DiskUsage');

-- 检查查询性能
SELECT 
    query,
    query_duration_ms,
    memory_usage,
    read_rows,
    read_bytes
FROM system.query_log 
WHERE query_duration_ms > 1000
ORDER BY query_duration_ms DESC
LIMIT 10;
```

## 8. 部署检查清单

### 8.1 部署前检查

- [ ] 硬件配置满足要求
- [ ] 操作系统版本兼容
- [ ] 网络连接正常
- [ ] 存储空间充足

### 8.2 部署中检查

- [ ] ClickHouse服务启动成功
- [ ] 配置文件加载正确
- [ ] 端口监听正常
- [ ] 用户权限配置正确

### 8.3 部署后检查

- [ ] 服务可访问
- [ ] 查询性能正常
- [ ] 监控指标正常
- [ ] 备份功能正常

## 9. 维护建议

### 9.1 日常维护

1. **定期监控**
   - 系统资源使用情况
   - ClickHouse性能指标
   - 错误日志分析

2. **定期备份**
   - 每日自动备份
   - 备份文件验证
   - 恢复测试

3. **定期优化**
   - 查询性能分析
   - 索引优化
   - 存储空间清理

### 9.2 升级维护

1. **版本升级**
   - 备份重要数据
   - 测试新版本功能
   - 制定回滚方案

2. **配置更新**
   - 配置文件版本控制
   - 变更影响评估
   - 灰度发布策略

---

## 总结

本配置说明文档提供了ClickHouse传统服务器部署的完整配置指南，基于实际的XML配置文件结构。通过合理的配置优化，可以充分发挥硬件性能，确保系统稳定运行和良好的查询性能。

**主要优化特点：**

1. **性能优化**：针对4核CPU、16GB内存、150GB NVMe SSD进行了全面优化
2. **日志优化**：使用warning级别减少日志输出，但启用系统日志用于监控
3. **错误处理优化**：新增错误处理配置，提高系统稳定性
4. **安全配置**：合理的用户权限和网络访问控制
5. **内存管理**：科学的内存分配策略，避免内存不足问题
6. **监控支持**：启用所有系统日志，便于性能监控和问题排查

**重要变更说明：**

- **系统日志已启用**：所有系统日志（query_log、metric_log等）都已启用，用于监控和调试
- **日志级别优化**：使用warning级别减少不必要的日志输出
- **TTL配置**：系统日志设置了合理的TTL，避免数据积累过多

建议在实际部署时，根据具体的硬件配置和业务需求对相关参数进行微调，以达到最佳的性能表现。 