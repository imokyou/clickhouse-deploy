# ClickHouse Server 配置说明文档

## 概述

本文档详细说明ClickHouse传统服务器部署中的各个配置文件的作用、参数含义和配置建议。配置文件已根据硬件配置建议（4核CPU、16GB内存、150GB NVMe SSD）进行了全面优化，达到最佳实践标准。

## 🖥️ 硬件配置基准

| 组件 | 规格 | 优化重点 |
|------|------|----------|
| **CPU** | 4核 | 线程池优化、并发控制 |
| **内存** | 16GB | 缓存分配、内存限制 |
| **存储** | 150GB NVMe SSD | 合并策略、IO优化 |
| **网络** | 1Gbps | 连接池、超时设置 |

## 📊 配置优化说明

### 内存分配优化 (16GB总内存)

```json
总内存使用限制: 12GB (75%)
├── 查询内存限制: 10GB (62.5%)
├── 用户内存限制: 8GB (50%)
└── 缓存分配:
    ├── 未压缩缓存: 6GB (37.5%)
    ├── 标记缓存: 3GB (18.75%)
    ├── 查询缓存: 512MB (3.125%)
    └── 字典缓存: 512MB (3.125%)
```

### CPU线程优化 (4核CPU)

```json
最大线程数: 4 (1:1对应CPU核心)
插入线程数: 4
后台任务线程: 4
异步插入线程: 4
并发查询数: 10 (CPU核心数 × 2 + 2)
```

### 存储优化 (150GB NVMe SSD)

```json
最大合并空间: 100GB (67%)
最小合并空间: 50GB (33%)
索引粒度: 8192
```

## 配置文件结构

```json
deploy-server/clickhouse/config/
├── config.yml              # 主配置文件（基础配置、日志、网络、存储）
├── users.yml               # 用户配置文件（用户权限、配额管理）
├── performance.yml         # 性能优化配置（内存、CPU、存储、网络、查询优化）
├── security.yml           # 安全配置文件（网络安全、HTTP/TCP安全、查询安全）
├── macros.yml             # 集群宏定义
└── json-optimization.yml  # JSON数据优化配置（专门针对JSON数据处理）
```

## 1. 主配置文件 (config.yml)

### 1.1 基础配置

```yaml
clickhouse:
  logger:
    level: information  # 生产环境使用information级别
    log: /var/log/clickhouse-server/clickhouse-server.log
    errorlog: /var/log/clickhouse-server/clickhouse-server.err.log
    size: 1000M
    count: 10
    console: 0  # 生产环境关闭控制台输出

  http_port: 8123
  tcp_port: 9000
  max_connections: 4096
  keep_alive_timeout: 3
  max_concurrent_queries: 10  # 根据硬件配置调整，4核CPU建议10个并发
```

**参数说明：**

- `logger.level`: 日志级别，生产环境使用information
- `http_port`: HTTP接口端口，用于Web界面和HTTP API
- `tcp_port`: Native协议端口，用于ClickHouse客户端连接
- `max_connections`: 最大连接数，根据内存配置调整
- `max_concurrent_queries`: 最大并发查询数，建议为CPU核心数×2+2

### 1.2 缓存配置

```yaml
  # 缓存配置优化 - 根据16GB内存调整
  uncompressed_cache_size: 6442450944  # 6GB (16GB * 0.375)
  mark_cache_size: 3221225472  # 3GB (16GB * 0.1875)
```

**缓存分配说明：**

- `uncompressed_cache_size`: 未压缩数据缓存，用于加速查询
- `mark_cache_size`: 标记缓存，用于加速索引查找

### 1.3 存储配置

```yaml
  path: /var/lib/clickhouse/
  tmp_path: /var/lib/clickhouse/tmp/

  # 合并树引擎优化 - 根据150GB存储调整
  merge_tree:
    parts_to_delay_insert: 150
    parts_to_throw_insert: 300
    max_bytes_to_merge_at_max_space_in_pool: 107374182400  # 100GB (150GB * 0.67)
```

**存储优化说明：**

- `path`: 数据存储路径
- `tmp_path`: 临时文件路径
- `parts_to_delay_insert`: 延迟插入的部件数量
- `max_bytes_to_merge_at_max_space_in_pool`: 最大合并空间

### 1.4 线程池配置

```yaml
  # 异步插入配置 - 根据4核CPU优化
  async_insert: 1
  async_insert_threads: 4  # 调整为CPU核心数

  # 后台合并优化 - 根据4核CPU调整
  background_pool_size: 4  # 调整为CPU核心数
  background_schedule_pool_size: 4  # 调整为CPU核心数
```

## 2. 用户配置文件 (users.yml)

### 2.1 默认用户配置

```yaml
clickhouse:
  users:
    default:
      password: StrongPassword123!
      profile: default
      quota: default
      networks:
        ip: ::/0
```

### 2.2 应用用户配置

```yaml
    app_user:
      password: AppPassword456!
      profile: app_profile
      quota: app_quota
      databases:
        app_db:
          privileges:
            - SELECT
            - INSERT
            - CREATE TABLE
            - DROP TABLE
```

### 2.3 配额配置

```yaml
  quotas:
    default:
      interval:
        duration: 3600
        queries: 0
        errors: 0
        result_rows: 0
        read_rows: 0
        execution_time: 0
    app_quota:
      interval:
        duration: 3600
        queries: 10000
        errors: 1000
        result_rows: 1000000
        read_rows: 10000000
        execution_time: 60
```

## 3. 性能优化配置 (performance.yml)

### 3.1 内存配置

```yaml
clickhouse:
  profiles:
    default:
      max_memory_usage: 10737418240  # 10GB
      max_memory_usage_for_user: 8589934592  # 8GB
      max_memory_usage_for_all_queries: 12884901888  # 12GB
```

### 3.2 查询优化

```yaml
    app_profile:
      max_memory_usage: 8589934592  # 8GB
      max_threads: 4
      max_insert_threads: 4
      max_query_size: 1073741824  # 1GB
      max_ast_elements: 1000000
      max_expanded_ast_elements: 1000000
```

### 3.3 网络优化

```yaml
  # 网络配置优化
  listen_host: 0.0.0.0
  max_server_memory_usage: 12884901888  # 12GB (16GB * 0.75)
  max_thread_pool_size: 10000
```

## 4. 安全配置文件 (security.yml)

### 4.1 网络安全

```yaml
clickhouse:
  # 网络安全配置
  tcp_port_secure: 9440
  https_port: 8443
  
  # SSL配置
  server:
    certificate: /etc/clickhouse-server/server.crt
    private_key: /etc/clickhouse-server/server.key
```

### 4.2 访问控制

```yaml
  # 访问控制配置
  access_control_path: /var/lib/clickhouse/access/
  
  # 查询安全
  query_log:
    log_query_settings: 0  # 生产环境关闭，避免记录敏感信息
    log_query_threads: 0   # 生产环境关闭
```

## 5. JSON优化配置 (json-optimization.yml)

### 5.1 JSON函数优化

```yaml
clickhouse:
  # JSON函数优化配置
  functions:
    json_extract_raw:
      max_nested_path_length: 100
    json_extract_string:
      max_nested_path_length: 100
```

### 5.2 JSON存储优化

```yaml
  # JSON存储优化
  merge_tree:
    min_bytes_for_wide_part: 0
    min_rows_for_wide_part: 0
    max_bytes_to_merge_at_max_space_in_pool: 107374182400  # 100GB
```

## 6. 系统参数优化

### 6.1 内核参数优化

```bash
# /etc/sysctl.conf
# 文件描述符限制
fs.file-max = 65536
fs.nr_open = 65536

# 网络参数优化
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 5000
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 1200
net.ipv4.tcp_max_tw_buckets = 5000

# 内存参数优化
vm.swappiness = 1
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
```

### 6.2 用户限制优化

```bash
# /etc/security/limits.conf
clickhouse soft nofile 65536
clickhouse hard nofile 65536
clickhouse soft nproc 32768
clickhouse hard nproc 32768
```

## 7. 监控配置

### 7.1 系统监控

```yaml
# Prometheus配置
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'clickhouse'
    static_configs:
      - targets: ['localhost:9116']
```

### 7.2 ClickHouse监控

```yaml
clickhouse:
  # 监控配置
  query_log:
    database: system
    table: query_log
    partition_by: toYYYYMM(event_date)
    flush_interval_milliseconds: 7500

  # 错误日志配置
  error_log:
    database: system
    table: error_log
    partition_by: toYYYYMM(event_date)
    flush_interval_milliseconds: 7500
```

## 8. 备份配置

### 8.1 自动备份

```bash
#!/bin/bash
# /opt/clickhouse/scripts/backup.sh

BACKUP_DIR="/opt/clickhouse/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="clickhouse_backup_$DATE"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 执行备份
clickhouse-client --query "BACKUP TABLE database_name.table_name TO '$BACKUP_DIR/$BACKUP_NAME'"

# 压缩备份
tar -czf "$BACKUP_DIR/${BACKUP_NAME}.tar.gz" -C "$BACKUP_DIR" "$BACKUP_NAME"

# 清理临时文件
rm -rf "$BACKUP_DIR/$BACKUP_NAME"

# 保留最近7天的备份
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete
```

## 9. 性能调优建议

### 9.1 内存调优

1. **合理分配内存**
   - 系统内存：4GB
   - ClickHouse内存：12GB
   - 预留内存：2GB

2. **缓存优化**
   - 未压缩缓存：6GB
   - 标记缓存：3GB
   - 查询缓存：512MB

### 9.2 CPU调优

1. **线程池配置**
   - 最大线程数：4
   - 插入线程数：4
   - 后台任务线程：4

2. **并发控制**
   - 最大并发查询：10
   - 异步插入：启用

### 9.3 存储调优

1. **合并策略**
   - 最大合并空间：100GB
   - 最小合并空间：50GB

2. **索引优化**
   - 索引粒度：8192
   - 压缩算法：LZ4

## 10. 故障排查

### 10.1 常见问题

1. **内存不足**
   ```bash
   # 检查内存使用
   free -h
   # 检查ClickHouse内存使用
   clickhouse-client --query "SELECT * FROM system.metrics WHERE metric LIKE '%memory%'"
   ```

2. **磁盘空间不足**
   ```bash
   # 检查磁盘使用
   df -h
   # 检查ClickHouse数据目录
   du -sh /var/lib/clickhouse/
   ```

3. **连接数过多**
   ```bash
   # 检查连接数
   clickhouse-client --query "SELECT * FROM system.processes"
   ```

### 10.2 性能诊断

```sql
-- 检查慢查询
SELECT 
    query,
    query_duration_ms,
    memory_usage,
    read_rows,
    read_bytes
FROM system.query_log 
WHERE query_duration_ms > 1000
ORDER BY query_duration_ms DESC
LIMIT 10;

-- 检查系统资源使用
SELECT 
    metric,
    value
FROM system.metrics
WHERE metric IN ('MemoryUsage', 'CPUUtilization', 'DiskUsage');
```

## 11. 部署检查清单

### 11.1 部署前检查

- [ ] 硬件配置满足要求
- [ ] 操作系统版本兼容
- [ ] 网络连接正常
- [ ] 存储空间充足

### 11.2 部署中检查

- [ ] ClickHouse服务启动成功
- [ ] 配置文件加载正确
- [ ] 端口监听正常
- [ ] 用户权限配置正确

### 11.3 部署后检查

- [ ] 服务可访问
- [ ] 查询性能正常
- [ ] 监控指标正常
- [ ] 备份功能正常

## 12. 维护建议

### 12.1 日常维护

1. **定期监控**
   - 系统资源使用情况
   - ClickHouse性能指标
   - 错误日志分析

2. **定期备份**
   - 每日自动备份
   - 备份文件验证
   - 恢复测试

3. **定期优化**
   - 查询性能分析
   - 索引优化
   - 存储空间清理

### 12.2 升级维护

1. **版本升级**
   - 备份重要数据
   - 测试新版本功能
   - 制定回滚方案

2. **配置更新**
   - 配置文件版本控制
   - 变更影响评估
   - 灰度发布策略

---

## 总结

本配置说明文档提供了ClickHouse传统服务器部署的完整配置指南，涵盖了从基础配置到高级优化的各个方面。通过合理的配置优化，可以充分发挥硬件性能，确保系统稳定运行和良好的查询性能。

建议在实际部署时，根据具体的硬件配置和业务需求对相关参数进行微调，以达到最佳的性能表现。 