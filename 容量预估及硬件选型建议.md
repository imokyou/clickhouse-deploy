# 容量预估及硬件选型建议

## 系统背景

**数据规模**: 每日500万条记录，年数据量约228GB  
**数据特征**: JSON列为主，简单键值对，最多3级嵌套  
**查询模式**: 单表JSON extract聚合查询，时间对比分析  
**性能要求**: 响应时间1秒内，10个并发查询  
**可用性要求**: 24/7高可用  

## 数据量分析

**计算依据**:

- 每日记录数: 500万条
- 数据容量: 16万条 = 20MB
- 每日数据量: (500万 ÷ 16万) × 20MB = 625MB/天
- 年数据量: 625MB × 365天 = **228GB/年**
- 压缩后存储: **80GB/年**（LZ4对于String类型的压缩比在3左右）[ClickHouse中的压缩](https://clickhouse.com/docs/zh/data-compression/compression-in-clickhouse)

## 硬件配置建议

### 🎯 推荐配置方案

#### 方案一：单分片多副本（高可用3节点集群）（推荐生产环境）

**每节点配置:**

```json
CPU: 4核
内存: 16GB 
存储: 150GB nvme ssd
网络: 1Gbps带宽，节点间延迟<2ms
```

**集群总资源:**

```json
总CPU: 12核
总内存: 48GB
总存储: 450GB
副本数: 3个（容忍1个节点故障）
```

#### 方案二：单分片单副本(单节点部署)（成本优化方案）

**节点配置:**

```json
CPU: 4核
内存: 16GB 
存储: 150GB nvme ssd
网络: 1Gbps带宽
```

### 📊 配置依据分析

#### 内存配置 (16GB)

- **基础需求**: 启动阶段数据量56GB，按ClickHouse官方1:30内存存储比需要2GB [内存与存储比率应该是多少？](https://clickhouse.com/docs/zh/guides/sizing-and-hardware-recommendations#what-should-the-memory-to-storage-ratio-be)
- **JSON处理**: JSON extract操作需要额外内存开销
- **查询缓存**: 分配1GB用于查询结果缓存
- **并发处理**: 启动阶段3-5个并发查询的内存需求
- **性能保障**: 确保热数据全部缓存，实现1秒内响应

#### CPU配置 (4核)

- **并发处理**: 启动阶段3-5个并发查询，每核处理1个查询
- **JSON计算**: JSON extract和聚合操作需要计算资源
- **压缩解压**: ClickHouse数据压缩解压需要CPU
- **最佳比例**: 符合官方推荐的4:1内存CPU比例

#### 存储配置 (150GB nvme ssd)

- **数据存储**: 启动阶段压缩后数据量20GB
- **系统预留**: 操作系统、日志、临时文件30GB
- **备份空间**: 本地备份预留30GB
- **扩展空间**: 支持到第6个月的数据增长预留
- **性能要求**: NVMe SSD确保高IOPS，满足1秒响应需求

## 部署架构建议

### 🏗️ 架构对比

| 配置项 | 单节点部署 | 3节点集群 |
|--------|------------|-----------|
| **成本** | 低 | 中等 |
| **可用性** | 一般 (单点故障) | 高 (容忍1节点故障) |
| **维护复杂度** | 简单 | 中等 |
| **扩展性** | 有限 | 良好 |
| **推荐场景** | 测试环境/预算紧张 | 生产环境 |

### 🎯 推荐部署架构

**选择3节点集群的理由:**

1. **满足24/7可用性要求**
2. **数据自动同步备份**
3. **负载分散，提升查询性能**
4. **便于后续扩展**

**架构图**:

  ```mermaid
  graph TD
      subgraph "ClickHouse Cluster (Single Shard, 3 Replicas)"
          direction LR
          node1[Node 1<br/>（Replica 1）]
          node2[Node 2<br/>（Replica 2）]
          node3[Node 3<br/>（Replica 3）]
      end

      subgraph "Coordination (ClickHouse Keeper)"
          direction LR
          keeper1[Keeper 1]
          keeper2[Keeper 2]
          keeper3[Keeper 3]
      end

      LB(Load Balancer) --> node1
      LB --> node2
      LB --> node3

      node1 <--> keeper1
      node2 <--> keeper2
      node3 <--> keeper3
      
      node1 -- Replication --> node2
      node2 -- Replication --> node3
      node3 -- Replication --> node1

      app[Application] -- Inserts & Queries --> LB
  ```

## 扩容规划

### 📈 扩容路径

#### 垂直扩容 (优先推荐)

1. **内存升级**: 16GB → 32GB → 64GB
2. **CPU升级**: 4核 → 8核 → 16核  
3. **存储升级**: 150GB → 300GB → 1TB NVMe
4. **网络升级**: 1Gbps → 10Gbps

#### 水平扩容

1. **增加副本**: 3节点 → 5节点
2. **添加分片**: 当数据量超过1TB时考虑
3. **读写分离**: 配置只读副本节点

### 🎯 扩容触发条件

| 指标 | 当前容量 | 扩容阈值 | 扩容方案 |
|------|----------|----------|----------|
| 内存使用率 | 16GB | >80% | 升级到32GB |
| CPU使用率 | 4核 | >70% | 升级到8核 |
| 存储空间 | 150GB | >80% | 升级到300GB |
| 查询延迟 | <1秒 | >5秒 | 增加副本/优化 |
| 并发数 | 5 | >15 | 增加节点 |

### 📅 阶段性扩容计划

| 时间点 | 数据量 | 升级触发 | 升级方案 |
|--------|--------|----------|----------|
| 第3个月 | 56GB | 存储使用率>70% | 存储扩容到300GB |
| 第6个月 | 112GB | 内存使用率>80% | 内存升级到32GB |
| 第9个月 | 168GB | CPU使用率>70% | CPU升级到8核 |
| 第12个月 | 228GB | 性能不达标 | 全面升级到生产配置 |

## 监控和运维

### 📊 关键监控指标

#### 系统级监控

- CPU使用率 (<70%)
- 内存使用率 (<80%)  
- 磁盘使用率 (<80%)
- 网络吞吐量
- 磁盘IOPS

#### ClickHouse监控

- 查询响应时间 (<1秒)
- 查询并发数 (<10)
- 副本同步状态
- 表压缩率
- 慢查询日志

## 参考文档

1. [ClickHouse 硬件和配置建议](https://clickhouse.com/docs/zh/guides/sizing-and-hardware-recommendations)
2. [ClickHouse中的压缩](https://clickhouse.com/docs/zh/data-compression/compression-in-clickhouse)