<clickhouse>
    <timezone>UTC</timezone>
    
    <!-- 日志配置优化 - 减少警告输出 -->
    <logger>
        <level>warning</level>  <!-- 从 warning 改为 error，减少警告输出 -->
        <log_remove_reason>0</log_remove_reason>
        <system_logs_level>warning</system_logs_level>  <!-- 系统日志级别也改为 error -->

        <log>/var/log/clickhouse-server/clickhouse-server.log</log>
        <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>
        <size>1000M</size>
        <count>10</count>
        <console>0</console>
    </logger>

    <!-- 系统级优化配置 -->
    <system>
        <!-- 异步插入优化 - 使用更激进的设置减少临时目录创建 -->
        <async_insert_threads>8</async_insert_threads>  <!-- 减少线程数 -->
        <async_insert>1</async_insert>
        
        <!-- 系统表优化 -->
        <system_tables_cleanup_interval>3600</system_tables_cleanup_interval>  <!-- 减少清理频率 -->
        
        <!-- 临时文件优化 -->
        <tmp_path>/var/lib/clickhouse/tmp</tmp_path>
        <max_temporary_data_on_disk_size>0</max_temporary_data_on_disk_size>
        
        <!-- 启用系统日志 -->
        <metric_log_enabled>1</metric_log_enabled>  <!-- 启用指标日志 -->
        <asynchronous_metric_log_enabled>1</asynchronous_metric_log_enabled>  <!-- 启用异步指标日志 -->
        <query_log_enabled>1</query_log_enabled>  <!-- 启用查询日志 -->
        <text_log_enabled>1</text_log_enabled>  <!-- 启用文本日志 -->
        <trace_log_enabled>1</trace_log_enabled>  <!-- 启用跟踪日志 -->
        <processors_profile_log_enabled>1</processors_profile_log_enabled>  <!-- 启用处理器性能日志 -->
        <latency_log_enabled>1</latency_log_enabled>  <!-- 启用延迟日志 -->
        <error_log_enabled>1</error_log_enabled>  <!-- 启用错误日志 -->
    </system>

    <!-- Networking / Ports -->
    <listen_host>0.0.0.0</listen_host>
    <http_port>8123</http_port>
    <tcp_port>9000</tcp_port>
    <max_connections>4096</max_connections>
    <keep_alive_timeout>3</keep_alive_timeout>

    <!-- Concurrency limits (4-core CPU) -->
    <max_concurrent_queries>10</max_concurrent_queries>

    <!-- Memory and caches (16GB total) -->
    <max_server_memory_usage>12884901888</max_server_memory_usage> <!-- 12GB -->
    <uncompressed_cache_size>6442450944</uncompressed_cache_size>  <!-- 6GB -->
    <mark_cache_size>3221225472</mark_cache_size>                 <!-- 3GB -->

    <!-- MergeTree tuning (150GB NVMe) -->
    <merge_tree>
        <parts_to_delay_insert>150</parts_to_delay_insert>
        <parts_to_throw_insert>300</parts_to_throw_insert>
        <max_bytes_to_merge_at_max_space_in_pool>107374182400</max_bytes_to_merge_at_max_space_in_pool> <!-- 100GB -->
        <max_bytes_to_merge_at_min_space_in_pool>53687091200</max_bytes_to_merge_at_min_space_in_pool>  <!-- 50GB -->
        <index_granularity>8192</index_granularity>
        <index_granularity_bytes>0</index_granularity_bytes>
        <min_bytes_for_wide_part>0</min_bytes_for_wide_part>
        <min_rows_for_wide_part>0</min_rows_for_wide_part>
    </merge_tree>

    <!-- 性能优化配置 -->
    <performance>
        <!-- 减少后台任务频率 -->
        <background_pool_size>4</background_pool_size>  <!-- 减少后台线程池大小 -->
        <background_schedule_pool_size>4</background_schedule_pool_size>  <!-- 减少调度线程池大小 -->
    </performance>

    <!-- 错误处理和权限优化 -->
    <error_handling>
        <!-- 忽略文件权限错误 -->
        <ignore_file_permission_errors>1</ignore_file_permission_errors>
        <!-- 减少错误重试次数 -->
        <max_retries_for_file_operations>1</max_retries_for_file_operations>
    </error_handling>

    <!-- 系统日志配置 - 如果启用的话 -->
    <query_log>
        <database>system</database>
        <table>query_log</table>
        <partition_by>toYYYYMM(event_date)</partition_by>
        <flush_interval_milliseconds>30000</flush_interval_milliseconds>  <!-- 增加刷新间隔 -->
    </query_log>

    <query_thread_log>
        <database>system</database>
        <table>query_thread_log</table>
        <partition_by>toYYYYMM(event_date)</partition_by>
        <flush_interval_milliseconds>30000</flush_interval_milliseconds>  <!-- 增加刷新间隔 -->
    </query_thread_log>

    <text_log>
        <database>system</database>
        <table>text_log</table>
        <partition_by>toYYYYMM(event_date)</partition_by>
        <flush_interval_milliseconds>30000</flush_interval_milliseconds>  <!-- 增加刷新间隔 -->
    </text_log>

    <trace_log>
        <database>system</database>
        <table>trace_log</table>
        <partition_by>toYYYYMM(event_date)</partition_by>
        <flush_interval_milliseconds>30000</flush_interval_milliseconds>  <!-- 增加刷新间隔 -->
    </trace_log>

    <metric_log>
        <database>system</database>
        <table>metric_log</table>
        <flush_interval_milliseconds>30000</flush_interval_milliseconds>  <!-- 增加刷新间隔 -->
    </metric_log>

    <asynchronous_metric_log>
        <database>system</database>
        <table>asynchronous_metric_log</table>
        <flush_interval_milliseconds>30000</flush_interval_milliseconds>  <!-- 增加刷新间隔 -->
    </asynchronous_metric_log>

    <!-- 系统表 TTL 配置 - 减少数据量以降低警告频率 -->
    <system_tables_ttl>
        <!-- 异步指标日志保留1天 -->
        <asynchronous_metric_log>
            <ttl>event_time + INTERVAL 1 DAY</ttl>
        </asynchronous_metric_log>
        
        <!-- 查询日志保留6小时 -->
        <query_log>
            <ttl>event_time + INTERVAL 6 HOUR</ttl>
        </query_log>
        
        <!-- 文本日志保留6小时 -->
        <text_log>
            <ttl>event_time + INTERVAL 6 HOUR</ttl>
        </text_log>
        
        <!-- 延迟日志保留6小时 -->
        <latency_log>
            <ttl>event_time + INTERVAL 6 HOUR</ttl>
        </latency_log>
        
        <!-- 处理器性能日志保留6小时 -->
        <processors_profile_log>
            <ttl>event_time + INTERVAL 6 HOUR</ttl>
        </processors_profile_log>
        
        <!-- 跟踪日志保留6小时 -->
        <trace_log>
            <ttl>event_time + INTERVAL 6 HOUR</ttl>
        </trace_log>
        
        <!-- 指标日志保留1天 -->
        <metric_log>
            <ttl>event_time + INTERVAL 1 DAY</ttl>
        </metric_log>
    </system_tables_ttl>

    <remote_servers /> 
    
</clickhouse>