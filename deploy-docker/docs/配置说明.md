# ClickHouse 配置说明文档

## 概述

本文档详细说明ClickHouse Docker部署中的各个配置文件的作用、参数含义和配置建议。配置文件已根据硬件配置建议（4核CPU、16GB内存、150GB NVMe SSD）进行了全面优化，达到最佳实践标准。

## 🖥️ 硬件配置基准

| 组件 | 规格 | 优化重点 |
|------|------|----------|
| **CPU** | 4核 | 线程池优化、并发控制 |
| **内存** | 16GB | 缓存分配、内存限制 |
| **存储** | 150GB NVMe SSD | 合并策略、IO优化 |
| **网络** | 1Gbps | 连接池、超时设置 |

## 📊 配置优化说明

### 内存分配优化 (16GB总内存)

```json
总内存使用限制: 12GB (75%)
├── 查询内存限制: 12GB (75%)
├── 用户内存限制: 12GB (75%)
└── 缓存分配:
    ├── 未压缩缓存: 6GB (37.5%)
    └── 标记缓存: 3GB (18.75%)
```

### CPU线程优化 (4核CPU)

```json
最大线程数: 4 (1:1对应CPU核心)
插入线程数: 4
异步插入线程: 4
并发查询数: 10 (CPU核心数 × 2 + 2)
```

### 存储优化 (150GB NVMe SSD)

```json
最大合并空间: 100GB (67%)
最小合并空间: 50GB (33%)
索引粒度: 8192
```

## 配置文件结构

```json
deploy-docker/clickhouse/config/
├── config.d/
│   └── config.xml             # 主配置文件（基础配置、日志、网络、存储）
└── users.d/
    ├── default-user.xml       # 默认用户配置
    └── users.xml              # 用户配置文件（性能参数、资源限制）
```

## 1. Docker Compose 配置 (docker-compose.yml)

### 1.1 基础配置

```yaml
services:
  clickhouse-server:
    image: clickhouse/clickhouse-server:25.6
    container_name: clickhouse-server
    restart: unless-stopped
```

**参数说明：**

- `image`: ClickHouse官方镜像，版本25.6
- `container_name`: 容器名称
- `restart`: 重启策略，unless-stopped表示除非手动停止否则自动重启

### 1.2 端口配置

```yaml
ports:
  - "8123:8123"   # HTTP端口
  - "9000:9000"   # Native端口
```

**端口说明：**

- `8123`: HTTP接口端口，用于Web界面和HTTP API
- `9000`: Native协议端口，用于ClickHouse客户端连接

### 1.3 环境变量

```yaml
environment:
  - CLICKHOUSE_DB=default
  - CLICKHOUSE_USER=default
  - CLICKHOUSE_PASSWORD=clickhouse123
  - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
```

**环境变量说明：**

- `CLICKHOUSE_DB`: 默认数据库名
- `CLICKHOUSE_USER`: 默认用户名
- `CLICKHOUSE_PASSWORD`: 默认用户密码
- `CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT`: 启用访问管理

### 1.4 存储卷配置

```yaml
volumes:
  - ./clickhouse/config/config.d:/etc/clickhouse-server/config.d
  - ./clickhouse/config/users.d:/etc/clickhouse-server/users.d
  - ./clickhouse/data:/var/lib/clickhouse
  - ./clickhouse/logs:/var/log/clickhouse-server
```

**存储卷说明：**

- `config.d`: 主配置文件目录
- `users.d`: 用户配置文件目录
- `data`: 数据存储目录
- `logs`: 日志文件目录

### 1.5 资源限制

```yaml
ulimits:
  nofile:
    soft: 262144
    hard: 262144
```

**资源限制说明：**

- `nofile`: 文件描述符限制，提高并发连接数

### 1.6 健康检查

```yaml
healthcheck:
  test: ["CMD-SHELL", "clickhouse-client -u default --password clickhouse123 --query 'SELECT 1' || exit 1"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s
```

**健康检查说明：**

- `test`: 健康检查命令，使用clickhouse-client连接测试
- `interval`: 检查间隔时间
- `timeout`: 超时时间
- `retries`: 重试次数
- `start_period`: 启动等待时间

## 2. ClickHouse 主配置文件 (config.d/config.xml)

### 2.1 时区配置

```xml
<timezone>UTC</timezone>
```

**时区配置说明：**

- `timezone`: 设置为UTC时区，确保时间一致性

### 2.2 日志配置

```xml
<logger>
    <level>information</level>
    <log>/var/log/clickhouse-server/clickhouse-server.log</log>
    <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>
    <size>1000M</size>
    <count>10</count>
    <console>0</console>
</logger>
```

**日志配置说明：**

- `level`: 日志级别设为information，适合生产环境
- `log`: 普通日志文件路径
- `errorlog`: 错误日志文件路径
- `size`: 单个日志文件大小限制1000MB
- `count`: 保留的日志文件数量10个
- `console`: 关闭控制台输出

### 2.3 网络配置 - 根据4核CPU优化

```xml
<listen_host>0.0.0.0</listen_host>
<http_port>8123</http_port>
<tcp_port>9000</tcp_port>
<max_connections>4096</max_connections>
<keep_alive_timeout>3</keep_alive_timeout>
<max_concurrent_queries>10</max_concurrent_queries>
```

**网络配置说明：**

- `listen_host`: 监听所有IP地址
- `http_port`: HTTP服务端口8123
- `tcp_port`: Native协议端口9000
- `max_connections`: 最大连接数4096
- `keep_alive_timeout`: 连接保持超时时间3秒
- `max_concurrent_queries`: 最大并发查询数10（4核CPU建议值）

### 2.4 内存配置 - 根据16GB内存优化

```xml
<max_server_memory_usage>12884901888</max_server_memory_usage> <!-- 12GB -->
<uncompressed_cache_size>6442450944</uncompressed_cache_size>  <!-- 6GB -->
<mark_cache_size>3221225472</mark_cache_size>                 <!-- 3GB -->
```

**内存配置说明：**

- `max_server_memory_usage`: 服务器最大内存使用12GB（16GB的75%）
- `uncompressed_cache_size`: 未压缩数据缓存6GB（16GB的37.5%）
- `mark_cache_size`: 标记缓存3GB（16GB的18.75%）

### 2.5 合并树引擎配置 - 根据150GB存储优化

```xml
<merge_tree>
    <parts_to_delay_insert>150</parts_to_delay_insert>
    <parts_to_throw_insert>300</parts_to_throw_insert>
    <max_bytes_to_merge_at_max_space_in_pool>107374182400</max_bytes_to_merge_at_max_space_in_pool> <!-- 100GB -->
    <max_bytes_to_merge_at_min_space_in_pool>53687091200</max_bytes_to_merge_at_min_space_in_pool>  <!-- 50GB -->
    <index_granularity>8192</index_granularity>
    <index_granularity_bytes>0</index_granularity_bytes>
    <min_bytes_for_wide_part>0</min_bytes_for_wide_part>
    <min_rows_for_wide_part>0</min_rows_for_wide_part>
</merge_tree>
```

**合并树引擎配置说明：**

- `parts_to_delay_insert`: 延迟插入的部件数量150
- `parts_to_throw_insert`: 抛出插入的部件数量300
- `max_bytes_to_merge_at_max_space_in_pool`: 合并池最大字节数100GB（150GB的67%）
- `max_bytes_to_merge_at_min_space_in_pool`: 合并池最小字节数50GB（150GB的33%）
- `index_granularity`: 索引粒度8192
- `index_granularity_bytes`: 索引粒度字节数0
- `min_bytes_for_wide_part`: 宽部件最小字节数0
- `min_rows_for_wide_part`: 宽部件最小行数0

### 2.6 系统日志配置

#### 2.6.1 查询日志

```xml
<query_log>
    <database>system</database>
    <table>query_log</table>
    <partition_by>toYYYYMM(event_date)</partition_by>
    <flush_interval_milliseconds>7500</flush_interval_milliseconds>
</query_log>
```

#### 2.6.2 查询线程日志

```xml
<query_thread_log>
    <database>system</database>
    <table>query_thread_log</table>
    <partition_by>toYYYYMM(event_date)</partition_by>
    <flush_interval_milliseconds>7500</flush_interval_milliseconds>
</query_thread_log>
```

#### 2.6.3 文本日志

```xml
<text_log>
    <database>system</database>
    <table>text_log</table>
    <partition_by>toYYYYMM(event_date)</partition_by>
    <flush_interval_milliseconds>7500</flush_interval_milliseconds>
</text_log>
```

#### 2.6.4 慢查询日志

```xml
<trace_log>
    <database>system</database>
    <table>trace_log</table>
    <partition_by>toYYYYMM(event_date)</partition_by>
    <flush_interval_milliseconds>7500</flush_interval_milliseconds>
</trace_log>
```

#### 2.6.5 指标日志

```xml
<metric_log>
    <database>system</database>
    <table>metric_log</table>
    <flush_interval_milliseconds>7500</flush_interval_milliseconds>
</metric_log>
```

#### 2.6.6 异步指标日志

```xml
<asynchronous_metric_log>
    <database>system</database>
    <table>asynchronous_metric_log</table>
    <flush_interval_milliseconds>7500</flush_interval_milliseconds>
</asynchronous_metric_log>
```

**系统日志配置说明：**

- 所有日志表都存储在system数据库中
- 使用月分区策略（toYYYYMM）
- 刷新间隔设置为7.5秒

### 2.7 远程服务器配置

```xml
<remote_servers />
```

**远程服务器说明：**

- 当前为空配置，用于集群部署时扩展

## 3. 用户配置文件 (users.d/users.xml)

### 3.1 默认用户性能配置 - 根据4核CPU和16GB内存优化

```xml
<users>
    <default>
        <max_threads>4</max_threads>
        <max_insert_threads>4</max_insert_threads>
        <max_concurrent_queries>10</max_concurrent_queries>
        <max_memory_usage>12884901888</max_memory_usage>
        <max_memory_usage_for_user>12884901888</max_memory_usage_for_user>
        <max_memory_usage_for_all_queries>12884901888</max_memory_usage_for_all_queries>
        <max_memory_usage_for_user_for_all_queries>12884901888</max_memory_usage_for_user_for_all_queries>
    </default>
</users>
```

**性能配置说明：**

- `max_threads`: 最大线程数4（与CPU核心数匹配）
- `max_insert_threads`: 最大插入线程数4
- `max_concurrent_queries`: 最大并发查询数10
- `max_memory_usage`: 查询最大内存使用12GB
- `max_memory_usage_for_user`: 用户最大内存使用12GB
- `max_memory_usage_for_all_queries`: 所有查询最大内存使用12GB
- `max_memory_usage_for_user_for_all_queries`: 用户所有查询最大内存使用12GB

### 3.2 超时配置

```xml
<connect_timeout>10</connect_timeout>
<receive_timeout>300</receive_timeout>
<send_timeout>300</send_timeout>
```

**超时配置说明：**

- `connect_timeout`: 连接超时10秒
- `receive_timeout`: 接收超时300秒（5分钟）
- `send_timeout`: 发送超时300秒（5分钟）

### 3.3 异步插入配置

```xml
<async_insert>1</async_insert>
<async_insert_threads>4</async_insert_threads>
```

**异步插入说明：**

- `async_insert`: 启用异步插入
- `async_insert_threads`: 异步插入线程数4（与CPU核心数匹配）

## 4. 默认用户配置 (users.d/default-user.xml)

### 4.1 用户定义

```xml
<users>
    <!-- 移除默认用户 -->
    <default remove="remove">
    </default>

    <!-- 重新定义默认用户 -->
    <default>
        <profile>default</profile>
        <networks>
            <ip>::/0</ip>
        </networks>
        <password><![CDATA[clickhouse123]]></password>
        <quota>default</quota>
        <access_management>1</access_management>
    </default>
</users>
```

**用户配置说明：**

- 首先移除默认的default用户配置
- 重新定义default用户
- `profile`: 使用default配置文件
- `networks`: 允许所有IP访问（生产环境建议限制）
- `password`: 密码设置为clickhouse123
- `quota`: 使用default配额
- `access_management`: 启用访问管理

## 5. 生产环境部署建议

### 5.1 安全配置

1. **网络访问控制**

   ```xml
   <!-- 在 default-user.xml 中修改网络配置 -->
   <networks>
       <ip>192.168.1.0/24</ip>  <!-- 限制为内网IP段 -->
       <ip>10.0.0.0/8</ip>      <!-- 限制为内网IP段 -->
   </networks>
   ```

2. **强密码策略**
   - 修改默认密码clickhouse123为强密码
   - 密码应包含大小写字母、数字和特殊字符
   - 定期更换密码

3. **SSL/TLS 配置**
   - 在config.xml中添加HTTPS端口配置
   - 配置SSL证书和私钥

### 5.2 性能优化

1. **内存配置**
   - `max_server_memory_usage`: 建议设置为物理内存的75%（当前12GB）
   - `uncompressed_cache_size`: 建议设置为物理内存的37.5%（当前6GB）
   - `mark_cache_size`: 建议设置为物理内存的18.75%（当前3GB）

2. **CPU 配置**
   - `max_threads`: 建议设置为CPU核心数（当前4）
   - `max_insert_threads`: 建议设置为CPU核心数（当前4）
   - `max_concurrent_queries`: 建议设置为CPU核心数的2-3倍（当前10）

3. **存储配置**
   - 根据NVMe SSD特性优化合并树引擎参数
   - 启用异步插入提高写入性能
   - 设置合理的合并策略

### 5.3 监控配置

1. **日志监控**
   - 启用查询日志用于性能分析
   - 启用错误日志用于故障排查
   - 启用慢查询日志用于优化
   - 启用指标日志用于系统监控

2. **系统监控**
   - 监控内存使用情况
   - 监控CPU使用情况
   - 监控磁盘IO情况
   - 监控网络连接情况

### 5.4 备份策略

1. **配置文件备份**
   - 定期备份config.d和users.d目录
   - 版本控制配置文件变更
   - 测试配置恢复流程

2. **数据备份**
   - 定期备份data目录
   - 测试数据恢复流程
   - 验证备份完整性

## 6. 故障排查

### 6.1 日志分析

1. **系统日志**

   ```bash
   # 查看系统日志
   tail -f ./clickhouse/logs/clickhouse-server.log
   tail -f ./clickhouse/logs/clickhouse-server.err.log
   ```

2. **查询日志**

   ```sql
   -- 查看查询日志
   SELECT * FROM system.query_log ORDER BY event_time DESC LIMIT 100;
   
   -- 查看慢查询
   SELECT * FROM system.trace_log ORDER BY event_time DESC LIMIT 100;
   
   -- 查看指标日志
   SELECT * FROM system.metric_log ORDER BY event_time DESC LIMIT 100;
   ```

### 6.2 性能监控

1. **内存监控**

   ```sql
   -- 查看内存使用情况
   SELECT * FROM system.metrics WHERE metric LIKE '%memory%';
   
   -- 查看缓存使用情况
   SELECT * FROM system.metrics WHERE metric LIKE '%cache%';
   ```

2. **查询性能**

   ```sql
   -- 查看查询执行时间
   SELECT 
       query,
       query_duration_ms,
       memory_usage,
       read_rows,
       read_bytes
   FROM system.query_log 
   WHERE event_time >= now() - INTERVAL 1 HOUR
   ORDER BY query_duration_ms DESC;
   ```

### 6.3 常见问题

1. **内存不足**
   - 检查max_server_memory_usage设置
   - 调整缓存大小配置
   - 优化查询减少内存使用

2. **连接数过多**
   - 检查max_connections设置
   - 检查客户端连接池配置
   - 优化应用连接管理

3. **查询超时**
   - 检查超时时间设置
   - 优化查询语句
   - 检查索引使用情况

## 7. 配置验证

部署前请验证以下配置：

1. **安全配置**: 确保密码强度和网络访问控制符合要求
2. **资源限制**: 确认内存和CPU配置合理
3. **日志配置**: 确认日志级别和轮转策略合适
4. **监控配置**: 确认监控功能正常启用
5. **备份策略**: 确认备份和恢复流程完整

## 8. 总结

### 📁 配置文件清单

- **config.d/config.xml**: 主配置文件，包含基础配置、日志配置、网络配置、内存配置、存储配置和系统日志配置
- **users.d/users.xml**: 用户性能配置文件，包含线程数、内存限制、超时设置和异步插入配置

### 📊 配置优化重点

#### 主配置文件 (config.xml)

- 网络配置（端口、连接数、并发查询数）
- 内存配置（服务器内存、缓存分配）
- 存储配置（合并树引擎参数）
- 系统日志配置（查询日志、错误日志、慢查询日志）

#### 用户配置文件 (users.xml)

- 线程配置（最大线程数、插入线程数）
- 内存限制（查询内存、用户内存）
- 超时设置（连接、接收、发送超时）
- 异步插入配置

#### 用户定义文件 (default-user.xml)

- 用户认证（密码、网络访问）
- 权限配置（配置文件、配额、访问管理）

---

*本配置基于ClickHouse 25.6版本和硬件配置建议，适用于4核CPU、16GB内存、150GB NVMe SSD的硬件环境。所有配置参数已根据硬件规格进行优化，确保ClickHouse能够以最佳性能运行。*
