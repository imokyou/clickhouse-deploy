# ClickHouse 通用部署指南

## 概述

本指南提供在多种Linux发行版上部署ClickHouse的完整方案，包括手动部署和自动化部署两种方式。支持的操作系统包括：

- **RHEL 兼容发行版**: CentOS 7/8, RHEL 7/8/9, Rocky Linux, AlmaLinux
- **Ubuntu LTS**: Ubuntu 20.04+ LTS
- **Debian**: Debian 10, Debian 11

自动化部署可以大大节省部署时间，推荐在生产环境中使用。

## 系统要求

### 硬件要求

- **CPU**: 4核 (推荐8核)
- **内存**: 16GB (推荐32GB)
- **存储**: 150GB NVMe SSD (推荐300GB)
- **网络**: 1Gbps带宽

### 软件要求

- **操作系统**: 支持的操作系统版本
- **Docker**: 20.10.x 或更高版本
- **Docker Compose**: 2.x 或更高版本

## 支持的操作系统

### RHEL 兼容发行版

| 发行版 | 版本 | 状态 | 包管理器 |
|--------|------|------|----------|
| CentOS | 7.x, 8.x | ✅ 支持 | yum/dnf |
| RHEL | 7.x, 8.x, 9.x | ✅ 支持 | yum/dnf |
| Rocky Linux | 8.x, 9.x | ✅ 支持 | dnf |
| AlmaLinux | 8.x, 9.x | ✅ 支持 | dnf |
| Fedora | 35+ | ✅ 支持 | dnf |

### Ubuntu LTS / Debian

| 发行版 | 版本 | 状态 | 包管理器 |
|--------|------|------|----------|
| Ubuntu | 20.04 LTS, 22.04 LTS | ✅ 支持 | apt |
| Debian | 10, 11 | ✅ 支持 | apt |

## 部署方式选择

### 方式一：自动化部署（推荐）

**执行时间**: 5-10分钟
**适用场景**: 生产环境、快速部署

```bash
sudo ./scripts/auto-deploy.sh
```

### 方式二：手动部署

**执行时间**: 30-60分钟
**适用场景**: 学习、定制化部署

## 自动化部署

### 一键部署（最简单）

```bash
# 1. 下载项目文件
git clone <repository-url>
cd clickhouse/deploy-docker

# 2. 给脚本添加执行权限
chmod +x scripts/*.sh

# 3. 执行一键部署
sudo ./scripts/auto-deploy.sh
```

### 分步自动化部署

```bash
# 1. 安装Docker环境（如果未安装）
sudo ./scripts/install-docker.sh

# 2. 设置项目目录和配置文件
./scripts/setup-project.sh

# 3. 部署ClickHouse服务
./scripts/deploy.sh

# 4. 健康检查
./scripts/health-check.sh
```

### 自动化脚本说明

| 脚本名称 | 功能 | 执行时间 | 支持平台 |
|---------|------|----------|----------|
| `auto-deploy.sh` | 一键完成所有部署步骤 | 5-10分钟 | 全平台 |
| `install-docker.sh` | 安装Docker和Docker Compose | 3-5分钟 | 全平台 |
| `setup-project.sh` | 设置项目目录和配置文件 | 1-2分钟 | 全平台 |
| `deploy.sh` | 部署ClickHouse服务 | 2-3分钟 | 全平台 |
| `health-check.sh` | 健康检查和验证 | 30秒 | 全平台 |

## 手动部署

### 1. 系统环境准备

#### 1.1 系统更新

**Ubuntu/Debian 系统:**

```bash
# 更新系统包
sudo apt update && sudo apt upgrade -y

# 安装基础工具
sudo apt install -y wget curl git vim net-tools ca-certificates gnupg lsb-release
```

**RHEL 兼容系统:**

```bash
# 更新系统包
sudo yum update -y  # CentOS 7/RHEL 7
# 或
sudo dnf update -y  # CentOS 8+/RHEL 8+/Rocky Linux/AlmaLinux

# 安装基础工具
sudo yum install -y wget curl git vim net-tools  # CentOS 7/RHEL 7
# 或
sudo dnf install -y wget curl git vim net-tools  # CentOS 8+/RHEL 8+/Rocky Linux/AlmaLinux
```

#### 1.2 安装Docker

**Ubuntu/Debian 系统:**

```bash
# 卸载旧版本
sudo apt remove -y docker docker-engine docker.io containerd runc

# 安装依赖
sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release

# 添加Docker官方GPG密钥
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# 添加Docker仓库
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 更新包索引
sudo apt update

# 安装Docker
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
```

**RHEL 兼容系统:**

```bash
# 卸载旧版本
sudo yum remove -y docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine

# 安装依赖
sudo yum install -y yum-utils device-mapper-persistent-data lvm2

# 添加Docker仓库
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# 安装Docker
sudo yum install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
```

#### 1.3 启动Docker服务

```bash
# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker

# 验证安装
docker --version
docker compose --version

# 配置用户组
sudo groupadd docker 2>/dev/null || true
sudo usermod -aG docker $USER
```

### 2. 项目设置

#### 2.1 创建项目目录

```bash
# 创建部署目录
sudo mkdir -p /opt/clickhouse-deploy
sudo chown -R $USER:$USER /opt/clickhouse-deploy
cd /opt/clickhouse-deploy

# 创建目录结构
mkdir -p clickhouse/{config,logs,data}
mkdir -p scripts
mkdir -p docs
```

#### 2.2 复制配置文件

```bash
# 复制Docker Compose配置
cp /path/to/your/project/docker-compose.yml ./

# 复制ClickHouse配置文件
cp /path/to/your/project/clickhouse/config/*.yml clickhouse/config/

# 复制脚本文件
cp /path/to/your/project/scripts/*.sh scripts/
chmod +x scripts/*.sh

# 复制文档
cp /path/to/your/project/docs/*.md docs/
```

#### 2.3 设置权限

```bash
# 设置目录权限
chmod -R 755 /opt/clickhouse-deploy
chmod -R 777 clickhouse/logs
chmod -R 777 clickhouse/data
```

#### 2.4 配置防火墙

**firewalld (RHEL 兼容系统):**

```bash
sudo firewall-cmd --permanent --add-port=8123/tcp
sudo firewall-cmd --permanent --add-port=9000/tcp
sudo firewall-cmd --reload
```

**ufw (Ubuntu):**

```bash
sudo ufw allow 8123/tcp
sudo ufw allow 9000/tcp
```

**iptables:**

```bash
sudo iptables -A INPUT -p tcp --dport 8123 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 9000 -j ACCEPT
sudo iptables-save > /etc/iptables/rules.v4
```

### 3. 部署ClickHouse

#### 3.1 启动服务

```bash
# 启动ClickHouse服务
docker compose up -d

# 检查服务状态
docker compose ps
```

#### 3.2 验证部署

```bash
# 检查容器状态
docker compose ps

# 查看日志
docker compose logs -f clickhouse-server

# 测试连接
docker compose exec clickhouse-server clickhouse-client --query "SELECT version()"
```

## 平台特定说明

### Ubuntu LTS / Debian 系统

- 使用 `apt` 包管理器
- 默认使用 `ufw` 防火墙
- 系统服务管理使用 `systemd`

### RHEL 兼容系统

- 使用 `yum` (CentOS 7/RHEL 7) 或 `dnf` (CentOS 8+/RHEL 8+)
- 默认使用 `firewalld` 防火墙
- 系统服务管理使用 `systemd`

## 故障排查

### 常见问题

1. **Docker 安装失败**
   - 检查网络连接
   - 确认系统版本支持
   - 查看错误日志

2. **端口被占用**
   - 检查端口占用: `netstat -tlnp | grep :8123`
   - 修改配置文件中的端口

3. **权限问题**
   - 确保用户已加入 docker 组
   - 重新登录或执行 `newgrp docker`

4. **防火墙问题**
   - 检查防火墙状态
   - 确认端口已开放

### 日志查看

```bash
# 查看ClickHouse日志
docker compose logs -f clickhouse-server

# 查看系统日志
sudo journalctl -u docker

# 查看防火墙日志
sudo journalctl -u firewalld  # RHEL 兼容系统
sudo journalctl -u ufw         # Ubuntu 系统
```

## 性能优化建议

### 系统级优化

1. **内存优化**
   - 调整系统内存限制
   - 配置交换分区

2. **存储优化**
   - 使用SSD存储
   - 配置合适的文件系统

3. **网络优化**
   - 调整网络缓冲区
   - 配置合适的MTU

### ClickHouse 优化

1. **内存配置**
   - 根据系统内存调整配置
   - 优化查询缓存

2. **存储配置**
   - 配置合适的分区策略
   - 优化压缩设置

## 安全建议

1. **网络安全**
   - 配置防火墙规则
   - 使用VPN或专用网络

2. **访问控制**
   - 修改默认密码
   - 配置用户权限

3. **数据安全**
   - 定期备份数据
   - 加密敏感数据

## 监控和维护

### 监控指标

1. **系统指标**
   - CPU 使用率
   - 内存使用率
   - 磁盘使用率

2. **ClickHouse 指标**
   - 查询性能
   - 连接数
   - 存储使用情况

### 维护任务

1. **定期备份**
   - 数据备份
   - 配置文件备份

2. **日志管理**
   - 日志轮转
   - 日志清理

3. **性能调优**
   - 定期检查性能
   - 优化配置参数
