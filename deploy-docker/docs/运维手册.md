# ClickHouse è¿ç»´æ‰‹å†Œ

## æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›ClickHouse Dockeréƒ¨ç½²çš„è¿ç»´æ“ä½œæŒ‡å—ï¼ŒåŒ…æ‹¬æ—¥å¸¸ç»´æŠ¤ã€æ•…éšœæ’æŸ¥ã€æ€§èƒ½ä¼˜åŒ–ç­‰å†…å®¹ã€‚

## è„šæœ¬ä½¿ç”¨è¯´æ˜

æœ¬ç›®å½•åŒ…å«ç”¨äº ClickHouse Docker éƒ¨ç½²çš„å®Œæ•´è„šæœ¬é›†åˆï¼Œæ”¯æŒè‡ªåŠ¨åŒ–è¿ç»´ã€ç›‘æ§ã€å¤‡ä»½ç­‰åŠŸèƒ½ã€‚

### è„šæœ¬æ¦‚è§ˆ

#### ğŸš€ éƒ¨ç½²ç›¸å…³è„šæœ¬
- `auto-deploy.sh` - ä¸€é”®è‡ªåŠ¨éƒ¨ç½²è„šæœ¬
- `install-docker.sh` - Docker ç¯å¢ƒå®‰è£…è„šæœ¬
- `setup-project.sh` - é¡¹ç›®ç›®å½•å’Œé…ç½®æ–‡ä»¶è®¾ç½®
- `deploy.sh` - ClickHouse æœåŠ¡éƒ¨ç½²è„šæœ¬

#### ğŸ”§ ç®¡ç†å’Œç»´æŠ¤è„šæœ¬
- `health-check.sh` - å…¨é¢çš„å¥åº·æ£€æŸ¥è„šæœ¬
- `monitor.sh` - å®æ—¶ç›‘æ§è„šæœ¬
- `backup.sh` - æ•°æ®å¤‡ä»½è„šæœ¬
- `system-optimization.sh` - ç³»ç»Ÿçº§ä¼˜åŒ–è„šæœ¬

#### ğŸ§ª æµ‹è¯•å’ŒéªŒè¯è„šæœ¬
- `platform-test.sh` - å¹³å°å…¼å®¹æ€§æµ‹è¯•
- `test-users.sh` - ç”¨æˆ·é…ç½®æµ‹è¯•
- `test-docker-compose.sh` - Docker Compose å‘½ä»¤æµ‹è¯•

#### ğŸ” å®‰å…¨ç›¸å…³è„šæœ¬
- `generate-password-hash.sh` - å¯†ç å“ˆå¸Œç”Ÿæˆå·¥å…·

### ä½¿ç”¨æ–¹æ³•

#### 1. å¥åº·æ£€æŸ¥

##### åŸºæœ¬ä½¿ç”¨
```bash
# æ‰§è¡Œå¥åº·æ£€æŸ¥
./scripts/health-check.sh
```

##### é…ç½®è‡ªå®šä¹‰å‚æ•°
```bash
# å¤åˆ¶é…ç½®æ–‡ä»¶
cp scripts/monitor.conf.example scripts/health-check.conf

# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim scripts/health-check.conf

# æ‰§è¡Œå¥åº·æ£€æŸ¥
./scripts/health-check.sh
```

#### 2. ç›‘æ§

##### åŸºæœ¬ä½¿ç”¨
```bash
# å¯åŠ¨æŒç»­ç›‘æ§æ¨¡å¼
./scripts/monitor.sh

# æ‰§è¡Œå•æ¬¡æ£€æŸ¥
./scripts/monitor.sh --once

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
./scripts/monitor.sh --help
```

##### é…ç½®è‡ªå®šä¹‰å‚æ•°
```bash
# å¤åˆ¶é…ç½®æ–‡ä»¶
cp scripts/monitor.conf.example scripts/monitor.conf

# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim scripts/monitor.conf

# å¯åŠ¨ç›‘æ§
./scripts/monitor.sh
```

#### 3. å¤‡ä»½ç®¡ç†

##### åŸºæœ¬ä½¿ç”¨
```bash
# æ‰§è¡Œæ•°æ®å¤‡ä»½
./scripts/backup.sh
```

##### å¤‡ä»½åŠŸèƒ½ç‰¹æ€§
- å…¨é‡æ•°æ®åº“å¤‡ä»½
- é…ç½®æ–‡ä»¶å¤‡ä»½
- å¤‡ä»½ä¿¡æ¯è®°å½•
- è‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰

#### 4. ç³»ç»Ÿä¼˜åŒ–

##### åŸºæœ¬ä½¿ç”¨
```bash
# ç³»ç»Ÿçº§æ€§èƒ½ä¼˜åŒ–ï¼ˆéœ€è¦rootæƒé™ï¼‰
sudo ./scripts/system-optimization.sh
```

##### ä¼˜åŒ–åŠŸèƒ½ç‰¹æ€§
- ä¼˜åŒ–æ—¶é’Ÿæºé…ç½®
- å¯ç”¨å»¶è¿Ÿç»Ÿè®¡
- ä¼˜åŒ–æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
- ä¼˜åŒ–å†…æ ¸å‚æ•°ï¼ˆç½‘ç»œã€å†…å­˜ã€I/Oï¼‰

#### 5. å¹³å°æµ‹è¯•

##### åŸºæœ¬ä½¿ç”¨
```bash
# å¹³å°å…¼å®¹æ€§æµ‹è¯•
./scripts/platform-test.sh
```

##### æµ‹è¯•åŠŸèƒ½ç‰¹æ€§
- ç³»ç»Ÿç¯å¢ƒæ£€æµ‹
- Dockerç¯å¢ƒæµ‹è¯•
- ClickHouseåŠŸèƒ½æµ‹è¯•
- æ€§èƒ½åŸºå‡†æµ‹è¯•

#### 6. ç”¨æˆ·ç®¡ç†

##### åŸºæœ¬ä½¿ç”¨
```bash
# ç”¨æˆ·é…ç½®æµ‹è¯•
./scripts/test-users.sh
```

##### æµ‹è¯•åŠŸèƒ½ç‰¹æ€§
- æµ‹è¯•ç”¨æˆ·è¿æ¥
- éªŒè¯ç”¨æˆ·æƒé™
- æ˜¾ç¤ºæƒé™ä¿¡æ¯

#### 7. å¯†ç å®‰å…¨

##### åŸºæœ¬ä½¿ç”¨
```bash
# ç”Ÿæˆå®‰å…¨çš„å¯†ç å“ˆå¸Œ
./scripts/generate-password-hash.sh "your_password"

# äº¤äº’å¼è¾“å…¥å¯†ç 
./scripts/generate-password-hash.sh
```

##### å®‰å…¨åŠŸèƒ½ç‰¹æ€§
- ç”ŸæˆSHA256å¯†ç å“ˆå¸Œ
- æ”¯æŒå‘½ä»¤è¡Œå‚æ•°å’Œäº¤äº’å¼è¾“å…¥
- æä¾›é…ç½®ç¤ºä¾‹

### é…ç½®æ–‡ä»¶è¯´æ˜

#### å¥åº·æ£€æŸ¥é…ç½® (health-check.conf)

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `LOG_FILE` | æ—¥å¿—æ–‡ä»¶è·¯å¾„ | `/tmp/clickhouse-health-check.log` |
| `ALERT_EMAIL` | å‘Šè­¦é‚®ä»¶åœ°å€ | ç©º |
| `DOCKER_COMPOSE_FILE` | Docker Composeæ–‡ä»¶è·¯å¾„ | `docker-compose.yml` |
| `DEFAULT_USER` | æ•°æ®åº“ç”¨æˆ·å | `default` |
| `DEFAULT_PASSWORD` | æ•°æ®åº“å¯†ç  | `clickhouse123` |
| `HEALTH_CHECK_TIMEOUT` | å¥åº·æ£€æŸ¥è¶…æ—¶æ—¶é—´(ç§’) | `30` |
| `MAX_RETRIES` | æœ€å¤§é‡è¯•æ¬¡æ•° | `3` |
| `ALERT_THRESHOLD_MEMORY` | å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦é˜ˆå€¼(%) | `80` |
| `ALERT_THRESHOLD_CONNECTIONS` | è¿æ¥æ•°å‘Šè­¦é˜ˆå€¼ | `100` |
| `ALERT_THRESHOLD_DISK` | ç£ç›˜ä½¿ç”¨ç‡å‘Šè­¦é˜ˆå€¼(%) | `80` |
| `ALERT_THRESHOLD_SLOW_QUERIES` | æ…¢æŸ¥è¯¢å‘Šè­¦é˜ˆå€¼ | `10` |

#### ç›‘æ§é…ç½® (monitor.conf)

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `LOG_FILE` | æ—¥å¿—æ–‡ä»¶è·¯å¾„ | `/tmp/clickhouse-monitor.log` |
| `ALERT_EMAIL` | å‘Šè­¦é‚®ä»¶åœ°å€ | ç©º |
| `DOCKER_COMPOSE_FILE` | Docker Composeæ–‡ä»¶è·¯å¾„ | `docker-compose.yml` |
| `MONITOR_INTERVAL` | ç›‘æ§é—´éš”(ç§’) | `30` |
| `DEFAULT_USER` | æ•°æ®åº“ç”¨æˆ·å | `default` |
| `DEFAULT_PASSWORD` | æ•°æ®åº“å¯†ç  | `clickhouse123` |
| `ALERT_THRESHOLD_MEMORY` | å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦é˜ˆå€¼(%) | `80` |
| `ALERT_THRESHOLD_CONNECTIONS` | è¿æ¥æ•°å‘Šè­¦é˜ˆå€¼ | `100` |
| `ALERT_THRESHOLD_DISK` | ç£ç›˜ä½¿ç”¨ç‡å‘Šè­¦é˜ˆå€¼(%) | `80` |
| `ALERT_THRESHOLD_SLOW_QUERIES` | æ…¢æŸ¥è¯¢å‘Šè­¦é˜ˆå€¼ | `10` |

### æ£€æŸ¥é¡¹ç›®

#### å¥åº·æ£€æŸ¥é¡¹ç›®
1. **Docker Composeæ£€æŸ¥** - æ£€æŸ¥Docker Composeå‘½ä»¤å’Œæ–‡ä»¶
2. **æœåŠ¡çŠ¶æ€æ£€æŸ¥** - æ£€æŸ¥ClickHouseå®¹å™¨æ˜¯å¦è¿è¡Œ
3. **å®¹å™¨å¥åº·çŠ¶æ€æ£€æŸ¥** - æ£€æŸ¥å®¹å™¨å¥åº·çŠ¶æ€
4. **æ•°æ®åº“è¿æ¥æ£€æŸ¥** - æµ‹è¯•æ•°æ®åº“è¿æ¥
5. **ç‰ˆæœ¬ä¿¡æ¯æ£€æŸ¥** - è·å–ClickHouseç‰ˆæœ¬
6. **æ€§èƒ½æŒ‡æ ‡æ£€æŸ¥** - ç›‘æ§æŸ¥è¯¢æ•°é‡ã€æ…¢æŸ¥è¯¢ã€è¿æ¥æ•°ç­‰
7. **èµ„æºä½¿ç”¨æ£€æŸ¥** - ç›‘æ§å®¹å™¨å’ŒClickHouseå†…å­˜ä½¿ç”¨
8. **ç½‘ç»œè¿æ¥æ£€æŸ¥** - æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€
9. **ç³»ç»Ÿè¡¨æ£€æŸ¥** - éªŒè¯ç³»ç»Ÿè¡¨è®¿é—®
10. **ç£ç›˜ä½¿ç”¨æ£€æŸ¥** - ç›‘æ§ç£ç›˜ç©ºé—´ä½¿ç”¨

#### ç›‘æ§é¡¹ç›®
1. **æœåŠ¡çŠ¶æ€ç›‘æ§** - å®æ—¶ç›‘æ§å®¹å™¨çŠ¶æ€
2. **è¿æ¥çŠ¶æ€ç›‘æ§** - ç›‘æ§æ•°æ®åº“è¿æ¥
3. **æ€§èƒ½æŒ‡æ ‡ç›‘æ§** - ç›‘æ§æŸ¥è¯¢æ•°é‡ã€æ…¢æŸ¥è¯¢ã€è¿æ¥æ•°ç­‰
4. **èµ„æºä½¿ç”¨ç›‘æ§** - ç›‘æ§å®¹å™¨å’ŒClickHouseèµ„æºä½¿ç”¨
5. **æŸ¥è¯¢ç»Ÿè®¡** - ç»Ÿè®¡æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡
6. **è¡¨ä¿¡æ¯ç›‘æ§** - ç›‘æ§è¡¨å¤§å°å’Œè¡Œæ•°
7. **ç³»ç»ŸæŒ‡æ ‡ç›‘æ§** - ç›‘æ§ç³»ç»Ÿçº§æŒ‡æ ‡

### æ—¥å¿—å’Œå‘Šè­¦

#### æ—¥å¿—æ–‡ä»¶
- å¥åº·æ£€æŸ¥æ—¥å¿—ï¼š`/tmp/clickhouse-health-check.log`
- ç›‘æ§æ—¥å¿—ï¼š`/tmp/clickhouse-monitor.log`

#### å‘Šè­¦æœºåˆ¶
- æ”¯æŒé‚®ä»¶å‘Šè­¦ï¼ˆéœ€è¦é…ç½® `ALERT_EMAIL`ï¼‰
- å‘Šè­¦é˜ˆå€¼å¯é…ç½®
- è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶

### æ•…éšœæ’é™¤

#### å¸¸è§é—®é¢˜

1. **æƒé™é—®é¢˜**
   ```bash
   # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
   chmod +x scripts/*.sh
   ```

2. **Docker Composeé—®é¢˜**
   ```bash
   # æ£€æŸ¥Docker Composeæ˜¯å¦å®‰è£…
   docker-compose --version
   # æˆ–
   docker compose version
   ```

3. **é…ç½®æ–‡ä»¶é—®é¢˜**
   ```bash
   # æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
   bash -n scripts/health-check.conf
   bash -n scripts/monitor.conf
   ```

4. **å®¹å™¨è¿æ¥é—®é¢˜**
   ```bash
   # æµ‹è¯•å®¹å™¨è¿æ¥
   docker-compose exec clickhouse-server clickhouse-client -u default --password clickhouse123 --query "SELECT 1"
   ```

5. **å¹³å°å…¼å®¹æ€§é—®é¢˜**
   ```bash
   # è¿è¡Œå¹³å°æµ‹è¯•
   ./scripts/platform-test.sh
   ```

6. **ç”¨æˆ·é…ç½®é—®é¢˜**
   ```bash
   # æµ‹è¯•ç”¨æˆ·é…ç½®
   ./scripts/test-users.sh
   ```

#### è°ƒè¯•æ¨¡å¼
```bash
# å¯ç”¨è°ƒè¯•è¾“å‡º
bash -x scripts/health-check.sh
bash -x scripts/monitor.sh
bash -x scripts/backup.sh
```

### è‡ªåŠ¨åŒ–éƒ¨ç½²

#### å®šæ—¶ä»»åŠ¡
```bash
# ç¼–è¾‘ crontab
crontab -e

# æ·»åŠ å®šæ—¶å¥åº·æ£€æŸ¥ï¼ˆæ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰
0 * * * * /opt/clickhouse-deploy/scripts/health-check.sh

# æ·»åŠ å®šæ—¶ç›‘æ§ï¼ˆæ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼‰
*/5 * * * * /opt/clickhouse-deploy/scripts/monitor.sh --once

# æ·»åŠ å®šæ—¶å¤‡ä»½ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼‰
0 2 * * * /opt/clickhouse-deploy/scripts/backup.sh

# æ·»åŠ å®šæ—¶ç³»ç»Ÿä¼˜åŒ–æ£€æŸ¥ï¼ˆæ¯å‘¨æ‰§è¡Œä¸€æ¬¡ï¼‰
0 3 * * 0 /opt/clickhouse-deploy/scripts/system-optimization.sh

# æ·»åŠ å®šæ—¶å¹³å°æµ‹è¯•ï¼ˆæ¯å¤©æ‰§è¡Œä¸€æ¬¡ï¼‰
0 4 * * * /opt/clickhouse-deploy/scripts/platform-test.sh
```

#### Docker Composeé›†æˆ
```yaml
# åœ¨docker-compose.ymlä¸­æ·»åŠ ç›‘æ§æœåŠ¡
version: '3.8'
services:
  clickhouse-server:
    # ... ç°æœ‰é…ç½® ...
  
  clickhouse-monitor:
    image: alpine:latest
    volumes:
      - ./scripts:/scripts
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /scripts
    command: ["sh", "-c", "apk add --no-cache bash && ./monitor.sh --daemon"]
    depends_on:
      - clickhouse-server
```

### æ³¨æ„äº‹é¡¹

1. ç¡®ä¿Dockerå’ŒDocker Composeå·²æ­£ç¡®å®‰è£…
2. ç¡®ä¿ClickHouseå®¹å™¨æ­£å¸¸è¿è¡Œ
3. æ ¹æ®å®é™…ç¯å¢ƒè°ƒæ•´å‘Šè­¦é˜ˆå€¼
4. åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å»ºè®®é…ç½®é‚®ä»¶å‘Šè­¦
5. ç›‘æ§è„šæœ¬ä¼šæŒç»­è¿è¡Œï¼Œæ³¨æ„èµ„æºæ¶ˆè€—
6. ç¡®ä¿è„šæœ¬æœ‰è®¿é—®Docker socketçš„æƒé™

## 1. æ—¥å¸¸è¿ç»´æ“ä½œ

### 1.1 æœåŠ¡ç®¡ç†

#### å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨ClickHouseæœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps
```

#### åœæ­¢æœåŠ¡

```bash
# åœæ­¢ClickHouseæœåŠ¡
docker-compose down

# åœæ­¢å¹¶åˆ é™¤æ•°æ®å·
docker-compose down -v
```

#### é‡å¯æœåŠ¡

```bash
# é‡å¯ClickHouseæœåŠ¡
docker-compose restart

# é‡å¯ç‰¹å®šæœåŠ¡
docker-compose restart clickhouse
```

### 1.2 æ—¥å¿—ç®¡ç†

#### æŸ¥çœ‹å®æ—¶æ—¥å¿—

```bash
# æŸ¥çœ‹ClickHouseæ—¥å¿—
docker-compose logs -f clickhouse

# æŸ¥çœ‹æœ€è¿‘100è¡Œæ—¥å¿—
docker-compose logs --tail=100 clickhouse
```

#### æ—¥å¿—æ–‡ä»¶ä½ç½®

```bash
# å®¹å™¨å†…æ—¥å¿—è·¯å¾„
/var/log/clickhouse-server/

# å®¿ä¸»æœºæ—¥å¿—è·¯å¾„
./clickhouse/logs/
```

### 1.3 æ•°æ®ç®¡ç†

#### è¿æ¥æ•°æ®åº“

```bash
# ä½¿ç”¨Docker Composeè¿æ¥
docker-compose exec clickhouse clickhouse-client

# ä½¿ç”¨å¯†ç è¿æ¥
docker-compose exec clickhouse clickhouse-client --password=clickhouse123
```

#### æ•°æ®åº“æ“ä½œ

```sql
-- æŸ¥çœ‹æ•°æ®åº“åˆ—è¡¨
SHOW DATABASES;

-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE test_db;

-- åˆ é™¤æ•°æ®åº“
DROP DATABASE test_db;
```

### 1.4 å¤‡ä»½æ¢å¤

#### åˆ›å»ºå¤‡ä»½

```bash
# è¿è¡Œè‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬
./scripts/backup.sh

# æ‰‹åŠ¨å¤‡ä»½
docker-compose exec clickhouse clickhouse-client --query "
    BACKUP DATABASE default TO '/backup/default_backup'
"
```

#### å¤‡ä»½åŠŸèƒ½ç‰¹æ€§

- **å…¨é‡æ•°æ®åº“å¤‡ä»½**: è‡ªåŠ¨å¤‡ä»½æ‰€æœ‰ç”¨æˆ·æ•°æ®åº“
- **é…ç½®æ–‡ä»¶å¤‡ä»½**: å¤‡ä»½ClickHouseé…ç½®æ–‡ä»¶
- **å¤‡ä»½ä¿¡æ¯è®°å½•**: è®°å½•å¤‡ä»½æ—¶é—´ã€å¤§å°ã€ç‰ˆæœ¬ç­‰ä¿¡æ¯
- **è‡ªåŠ¨æ¸…ç†**: ä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½æ–‡ä»¶ï¼Œè‡ªåŠ¨åˆ é™¤æ—§å¤‡ä»½
- **å‹ç¼©å­˜å‚¨**: è‡ªåŠ¨å‹ç¼©å¤‡ä»½æ–‡ä»¶èŠ‚çœå­˜å‚¨ç©ºé—´

#### æ¢å¤æ•°æ®

```bash
# æ¢å¤æ•°æ®åº“
docker-compose exec clickhouse clickhouse-client --query "
    RESTORE DATABASE default FROM '/backup/default_backup'
"
```

#### å¤‡ä»½ç®¡ç†

```bash
# æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶
ls -lh /opt/clickhouse-deploy/backups/

# æŸ¥çœ‹å¤‡ä»½ä¿¡æ¯
cat /opt/clickhouse-deploy/backups/clickhouse_backup_YYYYMMDD_HHMMSS/backup_info.txt

# è®¾ç½®å®šæ—¶å¤‡ä»½
crontab -e
# æ·»åŠ : 0 2 * * * /opt/clickhouse-deploy/scripts/backup.sh
```

## 2. ç›‘æ§è¿ç»´

### 2.1 ç³»ç»Ÿç›‘æ§

#### è¿è¡Œç›‘æ§è„šæœ¬

```bash
# æ‰§è¡Œç›‘æ§æ£€æŸ¥
./scripts/monitor.sh

# å®šæ—¶ç›‘æ§ï¼ˆæ·»åŠ åˆ°crontabï¼‰
# æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ç›‘æ§
*/5 * * * * /opt/clickhouse-deploy/scripts/monitor.sh
```

#### æŸ¥çœ‹ç³»ç»Ÿèµ„æº

```bash
# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats clickhouse-server

# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
htop
df -h
free -h
```

### 2.2 ClickHouseç›‘æ§

#### æŸ¥çœ‹ç³»ç»Ÿè¡¨

```sql
-- æŸ¥çœ‹ç³»ç»ŸæŒ‡æ ‡
SELECT * FROM system.metrics;

-- æŸ¥çœ‹ç³»ç»Ÿäº‹ä»¶
SELECT * FROM system.events;

-- æŸ¥çœ‹å½“å‰è¿›ç¨‹
SELECT * FROM system.processes;

-- æŸ¥çœ‹æŸ¥è¯¢æ—¥å¿—
SELECT * FROM system.query_log ORDER BY event_time DESC LIMIT 10;
```

#### æ€§èƒ½ç›‘æ§æŸ¥è¯¢

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT 
    query,
    query_duration_ms,
    user,
    client_hostname
FROM system.query_log 
WHERE query_duration_ms > 1000
ORDER BY query_duration_ms DESC
LIMIT 10;

-- æŸ¥çœ‹å†…å­˜ä½¿ç”¨
SELECT 
    metric,
    value,
    description
FROM system.metrics 
WHERE metric LIKE '%Memory%';

-- æŸ¥çœ‹ç¼“å­˜å‘½ä¸­ç‡
SELECT 
    metric,
    value
FROM system.metrics 
WHERE metric IN ('MarkCacheHits', 'MarkCacheMisses');
```

## 3. ç›‘æ§å‘Šè­¦æœºåˆ¶

### 3.1 ç³»ç»Ÿç›‘æ§é…ç½®

#### 3.1.1 å®‰è£…ç›‘æ§å·¥å…·

```bash
# å®‰è£…ç³»ç»Ÿç›‘æ§å·¥å…·
sudo yum install -y htop iotop nethogs

# å®‰è£…ç½‘ç»œç›‘æ§å·¥å…·
sudo yum install -y iftop nload

# å®‰è£…æ—¥å¿—åˆ†æå·¥å…·
sudo yum install -y logwatch
```

#### 3.1.2 é…ç½®ç³»ç»Ÿç›‘æ§

```bash
# åˆ›å»ºç›‘æ§è„šæœ¬ç›®å½•
mkdir -p /opt/monitoring/scripts

# åˆ›å»ºç³»ç»Ÿèµ„æºç›‘æ§è„šæœ¬
cat > /opt/monitoring/scripts/system_monitor.sh << 'EOF'
#!/bin/bash
# ç³»ç»Ÿèµ„æºç›‘æ§è„šæœ¬

LOG_FILE="/opt/monitoring/logs/system_monitor.log"
ALERT_EMAIL="admin@example.com"

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p /opt/monitoring/logs

# è®°å½•ç›‘æ§æ•°æ®
echo "$(date '+%Y-%m-%d %H:%M:%S') - CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')%" >> $LOG_FILE
echo "$(date '+%Y-%m-%d %H:%M:%S') - Memory: $(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')%" >> $LOG_FILE
echo "$(date '+%Y-%m-%d %H:%M:%S') - Disk: $(df /opt/clickhouse-deploy | tail -1 | awk '{print $5}')" >> $LOG_FILE

# æ£€æŸ¥å‘Šè­¦æ¡ä»¶
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')
MEMORY_USAGE=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
DISK_USAGE=$(df /opt/clickhouse-deploy | tail -1 | awk '{print $5}' | sed 's/%//')

# CPUå‘Šè­¦
if (( $(echo "$CPU_USAGE > 80" | bc -l) )); then
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ALERT: CPU usage is ${CPU_USAGE}%" >> $LOG_FILE
fi

# å†…å­˜å‘Šè­¦
if (( $(echo "$MEMORY_USAGE > 85" | bc -l) )); then
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ALERT: Memory usage is ${MEMORY_USAGE}%" >> $LOG_FILE
fi

# ç£ç›˜å‘Šè­¦
if [ "$DISK_USAGE" -gt 85 ]; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ALERT: Disk usage is ${DISK_USAGE}%" >> $LOG_FILE
fi
EOF

chmod +x /opt/monitoring/scripts/system_monitor.sh
```

#### 3.1.3 è®¾ç½®å®šæ—¶ç›‘æ§

```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹ç›‘æ§ä»»åŠ¡
# æ¯5åˆ†é’Ÿæ‰§è¡Œç³»ç»Ÿç›‘æ§
*/5 * * * * /opt/monitoring/scripts/system_monitor.sh

# æ¯10åˆ†é’Ÿæ‰§è¡ŒClickHouseç›‘æ§
*/10 * * * * /opt/clickhouse-deploy/scripts/monitor.sh

# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå¤‡ä»½
0 2 * * * /opt/clickhouse-deploy/scripts/backup.sh
```

### 3.2 ClickHouseç›‘æ§é…ç½®

#### 3.2.1 å¯ç”¨æŸ¥è¯¢æ—¥å¿—

```yaml
# ç¼–è¾‘ clickhouse/config/config.yml
clickhouse:
  # æ·»åŠ æŸ¥è¯¢æ—¥å¿—é…ç½®
  query_log:
    database: system
    table: query_log
    partition_by: toYYYYMM(event_date)
    flush_interval_milliseconds: 7500
    log_query_settings: 1
    log_query_threads: 1
```

#### 3.2.2 åˆ›å»ºç›‘æ§è§†å›¾

```sql
-- è¿æ¥ClickHouseåæ‰§è¡Œ
-- åˆ›å»ºæ…¢æŸ¥è¯¢ç›‘æ§è§†å›¾
CREATE VIEW system.slow_queries AS
SELECT 
    query,
    query_duration_ms,
    user,
    client_hostname,
    event_time
FROM system.query_log 
WHERE query_duration_ms > 5000
ORDER BY query_duration_ms DESC;

-- åˆ›å»ºæ€§èƒ½ç›‘æ§è§†å›¾
CREATE VIEW system.performance_metrics AS
SELECT 
    metric,
    value,
    description
FROM system.metrics 
WHERE metric IN (
    'MemoryTracking',
    'MarkCacheHits',
    'MarkCacheMisses',
    'UncompressedCacheHits',
    'UncompressedCacheMisses'
);
```

#### 3.2.3 ç›‘æ§æŸ¥è¯¢ç¤ºä¾‹

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT 
    query,
    query_duration_ms,
    user,
    event_time
FROM system.query_log 
WHERE query_duration_ms > 1000
ORDER BY query_duration_ms DESC
LIMIT 10;

-- æŸ¥çœ‹å†…å­˜ä½¿ç”¨
SELECT 
    metric,
    value,
    description
FROM system.metrics 
WHERE metric LIKE '%Memory%';

-- æŸ¥çœ‹ç¼“å­˜å‘½ä¸­ç‡
SELECT 
    'Mark Cache Hit Rate' as metric,
    round(MarkCacheHits / (MarkCacheHits + MarkCacheMisses) * 100, 2) as hit_rate
FROM system.metrics 
WHERE metric IN ('MarkCacheHits', 'MarkCacheMisses');
```

### 3.3 å‘Šè­¦æœºåˆ¶

#### 3.3.1 é‚®ä»¶å‘Šè­¦é…ç½®

```bash
# å®‰è£…é‚®ä»¶å·¥å…·
sudo yum install -y mailx

# é…ç½®é‚®ä»¶æœåŠ¡ï¼ˆä»¥Gmailä¸ºä¾‹ï¼‰
sudo tee /etc/mail.rc << EOF
set from=your-email@gmail.com
set smtp=smtp.gmail.com:587
set smtp-use-starttls
set smtp-auth=login
set smtp-auth-user=your-email@gmail.com
set smtp-auth-password=your-app-password
EOF
```

#### 3.3.2 å‘Šè­¦è„šæœ¬

```bash
# åˆ›å»ºå‘Šè­¦è„šæœ¬
cat > /opt/monitoring/scripts/alert.sh << 'EOF'
#!/bin/bash
# å‘Šè­¦è„šæœ¬

ALERT_EMAIL="admin@example.com"
LOG_FILE="/opt/monitoring/logs/alert.log"

send_alert() {
    local subject="$1"
    local message="$2"
    
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $subject: $message" >> $LOG_FILE
    
    # å‘é€é‚®ä»¶å‘Šè­¦
    echo "$message" | mail -s "$subject" $ALERT_EMAIL
}

# æ£€æŸ¥ClickHouseæœåŠ¡çŠ¶æ€
if ! docker-compose ps | grep -q "clickhouse-server.*Up"; then
    send_alert "ClickHouse Service Alert" "ClickHouse service is down!"
fi

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
MEMORY_USAGE=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
if (( $(echo "$MEMORY_USAGE > 90" | bc -l) )); then
    send_alert "Memory Alert" "Memory usage is ${MEMORY_USAGE}%"
fi

# æ£€æŸ¥ç£ç›˜ä½¿ç”¨
DISK_USAGE=$(df /opt/clickhouse-deploy | tail -1 | awk '{print $5}' | sed 's/%//')
if [ "$DISK_USAGE" -gt 90 ]; then
    send_alert "Disk Alert" "Disk usage is ${DISK_USAGE}%"
fi
EOF

chmod +x /opt/monitoring/scripts/alert.sh
```

#### 3.3.3 è®¾ç½®å‘Šè­¦å®šæ—¶ä»»åŠ¡

```bash
# æ·»åŠ åˆ°crontab
# æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡å‘Šè­¦
*/5 * * * * /opt/monitoring/scripts/alert.sh
```

## 4. æ•°æ®å¤‡ä»½ç­–ç•¥

### 4.1 å¤‡ä»½ç­–ç•¥è®¾è®¡

#### 4.1.1 å¤‡ä»½ç±»å‹

- **å…¨é‡å¤‡ä»½**: æ¯å‘¨ä¸€å‡Œæ™¨æ‰§è¡Œï¼Œä¿ç•™4å‘¨
- **å®æ—¶å¤‡ä»½**: é‡è¦æ•°æ®å˜æ›´æ—¶ç«‹å³å¤‡ä»½

#### 4.1.2 å¤‡ä»½å­˜å‚¨ç­–ç•¥

```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•ç»“æ„
mkdir -p /opt/clickhouse-backup/{weekly}
mkdir -p /opt/clickhouse-backup/logs

# è®¾ç½®å¤‡ä»½ç›®å½•æƒé™
chmod 755 /opt/clickhouse-backup
chmod 755 /opt/clickhouse-backup/{weekly}
```

### 4.2 è‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬

#### 4.2.1 å¢å¼ºç‰ˆå¤‡ä»½è„šæœ¬

```bash
# åˆ›å»ºå¢å¼ºç‰ˆå¤‡ä»½è„šæœ¬
cat > /opt/clickhouse-deploy/scripts/enhanced_backup.sh << 'EOF'
#!/bin/bash
# å¢å¼ºç‰ˆClickHouseå¤‡ä»½è„šæœ¬

set -e

# é…ç½®å˜é‡
BACKUP_ROOT="/opt/clickhouse-backup"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="clickhouse_backup_$DATE"
RETENTION_WEEKS=4

# å¤‡ä»½ç±»å‹
BACKUP_TYPE=${1:-weekly}  # weekly

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_ROOT/{weekly,logs}

echo "=== ClickHouse å¢å¼ºå¤‡ä»½å¼€å§‹ ==="
echo "å¤‡ä»½æ—¶é—´: $(date)"
echo "å¤‡ä»½ç±»å‹: $BACKUP_TYPE"
echo "å¤‡ä»½ç›®å½•: $BACKUP_ROOT"

# æ£€æŸ¥ClickHouseå®¹å™¨æ˜¯å¦è¿è¡Œ
if ! docker-compose ps | grep -q "clickhouse-server.*Up"; then
    echo "é”™è¯¯: ClickHouseå®¹å™¨æœªè¿è¡Œ"
    exit 1
fi

# åˆ›å»ºå¤‡ä»½
echo "å¼€å§‹åˆ›å»ºå¤‡ä»½..."
docker-compose exec clickhouse clickhouse-client --query "
    BACKUP DATABASE default TO '$BACKUP_ROOT/$BACKUP_TYPE/$BACKUP_NAME'
"

# æ£€æŸ¥å¤‡ä»½æ˜¯å¦æˆåŠŸ
if [ $? -eq 0 ]; then
    echo "å¤‡ä»½åˆ›å»ºæˆåŠŸ: $BACKUP_ROOT/$BACKUP_TYPE/$BACKUP_NAME"
    
    # å‹ç¼©å¤‡ä»½æ–‡ä»¶
    echo "å‹ç¼©å¤‡ä»½æ–‡ä»¶..."
    cd $BACKUP_ROOT/$BACKUP_TYPE
    tar -czf "${BACKUP_NAME}.tar.gz" "$BACKUP_NAME"
    rm -rf "$BACKUP_NAME"
    
    echo "å¤‡ä»½å‹ç¼©å®Œæˆ: ${BACKUP_NAME}.tar.gz"
    
    # è®°å½•å¤‡ä»½æ—¥å¿—
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $BACKUP_TYPE backup completed: ${BACKUP_NAME}.tar.gz" >> $BACKUP_ROOT/logs/backup.log
    
    # æ¸…ç†æ—§å¤‡ä»½
    echo "æ¸…ç†æ—§å¤‡ä»½æ–‡ä»¶..."
    find $BACKUP_ROOT/weekly -name "*.tar.gz" -mtime +$((RETENTION_WEEKS * 7)) -delete
    
else
    echo "é”™è¯¯: å¤‡ä»½åˆ›å»ºå¤±è´¥"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $BACKUP_TYPE backup failed" >> $BACKUP_ROOT/logs/backup.log
    exit 1
fi

# æ˜¾ç¤ºå¤‡ä»½ç»Ÿè®¡
echo "=== å¤‡ä»½ç»Ÿè®¡ ==="
echo "å½“å‰å¤‡ä»½æ–‡ä»¶:"
ls -lh $BACKUP_ROOT/$BACKUP_TYPE/*.tar.gz 2>/dev/null || echo "æ— å¤‡ä»½æ–‡ä»¶"

echo "=== å¤‡ä»½å®Œæˆ ==="
EOF

chmod +x /opt/clickhouse-deploy/scripts/enhanced_backup.sh
```

#### 4.2.2 å¤‡ä»½æ¢å¤è„šæœ¬

```bash
# åˆ›å»ºå¤‡ä»½æ¢å¤è„šæœ¬
cat > /opt/clickhouse-deploy/scripts/restore.sh << 'EOF'
#!/bin/bash
# ClickHouseå¤‡ä»½æ¢å¤è„šæœ¬

set -e

BACKUP_ROOT="/opt/clickhouse-backup"
BACKUP_TYPE=${1:-weekly}
BACKUP_FILE=${2}

if [ -z "$BACKUP_FILE" ]; then
    echo "ç”¨æ³•: $0 <backup_type> <backup_file>"
    echo "ç¤ºä¾‹: $0 weekly clickhouse_backup_20231201_020000.tar.gz"
    exit 1
fi

BACKUP_PATH="$BACKUP_ROOT/$BACKUP_TYPE/$BACKUP_FILE"

if [ ! -f "$BACKUP_PATH" ]; then
    echo "é”™è¯¯: å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨: $BACKUP_PATH"
    exit 1
fi

echo "=== ClickHouse å¤‡ä»½æ¢å¤ ==="
echo "å¤‡ä»½æ–‡ä»¶: $BACKUP_PATH"

# åœæ­¢æœåŠ¡
echo "åœæ­¢ClickHouseæœåŠ¡..."
docker-compose down

# æ¸…ç†ç°æœ‰æ•°æ®
echo "æ¸…ç†ç°æœ‰æ•°æ®..."
sudo rm -rf clickhouse/data/*

# è§£å‹å¤‡ä»½æ–‡ä»¶
echo "è§£å‹å¤‡ä»½æ–‡ä»¶..."
cd $BACKUP_ROOT/$BACKUP_TYPE
tar -xzf "$BACKUP_FILE"

# æ¢å¤æ•°æ®
echo "æ¢å¤æ•°æ®..."
BACKUP_DIR=$(basename "$BACKUP_FILE" .tar.gz)
docker-compose up -d

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 30

# æ¢å¤æ•°æ®
echo "æ‰§è¡Œæ•°æ®æ¢å¤..."
docker-compose exec clickhouse clickhouse-client --query "
    RESTORE DATABASE default FROM '$BACKUP_ROOT/$BACKUP_TYPE/$BACKUP_DIR'
"

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -rf "$BACKUP_DIR"

echo "=== å¤‡ä»½æ¢å¤å®Œæˆ ==="
EOF

chmod +x /opt/clickhouse-deploy/scripts/restore.sh
```

### 4.3 å¤‡ä»½ç­–ç•¥å®æ–½

#### 4.3.1 è®¾ç½®å®šæ—¶å¤‡ä»½

```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹å¤‡ä»½ä»»åŠ¡
# æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹æ‰§è¡Œå…¨é‡å¤‡ä»½
0 2 * * 1 /opt/clickhouse-deploy/scripts/enhanced_backup.sh weekly
```

#### 4.3.2 å¤‡ä»½éªŒè¯è„šæœ¬

```bash
# åˆ›å»ºå¤‡ä»½éªŒè¯è„šæœ¬
cat > /opt/clickhouse-deploy/scripts/verify_backup.sh << 'EOF'
#!/bin/bash
# å¤‡ä»½éªŒè¯è„šæœ¬

BACKUP_ROOT="/opt/clickhouse-backup"
BACKUP_TYPE=${1:-weekly}

echo "=== å¤‡ä»½éªŒè¯ ==="
echo "æ£€æŸ¥ $BACKUP_TYPE å¤‡ä»½..."

# æ£€æŸ¥å¤‡ä»½æ–‡ä»¶
BACKUP_COUNT=$(find $BACKUP_ROOT/$BACKUP_TYPE -name "*.tar.gz" | wc -l)
echo "å¤‡ä»½æ–‡ä»¶æ•°é‡: $BACKUP_COUNT"

# æ£€æŸ¥æœ€æ–°å¤‡ä»½
LATEST_BACKUP=$(find $BACKUP_ROOT/$BACKUP_TYPE -name "*.tar.gz" -printf '%T@ %p\n' | sort -n | tail -1 | cut -f2- -d" ")
if [ -n "$LATEST_BACKUP" ]; then
    echo "æœ€æ–°å¤‡ä»½: $(basename $LATEST_BACKUP)"
    echo "å¤‡ä»½å¤§å°: $(du -h $LATEST_BACKUP | cut -f1)"
    echo "å¤‡ä»½æ—¶é—´: $(stat -c %y $LATEST_BACKUP)"
else
    echo "è­¦å‘Š: æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶"
fi

# æ£€æŸ¥å¤‡ä»½æ—¥å¿—
echo "æœ€è¿‘çš„å¤‡ä»½æ—¥å¿—:"
tail -5 $BACKUP_ROOT/logs/backup.log 2>/dev/null || echo "æ— å¤‡ä»½æ—¥å¿—"

echo "=== éªŒè¯å®Œæˆ ==="
EOF

chmod +x /opt/clickhouse-deploy/scripts/verify_backup.sh
```

### 4.4 å¤‡ä»½ç›‘æ§å’Œå‘Šè­¦

#### 4.4.1 å¤‡ä»½ç›‘æ§è„šæœ¬

```bash
# åˆ›å»ºå¤‡ä»½ç›‘æ§è„šæœ¬
cat > /opt/monitoring/scripts/backup_monitor.sh << 'EOF'
#!/bin/bash
# å¤‡ä»½ç›‘æ§è„šæœ¬

BACKUP_ROOT="/opt/clickhouse-backup"
ALERT_EMAIL="admin@example.com"

# æ£€æŸ¥æœ€è¿‘å¤‡ä»½
LATEST_BACKUP=$(find $BACKUP_ROOT/weekly -name "*.tar.gz" -printf '%T@ %p\n' 2>/dev/null | sort -n | tail -1 | cut -f2- -d" ")

if [ -z "$LATEST_BACKUP" ]; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ALERT: No backup found!" | mail -s "Backup Alert" $ALERT_EMAIL
    exit 1
fi

# æ£€æŸ¥å¤‡ä»½æ—¶é—´ï¼ˆè¶…è¿‡7å¤©å‘Šè­¦ï¼‰
BACKUP_TIME=$(stat -c %Y "$LATEST_BACKUP")
CURRENT_TIME=$(date +%s)
TIME_DIFF=$((CURRENT_TIME - BACKUP_TIME))

if [ $TIME_DIFF -gt 604800 ]; then  # 7å¤© = 604800ç§’
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ALERT: Backup is older than 7 days!" | mail -s "Backup Alert" $ALERT_EMAIL
fi

# æ£€æŸ¥å¤‡ä»½å¤§å°ï¼ˆå°äº1MBå‘Šè­¦ï¼‰
BACKUP_SIZE=$(stat -c %s "$LATEST_BACKUP")
if [ $BACKUP_SIZE -lt 1048576 ]; then  # 1MB = 1048576å­—èŠ‚
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ALERT: Backup size is too small!" | mail -s "Backup Alert" $ALERT_EMAIL
fi
EOF

chmod +x /opt/monitoring/scripts/backup_monitor.sh
```

#### 4.4.2 è®¾ç½®å¤‡ä»½ç›‘æ§å®šæ—¶ä»»åŠ¡

```bash
# æ·»åŠ åˆ°crontab
# æ¯å¤©æ£€æŸ¥ä¸€æ¬¡å¤‡ä»½çŠ¶æ€
0 8 * * * /opt/monitoring/scripts/backup_monitor.sh
```

### 4.5 å¤‡ä»½ç­–ç•¥æœ€ä½³å®è·µ

#### 4.5.1 å¤‡ä»½ç­–ç•¥å»ºè®®

- **RTO (Recovery Time Objective)**: ç›®æ ‡æ¢å¤æ—¶é—´ < 30åˆ†é’Ÿ
- **RPO (Recovery Point Objective)**: ç›®æ ‡æ¢å¤ç‚¹ < 1å‘¨
- **å¤‡ä»½ä¿ç•™æœŸ**: æ¯å‘¨å¤‡ä»½ä¿ç•™4å‘¨

#### 4.5.2 å¤‡ä»½æµ‹è¯•

```bash
# å®šæœŸæµ‹è¯•å¤‡ä»½æ¢å¤
# æ¯æœˆæµ‹è¯•ä¸€æ¬¡å¤‡ä»½æ¢å¤æµç¨‹
0 5 1 * * /opt/clickhouse-deploy/scripts/verify_backup.sh weekly
```

## 5. æ•…éšœæ’æŸ¥

### 5.1 å¸¸è§é—®é¢˜

#### é—®é¢˜1: å®¹å™¨å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶ï¼š**

- å®¹å™¨çŠ¶æ€ä¸ºExited
- æ— æ³•è®¿é—®ClickHouseæœåŠ¡

**æ’æŸ¥æ­¥éª¤ï¼š**

```bash
# 1. æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker-compose logs clickhouse

# 2. æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
docker-compose exec clickhouse clickhouse-server --config-file=/etc/clickhouse-server/config.xml --validate-config

# 3. æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep :8123
sudo netstat -tlnp | grep :9000

# 4. æ£€æŸ¥ç›®å½•æƒé™
ls -la clickhouse/data/
ls -la clickhouse/logs/
```

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# ä¿®å¤æƒé™é—®é¢˜
sudo chown -R 101:101 clickhouse/data
sudo chown -R 101:101 clickhouse/logs

# é‡æ–°å¯åŠ¨æœåŠ¡
docker-compose down
docker-compose up -d
```

#### é—®é¢˜2: å†…å­˜ä¸è¶³

**ç—‡çŠ¶ï¼š**

- æŸ¥è¯¢æ‰§è¡Œå¤±è´¥
- ç³»ç»Ÿå“åº”ç¼“æ…¢
- å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜

**æ’æŸ¥æ­¥éª¤ï¼š**

```bash
# 1. æ£€æŸ¥å†…å­˜ä½¿ç”¨
docker stats clickhouse-server
free -h

# 2. æŸ¥çœ‹ClickHouseå†…å­˜é…ç½®
docker-compose exec clickhouse clickhouse-client --query "
    SELECT name, value FROM system.settings 
    WHERE name LIKE '%memory%'
"
```

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# è°ƒæ•´å†…å­˜é…ç½®
# ç¼–è¾‘ users.xml æ–‡ä»¶ä¸­çš„å†…å­˜ç›¸å…³é…ç½®
# é‡å¯æœåŠ¡
docker-compose restart
```

#### é—®é¢˜3: ç£ç›˜ç©ºé—´ä¸è¶³

**ç—‡çŠ¶ï¼š**

- å†™å…¥æ“ä½œå¤±è´¥
- ç³»ç»Ÿå‘Šè­¦ç£ç›˜ç©ºé—´ä¸è¶³

**æ’æŸ¥æ­¥éª¤ï¼š**

```bash
# 1. æ£€æŸ¥ç£ç›˜ä½¿ç”¨
df -h
du -sh clickhouse/data/

# 2. æŸ¥çœ‹ClickHouseæ•°æ®å¤§å°
docker-compose exec clickhouse clickhouse-client --query "
    SELECT 
        database,
        table,
        formatReadableSize(sum(bytes)) as size
    FROM system.parts 
    WHERE active
    GROUP BY database, table
    ORDER BY sum(bytes) DESC
"
```

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# æ¸…ç†æ—§æ•°æ®
docker-compose exec clickhouse clickhouse-client --query "
    OPTIMIZE TABLE database.table FINAL
"

# åˆ é™¤è¿‡æœŸåˆ†åŒº
docker-compose exec clickhouse clickhouse-client --query "
    ALTER TABLE database.table DROP PARTITION '2023-01'
"
```

### 5.2 æ€§èƒ½é—®é¢˜æ’æŸ¥

#### æ…¢æŸ¥è¯¢åˆ†æ

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT 
    query,
    query_duration_ms,
    user,
    client_hostname,
    event_time
FROM system.query_log 
WHERE query_duration_ms > 5000
ORDER BY query_duration_ms DESC
LIMIT 20;

-- åˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT * FROM table WHERE condition;
```

#### èµ„æºä½¿ç”¨åˆ†æ

```sql
-- æŸ¥çœ‹è¡¨å¤§å°
SELECT 
    database,
    table,
    formatReadableSize(sum(bytes)) as size,
    sum(rows) as rows
FROM system.parts 
WHERE active
GROUP BY database, table
ORDER BY sum(bytes) DESC;

-- æŸ¥çœ‹åˆ†åŒºä¿¡æ¯
SELECT 
    database,
    table,
    partition,
    formatReadableSize(sum(bytes)) as size
FROM system.parts 
WHERE active
GROUP BY database, table, partition
ORDER BY sum(bytes) DESC;
```

## 6. æ€§èƒ½ä¼˜åŒ–

### 6.1 é…ç½®ä¼˜åŒ–

#### å†…å­˜ä¼˜åŒ–

```yaml
# æ ¹æ®æœåŠ¡å™¨å†…å­˜è°ƒæ•´
clickhouse:
  # å†…å­˜é…ç½®
  max_memory_usage: 12000000000
  max_memory_usage_for_user: 10000000000
  uncompressed_cache_size: 6442450944
  mark_cache_size: 3221225472
```

#### å¹¶å‘ä¼˜åŒ–

```yaml
# æ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´
clickhouse:
  # å¹¶å‘é…ç½®
  max_threads: 4
  max_insert_threads: 4
  max_concurrent_queries: 100
```

### 6.2 è¡¨ç»“æ„ä¼˜åŒ–

#### åˆ†åŒºç­–ç•¥

```sql
-- æŒ‰æ—¥æœŸåˆ†åŒº
CREATE TABLE events (
    event_date Date,
    event_time DateTime,
    user_id UInt32,
    event_type String
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(event_date)
ORDER BY (event_date, event_time);
```

#### ç´¢å¼•ä¼˜åŒ–

```sql
-- åˆ›å»ºè·³æ•°ç´¢å¼•
ALTER TABLE table ADD INDEX idx_user_id user_id TYPE minmax GRANULARITY 4;

-- åˆ›å»ºæŠ•å½±
ALTER TABLE table ADD PROJECTION proj_user_id (
    SELECT user_id, count()
    GROUP BY user_id
);
```

### 6.3 æŸ¥è¯¢ä¼˜åŒ–

#### æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§

```sql
-- ä½¿ç”¨PREWHEREä¼˜åŒ–
SELECT * FROM table PREWHERE user_id = 123 WHERE event_type = 'click';

-- ä½¿ç”¨LIMITä¼˜åŒ–
SELECT * FROM table WHERE condition LIMIT 1000;

-- ä½¿ç”¨é‡‡æ ·ä¼˜åŒ–
SELECT * FROM table SAMPLE 0.1 WHERE condition;
```

## 7. å®‰å…¨è¿ç»´

### 7.1 ç”¨æˆ·ç®¡ç†

#### åˆ›å»ºç”¨æˆ·

```sql
-- åˆ›å»ºåªè¯»ç”¨æˆ·
CREATE USER readonly IDENTIFIED BY 'readonly123';
GRANT SELECT ON *.* TO readonly;

-- åˆ›å»ºå†™å…¥ç”¨æˆ·
CREATE USER writer IDENTIFIED BY 'writer123';
GRANT INSERT, SELECT ON database.* TO writer;
```

#### æƒé™ç®¡ç†

```sql
-- æŸ¥çœ‹ç”¨æˆ·æƒé™
SHOW GRANTS FOR readonly;

-- æ’¤é”€æƒé™
REVOKE SELECT ON database.table FROM readonly;
```

### 7.2 ç½‘ç»œå®‰å…¨

#### é˜²ç«å¢™é…ç½®

```bash
# å¼€æ”¾ClickHouseç«¯å£
sudo firewall-cmd --permanent --add-port=8123/tcp
sudo firewall-cmd --permanent --add-port=9000/tcp
sudo firewall-cmd --reload

# é™åˆ¶è®¿é—®IP
sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="192.168.1.0/24" port protocol="tcp" port="8123" accept'
```

#### SSLé…ç½®

```yaml
# å¯ç”¨SSL
clickhouse:
  https_port: 8443
  certificate_file: /etc/clickhouse-server/server.crt
  private_key_file: /etc/clickhouse-server/server.key
```

### 7.3 Webç”¨æˆ·è®¿é—®é™åˆ¶ï¼ˆRBAC ç¤ºä¾‹ï¼‰

æœ¬èŠ‚ç»™å‡ºå®Œæ•´æ­¥éª¤ï¼šä»åˆ›å»º `webuser`ï¼Œåˆ°æœ€å°æƒé™æˆæƒä¸éªŒè¯ã€‚è‹¥ä½ çš„ `webuser` å·²åœ¨ `users.xml` ä¸­å­˜åœ¨ï¼Œå¯ä»â€œæ­¥éª¤2 è¿æ¥â€æˆ–â€œæ­¥éª¤3 åˆ›å»ºè§’è‰²ä¸æˆæƒâ€å¼€å§‹ã€‚

- æ­¥éª¤1 åˆ›å»ºï¼ˆæˆ–ç¡®è®¤ï¼‰ç”¨æˆ·

```sql
-- å¦‚éœ€é€šè¿‡SQLåˆ›å»ºç”¨æˆ·ï¼ˆè‹¥å·²åœ¨ users.xml ä¸­å®šä¹‰ï¼Œå¯è·³è¿‡ï¼‰
CREATE USER IF NOT EXISTS webuser IDENTIFIED BY 'WebUser_2024_Secure!';

-- å¯é€‰ï¼šå¦‚éœ€å¼ºåˆ¶åªè¯»ï¼ˆå°†ç¦æ­¢ INSERT/DDLï¼‰ï¼Œè¯·è°¨æ…ä½¿ç”¨
-- ALTER USER webuser SETTINGS readonly = 1;
```

- æ­¥éª¤2 è¿æ¥ï¼ˆä»¥ `admin` ç”¨æˆ·æ‰§è¡Œä»¥ä¸‹æˆæƒï¼‰

```bash
docker-compose exec clickhouse clickhouse-client -u admin --password 'Admin_2024_Secure!' --multiquery | cat
```

- æ­¥éª¤3 åˆ›å»ºè§’è‰²ä¸æˆæƒï¼ˆæœ€å°æƒé™ç¤ºä¾‹ï¼‰

```sql
-- è¯»æƒé™è§’è‰²ï¼šå…è®¸è¯»å– db_a ä¸ db_b ä¸‹æ‰€æœ‰è¡¨
CREATE ROLE IF NOT EXISTS r_web_ro;
GRANT SELECT ON db_a.* TO r_web_ro;
GRANT SELECT ON db_b.* TO r_web_ro;

-- å†™å…¥è§’è‰²ï¼šä»…å…è®¸å‘ db_a.events æ’å…¥ï¼Œå…¶ä½™ä»…å¯è¯»
CREATE ROLE IF NOT EXISTS r_web_events_ingest;
GRANT SELECT, INSERT ON db_a.events TO r_web_events_ingest;
```

- æ­¥éª¤4 æ¸…ç†é—ç•™çš„ç›´æ¥æƒé™ï¼ˆå¦‚æœä¹‹å‰ç»™è¿‡ `webuser` ç›´æˆæƒé™ï¼‰

```sql
REVOKE ALL ON *.* FROM USER webuser;
```

- æ­¥éª¤5 å°†è§’è‰²æˆäºˆ `webuser` å¹¶è®¾ä¸ºé»˜è®¤è§’è‰²

```sql
GRANT r_web_ro, r_web_events_ingest TO webuser;
SET DEFAULT ROLE r_web_ro, r_web_events_ingest TO webuser;
```

- æ­¥éª¤6 å…³é—­ `webuser` è‡ªä¸»æƒé™ç®¡ç†ï¼Œé¿å…è‡ªæˆ‘ææƒï¼ˆé…ç½®æ–¹å¼ï¼‰

```xml
<users>
  <!-- ... -->
  <webuser>
    <!-- ... -->
    <access_management>0</access_management>
  </webuser>
</users>
```

ä¿®æ”¹é…ç½®åå¯é€šè¿‡ä¸‹è¿°å‘½ä»¤ä½¿å…¶ç”Ÿæ•ˆï¼š

```sql
SYSTEM RELOAD CONFIG;
```

- å¯é€‰åŠ å›º

  - è¿›ä¸€æ­¥åªè¯»ï¼ˆå¦‚éœ€ï¼‰ï¼š

    ```sql
    ALTER USER webuser SETTINGS readonly = 1;
    ```

  - è¡Œçº§è®¿é—®æ§åˆ¶ç¤ºä¾‹ï¼ˆé’ˆå¯¹ç‰¹å®šè¡¨è¡Œåšç»†ç²’åº¦é™åˆ¶ï¼‰ï¼š

    ```sql
    CREATE ROW POLICY IF NOT EXISTS p_web_ro ON db_a.table1
    FOR SELECT USING user_id = 123 TO r_web_ro;
    ```

- éªŒè¯
  - å…è®¸ï¼š`SELECT` è®¿é—® `db_a.*`ã€`db_b.*`ï¼›å‘ `db_a.events` æ‰§è¡Œ `INSERT`
  - æ‹’ç»ï¼šå…¶ä»–åº“è¡¨è®¿é—®ä»¥åŠ `CREATE/ALTER/DROP/TRUNCATE` ç­‰ DDL

## 8. å‡çº§ç»´æŠ¤

### 8.1 ç‰ˆæœ¬å‡çº§

#### å‡çº§æ­¥éª¤

```bash
# 1. å¤‡ä»½æ•°æ®
./scripts/backup.sh

# 2. åœæ­¢æœåŠ¡
docker-compose down

# 3. æ›´æ–°é•œåƒç‰ˆæœ¬
# ç¼–è¾‘ docker-compose.yml ä¸­çš„é•œåƒç‰ˆæœ¬

# 4. é‡æ–°éƒ¨ç½²
docker-compose up -d

# 5. éªŒè¯å‡çº§
docker-compose exec clickhouse clickhouse-client --query "SELECT version()"
```

#### å‡çº§æ£€æŸ¥æ¸…å•

- [ ] æ•°æ®å¤‡ä»½å®Œæˆ
- [ ] é…ç½®æ–‡ä»¶å…¼å®¹æ€§æ£€æŸ¥
- [ ] æœåŠ¡å¯åŠ¨éªŒè¯
- [ ] åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡

### 8.2 ç»´æŠ¤è®¡åˆ’

#### æ—¥å¸¸ç»´æŠ¤

- [ ] æ¯æ—¥ç›‘æ§æ£€æŸ¥
- [ ] æ¯å‘¨å¤‡ä»½éªŒè¯
- [ ] æ¯æœˆæ€§èƒ½åˆ†æ
- [ ] æ¯å­£åº¦å®‰å…¨å®¡è®¡

#### å®šæœŸç»´æŠ¤

- [ ] æ¸…ç†è¿‡æœŸæ—¥å¿—
- [ ] ä¼˜åŒ–è¡¨ç»“æ„
- [ ] æ›´æ–°å®‰å…¨è¡¥ä¸
- [ ] å®¹é‡è§„åˆ’è¯„ä¼°

## 9. åº”æ€¥å“åº”

### 9.1 æœåŠ¡ä¸­æ–­å¤„ç†

#### ç«‹å³å“åº”

1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
3. è¯„ä¼°å½±å“èŒƒå›´
4. é€šçŸ¥ç›¸å…³äººå‘˜

#### æ¢å¤æ­¥éª¤

1. åœæ­¢é—®é¢˜æœåŠ¡
2. åˆ†ææ ¹æœ¬åŸå› 
3. å®æ–½ä¿®å¤æ–¹æ¡ˆ
4. éªŒè¯æœåŠ¡æ¢å¤
5. ç›‘æ§æœåŠ¡çŠ¶æ€

### 9.2 æ•°æ®æ¢å¤

#### æ•°æ®ä¸¢å¤±å¤„ç†

1. åœæ­¢å†™å…¥æ“ä½œ
2. è¯„ä¼°æ•°æ®ä¸¢å¤±èŒƒå›´
3. ä»å¤‡ä»½æ¢å¤æ•°æ®
4. éªŒè¯æ•°æ®å®Œæ•´æ€§
5. æ¢å¤æœåŠ¡è¿è¡Œ

## 10. æ–°å¢è„šæœ¬åŠŸèƒ½è¯¦è§£

### 10.1 ç³»ç»Ÿä¼˜åŒ–åŠŸèƒ½

#### ç³»ç»Ÿä¼˜åŒ–è„šæœ¬è¯¦è§£

`system-optimization.sh` è„šæœ¬æä¾›äº†å…¨é¢çš„ç³»ç»Ÿçº§æ€§èƒ½ä¼˜åŒ–ï¼š

```bash
# è¿è¡Œç³»ç»Ÿä¼˜åŒ–
sudo ./scripts/system-optimization.sh
```

**ä¼˜åŒ–å†…å®¹åŒ…æ‹¬ï¼š**

1. **æ—¶é’Ÿæºä¼˜åŒ–**
   - æ£€æµ‹å½“å‰æ—¶é’Ÿæº
   - å»ºè®®ä½¿ç”¨ tsc æ—¶é’Ÿæº
   - æä¾› GRUB é…ç½®å»ºè®®

2. **å»¶è¿Ÿç»Ÿè®¡å¯ç”¨**
   - ä¸´æ—¶å¯ç”¨å»¶è¿Ÿç»Ÿè®¡
   - æ°¸ä¹…é…ç½®åˆ° sysctl.conf

3. **æ–‡ä»¶æè¿°ç¬¦é™åˆ¶**
   - è®¾ç½®è½¯é™åˆ¶ä¸º 65536
   - è®¾ç½®ç¡¬é™åˆ¶ä¸º 65536

4. **å†…æ ¸å‚æ•°ä¼˜åŒ–**
   - ç½‘ç»œå‚æ•°ä¼˜åŒ–ï¼ˆsomaxconn, netdev_max_backlog, tcp_max_syn_backlogï¼‰
   - å†…å­˜å‚æ•°ä¼˜åŒ–ï¼ˆswappiness, dirty_ratio, dirty_background_ratioï¼‰
   - I/O å‚æ•°ä¼˜åŒ–ï¼ˆdirty_writeback_centisecs, dirty_expire_centisecsï¼‰

**æ³¨æ„äº‹é¡¹ï¼š**
- éœ€è¦ root æƒé™è¿è¡Œ
- éƒ¨åˆ†é…ç½®éœ€è¦é‡å¯ç³»ç»Ÿç”Ÿæ•ˆ
- å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯

### 10.2 å¹³å°å…¼å®¹æ€§æµ‹è¯•

#### å¹³å°æµ‹è¯•è„šæœ¬è¯¦è§£

`platform-test.sh` è„šæœ¬æä¾›å…¨é¢çš„å¹³å°å…¼å®¹æ€§æµ‹è¯•ï¼š

```bash
# è¿è¡Œå¹³å°æµ‹è¯•
./scripts/platform-test.sh
```

**æµ‹è¯•å†…å®¹åŒ…æ‹¬ï¼š**

1. **ç³»ç»Ÿç¯å¢ƒæ£€æµ‹**
   - æ“ä½œç³»ç»Ÿç±»å‹å’Œç‰ˆæœ¬
   - å†…æ ¸ç‰ˆæœ¬
   - ç³»ç»Ÿæ¶æ„
   - å†…å­˜å®¹é‡
   - ç£ç›˜ç©ºé—´

2. **Dockerç¯å¢ƒæµ‹è¯•**
   - Dockerç‰ˆæœ¬æ£€æŸ¥
   - Docker Composeç‰ˆæœ¬æ£€æŸ¥
   - DockeræœåŠ¡çŠ¶æ€
   - Dockeræƒé™éªŒè¯

3. **ClickHouseåŠŸèƒ½æµ‹è¯•**
   - æœåŠ¡å¯åŠ¨æµ‹è¯•
   - æ•°æ®åº“è¿æ¥æµ‹è¯•
   - åŸºæœ¬æŸ¥è¯¢æµ‹è¯•
   - æ€§èƒ½åŸºå‡†æµ‹è¯•

4. **ç½‘ç»œè¿æ¥æµ‹è¯•**
   - ç«¯å£ç›‘å¬çŠ¶æ€
   - ç½‘ç»œè¿é€šæ€§
   - é˜²ç«å¢™é…ç½®

### 10.3 ç”¨æˆ·ç®¡ç†å·¥å…·

#### ç”¨æˆ·æµ‹è¯•è„šæœ¬è¯¦è§£

`test-users.sh` è„šæœ¬ç”¨äºæµ‹è¯•ç”¨æˆ·é…ç½®å’Œæƒé™ï¼š

```bash
# è¿è¡Œç”¨æˆ·æµ‹è¯•
./scripts/test-users.sh
```

**æµ‹è¯•å†…å®¹åŒ…æ‹¬ï¼š**

1. **ç”¨æˆ·è¿æ¥æµ‹è¯•**
   - ç®¡ç†å‘˜ç”¨æˆ·è¿æ¥æµ‹è¯•
   - Webç”¨æˆ·è¿æ¥æµ‹è¯•
   - å¯†ç éªŒè¯

2. **æƒé™éªŒè¯**
   - ç”¨æˆ·æƒé™æŸ¥è¯¢
   - æƒé™ä¿¡æ¯æ˜¾ç¤º
   - æƒé™é…ç½®éªŒè¯

3. **å®‰å…¨é…ç½®æ£€æŸ¥**
   - ç”¨æˆ·é…ç½®å®Œæ•´æ€§
   - æƒé™è®¾ç½®åˆç†æ€§

### 10.4 å¯†ç å®‰å…¨å·¥å…·

#### å¯†ç å“ˆå¸Œç”Ÿæˆå·¥å…·è¯¦è§£

`generate-password-hash.sh` è„šæœ¬ç”¨äºç”Ÿæˆå®‰å…¨çš„å¯†ç å“ˆå¸Œï¼š

```bash
# å‘½ä»¤è¡Œå‚æ•°æ–¹å¼
./scripts/generate-password-hash.sh "your_secure_password"

# äº¤äº’å¼è¾“å…¥æ–¹å¼
./scripts/generate-password-hash.sh
```

**åŠŸèƒ½ç‰¹æ€§ï¼š**

1. **SHA256å“ˆå¸Œç”Ÿæˆ**
   - ä½¿ç”¨ SHA256 ç®—æ³•
   - ç”Ÿæˆåå…­è¿›åˆ¶å“ˆå¸Œå€¼

2. **å¤šç§è¾“å…¥æ–¹å¼**
   - æ”¯æŒå‘½ä»¤è¡Œå‚æ•°
   - æ”¯æŒäº¤äº’å¼è¾“å…¥
   - å¯†ç éšè—æ˜¾ç¤º

3. **é…ç½®ç¤ºä¾‹**
   - æä¾› users.xml é…ç½®ç¤ºä¾‹
   - ä¾¿äºç›´æ¥å¤åˆ¶ä½¿ç”¨

### 10.5 è‡ªåŠ¨åŒ–è¿ç»´é›†æˆ

#### å®šæ—¶ä»»åŠ¡é…ç½®

```bash
# ç¼–è¾‘ crontab
crontab -e

# å®Œæ•´çš„å®šæ—¶ä»»åŠ¡é…ç½®
# æ¯å°æ—¶å¥åº·æ£€æŸ¥
0 * * * * /opt/clickhouse-deploy/scripts/health-check.sh

# æ¯5åˆ†é’Ÿç›‘æ§æ£€æŸ¥
*/5 * * * * /opt/clickhouse-deploy/scripts/monitor.sh --once

# æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½
0 2 * * * /opt/clickhouse-deploy/scripts/backup.sh

# æ¯å‘¨ç³»ç»Ÿä¼˜åŒ–æ£€æŸ¥
0 3 * * 0 /opt/clickhouse-deploy/scripts/system-optimization.sh

# æ¯å¤©å¹³å°æµ‹è¯•
0 4 * * * /opt/clickhouse-deploy/scripts/platform-test.sh

# æ¯å¤©ç”¨æˆ·é…ç½®æµ‹è¯•
0 5 * * * /opt/clickhouse-deploy/scripts/test-users.sh
```

#### ç›‘æ§å‘Šè­¦é›†æˆ

```bash
# é…ç½®é‚®ä»¶å‘Šè­¦
# ç¼–è¾‘ monitor.conf æˆ– health-check.conf
ALERT_EMAIL="admin@example.com"

# é…ç½®å‘Šè­¦é˜ˆå€¼
ALERT_THRESHOLD_MEMORY=80
ALERT_THRESHOLD_CONNECTIONS=100
ALERT_THRESHOLD_DISK=80
ALERT_THRESHOLD_SLOW_QUERIES=10
```

## æ€»ç»“

æœ¬è¿ç»´æ‰‹å†Œæä¾›äº†ClickHouse Dockeréƒ¨ç½²çš„å®Œæ•´è¿ç»´æŒ‡å—ï¼ŒåŒ…æ‹¬æ–°å¢çš„è‡ªåŠ¨åŒ–è„šæœ¬åŠŸèƒ½ã€‚è¿ç»´äººå‘˜åº”ç†Ÿç»ƒæŒæ¡è¿™äº›æ“ä½œï¼Œç¡®ä¿ClickHouseæœåŠ¡çš„ç¨³å®šè¿è¡Œã€‚

### å…³é”®è¦ç‚¹ï¼š

1. **è‡ªåŠ¨åŒ–éƒ¨ç½²**: ä½¿ç”¨ä¸€é”®éƒ¨ç½²è„šæœ¬å¿«é€Ÿéƒ¨ç½²
2. **æ—¥å¸¸ç›‘æ§**: å®šæœŸæ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œç³»ç»Ÿèµ„æº
3. **å¤‡ä»½ç­–ç•¥**: å»ºç«‹å®Œå–„çš„æ•°æ®å¤‡ä»½å’Œæ¢å¤æœºåˆ¶
4. **ç³»ç»Ÿä¼˜åŒ–**: ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½
5. **å¹³å°æµ‹è¯•**: å®šæœŸè¿›è¡Œå…¼å®¹æ€§å’ŒåŠŸèƒ½æµ‹è¯•
6. **ç”¨æˆ·ç®¡ç†**: å®‰å…¨çš„ç”¨æˆ·é…ç½®å’Œæƒé™ç®¡ç†
7. **å®‰å…¨é˜²æŠ¤**: å®æ–½é€‚å½“çš„å®‰å…¨æªæ–½ä¿æŠ¤æ•°æ®å®‰å…¨
8. **åº”æ€¥å“åº”**: å»ºç«‹å¿«é€Ÿå“åº”æœºåˆ¶å¤„ç†çªå‘äº‹ä»¶

### è„šæœ¬ä½¿ç”¨å»ºè®®ï¼š

1. **ç”Ÿäº§ç¯å¢ƒ**: ä¼˜å…ˆä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼Œå‡å°‘äººå·¥æ“ä½œé”™è¯¯
2. **æµ‹è¯•ç¯å¢ƒ**: åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯è„šæœ¬åŠŸèƒ½
3. **å®šæœŸç»´æŠ¤**: å»ºç«‹å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ‰§è¡Œç»´æŠ¤æ“ä½œ
4. **ç›‘æ§å‘Šè­¦**: é…ç½®é‚®ä»¶å‘Šè­¦åŠæ—¶å‘ç°é—®é¢˜
5. **æ–‡æ¡£è®°å½•**: è®°å½•è„šæœ¬ä½¿ç”¨å’Œé…ç½®å˜æ›´
