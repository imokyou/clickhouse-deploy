# ClickHouse 运维手册

## 概述

本文档提供ClickHouse Docker部署的运维操作指南，包括日常维护、故障排查、性能优化等内容。

## 脚本使用说明

本目录包含用于 ClickHouse Docker 部署的完整脚本集合，支持自动化运维、监控、备份等功能。

### 脚本概览

#### 🚀 部署相关脚本
- `auto-deploy.sh` - 一键自动部署脚本
- `install-docker.sh` - Docker 环境安装脚本
- `setup-project.sh` - 项目目录和配置文件设置
- `deploy.sh` - ClickHouse 服务部署脚本

#### 🔧 管理和维护脚本
- `health-check.sh` - 全面的健康检查脚本
- `monitor.sh` - 实时监控脚本
- `backup.sh` - 数据备份脚本
- `system-optimization.sh` - 系统级优化脚本

#### 🧪 测试和验证脚本
- `platform-test.sh` - 平台兼容性测试
- `test-users.sh` - 用户配置测试
- `test-docker-compose.sh` - Docker Compose 命令测试

#### 🔐 安全相关脚本
- `generate-password-hash.sh` - 密码哈希生成工具

### 使用方法

#### 1. 健康检查

##### 基本使用
```bash
# 执行健康检查
./scripts/health-check.sh
```

##### 配置自定义参数
```bash
# 复制配置文件
cp scripts/monitor.conf.example scripts/health-check.conf

# 编辑配置文件
vim scripts/health-check.conf

# 执行健康检查
./scripts/health-check.sh
```

#### 2. 监控

##### 基本使用
```bash
# 启动持续监控模式
./scripts/monitor.sh

# 执行单次检查
./scripts/monitor.sh --once

# 显示帮助信息
./scripts/monitor.sh --help
```

##### 配置自定义参数
```bash
# 复制配置文件
cp scripts/monitor.conf.example scripts/monitor.conf

# 编辑配置文件
vim scripts/monitor.conf

# 启动监控
./scripts/monitor.sh
```

#### 3. 备份管理

##### 基本使用
```bash
# 执行数据备份
./scripts/backup.sh
```

##### 备份功能特性
- 全量数据库备份
- 配置文件备份
- 备份信息记录
- 自动清理旧备份（保留最近5个）

#### 4. 系统优化

##### 基本使用
```bash
# 系统级性能优化（需要root权限）
sudo ./scripts/system-optimization.sh
```

##### 优化功能特性
- 优化时钟源配置
- 启用延迟统计
- 优化文件描述符限制
- 优化内核参数（网络、内存、I/O）

#### 5. 平台测试

##### 基本使用
```bash
# 平台兼容性测试
./scripts/platform-test.sh
```

##### 测试功能特性
- 系统环境检测
- Docker环境测试
- ClickHouse功能测试
- 性能基准测试

#### 6. 用户管理

##### 基本使用
```bash
# 用户配置测试
./scripts/test-users.sh
```

##### 测试功能特性
- 测试用户连接
- 验证用户权限
- 显示权限信息

#### 7. 密码安全

##### 基本使用
```bash
# 生成安全的密码哈希
./scripts/generate-password-hash.sh "your_password"

# 交互式输入密码
./scripts/generate-password-hash.sh
```

##### 安全功能特性
- 生成SHA256密码哈希
- 支持命令行参数和交互式输入
- 提供配置示例

### 配置文件说明

#### 健康检查配置 (health-check.conf)

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `LOG_FILE` | 日志文件路径 | `/tmp/clickhouse-health-check.log` |
| `ALERT_EMAIL` | 告警邮件地址 | 空 |
| `DOCKER_COMPOSE_FILE` | Docker Compose文件路径 | `docker-compose.yml` |
| `DEFAULT_USER` | 数据库用户名 | `default` |
| `DEFAULT_PASSWORD` | 数据库密码 | `clickhouse123` |
| `HEALTH_CHECK_TIMEOUT` | 健康检查超时时间(秒) | `30` |
| `MAX_RETRIES` | 最大重试次数 | `3` |
| `ALERT_THRESHOLD_MEMORY` | 内存使用率告警阈值(%) | `80` |
| `ALERT_THRESHOLD_CONNECTIONS` | 连接数告警阈值 | `100` |
| `ALERT_THRESHOLD_DISK` | 磁盘使用率告警阈值(%) | `80` |
| `ALERT_THRESHOLD_SLOW_QUERIES` | 慢查询告警阈值 | `10` |

#### 监控配置 (monitor.conf)

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `LOG_FILE` | 日志文件路径 | `/tmp/clickhouse-monitor.log` |
| `ALERT_EMAIL` | 告警邮件地址 | 空 |
| `DOCKER_COMPOSE_FILE` | Docker Compose文件路径 | `docker-compose.yml` |
| `MONITOR_INTERVAL` | 监控间隔(秒) | `30` |
| `DEFAULT_USER` | 数据库用户名 | `default` |
| `DEFAULT_PASSWORD` | 数据库密码 | `clickhouse123` |
| `ALERT_THRESHOLD_MEMORY` | 内存使用率告警阈值(%) | `80` |
| `ALERT_THRESHOLD_CONNECTIONS` | 连接数告警阈值 | `100` |
| `ALERT_THRESHOLD_DISK` | 磁盘使用率告警阈值(%) | `80` |
| `ALERT_THRESHOLD_SLOW_QUERIES` | 慢查询告警阈值 | `10` |

### 检查项目

#### 健康检查项目
1. **Docker Compose检查** - 检查Docker Compose命令和文件
2. **服务状态检查** - 检查ClickHouse容器是否运行
3. **容器健康状态检查** - 检查容器健康状态
4. **数据库连接检查** - 测试数据库连接
5. **版本信息检查** - 获取ClickHouse版本
6. **性能指标检查** - 监控查询数量、慢查询、连接数等
7. **资源使用检查** - 监控容器和ClickHouse内存使用
8. **网络连接检查** - 检查端口监听状态
9. **系统表检查** - 验证系统表访问
10. **磁盘使用检查** - 监控磁盘空间使用

#### 监控项目
1. **服务状态监控** - 实时监控容器状态
2. **连接状态监控** - 监控数据库连接
3. **性能指标监控** - 监控查询数量、慢查询、连接数等
4. **资源使用监控** - 监控容器和ClickHouse资源使用
5. **查询统计** - 统计查询性能指标
6. **表信息监控** - 监控表大小和行数
7. **系统指标监控** - 监控系统级指标

### 日志和告警

#### 日志文件
- 健康检查日志：`/tmp/clickhouse-health-check.log`
- 监控日志：`/tmp/clickhouse-monitor.log`

#### 告警机制
- 支持邮件告警（需要配置 `ALERT_EMAIL`）
- 告警阈值可配置
- 自动清理临时文件

### 故障排除

#### 常见问题

1. **权限问题**
   ```bash
   # 确保脚本有执行权限
   chmod +x scripts/*.sh
   ```

2. **Docker Compose问题**
   ```bash
   # 检查Docker Compose是否安装
   docker-compose --version
   # 或
   docker compose version
   ```

3. **配置文件问题**
   ```bash
   # 检查配置文件语法
   bash -n scripts/health-check.conf
   bash -n scripts/monitor.conf
   ```

4. **容器连接问题**
   ```bash
   # 测试容器连接
   docker-compose exec clickhouse-server clickhouse-client -u default --password clickhouse123 --query "SELECT 1"
   ```

5. **平台兼容性问题**
   ```bash
   # 运行平台测试
   ./scripts/platform-test.sh
   ```

6. **用户配置问题**
   ```bash
   # 测试用户配置
   ./scripts/test-users.sh
   ```

#### 调试模式
```bash
# 启用调试输出
bash -x scripts/health-check.sh
bash -x scripts/monitor.sh
bash -x scripts/backup.sh
```

### 自动化部署

#### 定时任务
```bash
# 编辑 crontab
crontab -e

# 添加定时健康检查（每小时执行一次）
0 * * * * /opt/clickhouse-deploy/scripts/health-check.sh

# 添加定时监控（每5分钟执行一次）
*/5 * * * * /opt/clickhouse-deploy/scripts/monitor.sh --once

# 添加定时备份（每天凌晨2点执行）
0 2 * * * /opt/clickhouse-deploy/scripts/backup.sh

# 添加定时系统优化检查（每周执行一次）
0 3 * * 0 /opt/clickhouse-deploy/scripts/system-optimization.sh

# 添加定时平台测试（每天执行一次）
0 4 * * * /opt/clickhouse-deploy/scripts/platform-test.sh
```

#### Docker Compose集成
```yaml
# 在docker-compose.yml中添加监控服务
version: '3.8'
services:
  clickhouse-server:
    # ... 现有配置 ...
  
  clickhouse-monitor:
    image: alpine:latest
    volumes:
      - ./scripts:/scripts
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /scripts
    command: ["sh", "-c", "apk add --no-cache bash && ./monitor.sh --daemon"]
    depends_on:
      - clickhouse-server
```

### 注意事项

1. 确保Docker和Docker Compose已正确安装
2. 确保ClickHouse容器正常运行
3. 根据实际环境调整告警阈值
4. 在生产环境中建议配置邮件告警
5. 监控脚本会持续运行，注意资源消耗
6. 确保脚本有访问Docker socket的权限

## 1. 日常运维操作

### 1.1 服务管理

#### 启动服务

```bash
# 启动ClickHouse服务
docker-compose up -d

# 查看服务状态
docker-compose ps
```

#### 停止服务

```bash
# 停止ClickHouse服务
docker-compose down

# 停止并删除数据卷
docker-compose down -v
```

#### 重启服务

```bash
# 重启ClickHouse服务
docker-compose restart

# 重启特定服务
docker-compose restart clickhouse
```

### 1.2 日志管理

#### 查看实时日志

```bash
# 查看ClickHouse日志
docker-compose logs -f clickhouse

# 查看最近100行日志
docker-compose logs --tail=100 clickhouse
```

#### 日志文件位置

```bash
# 容器内日志路径
/var/log/clickhouse-server/

# 宿主机日志路径
./clickhouse/logs/
```

### 1.3 数据管理

#### 连接数据库

```bash
# 使用Docker Compose连接
docker-compose exec clickhouse clickhouse-client

# 使用密码连接
docker-compose exec clickhouse clickhouse-client --password=clickhouse123
```

#### 数据库操作

```sql
-- 查看数据库列表
SHOW DATABASES;

-- 创建数据库
CREATE DATABASE test_db;

-- 删除数据库
DROP DATABASE test_db;
```

### 1.4 备份恢复

#### 创建备份

```bash
# 运行自动化备份脚本
./scripts/backup.sh

# 手动备份
docker-compose exec clickhouse clickhouse-client --query "
    BACKUP DATABASE default TO '/backup/default_backup'
"
```

#### 备份功能特性

- **全量数据库备份**: 自动备份所有用户数据库
- **配置文件备份**: 备份ClickHouse配置文件
- **备份信息记录**: 记录备份时间、大小、版本等信息
- **自动清理**: 保留最近5个备份文件，自动删除旧备份
- **压缩存储**: 自动压缩备份文件节省存储空间

#### 恢复数据

```bash
# 恢复数据库
docker-compose exec clickhouse clickhouse-client --query "
    RESTORE DATABASE default FROM '/backup/default_backup'
"
```

#### 备份管理

```bash
# 查看备份文件
ls -lh /opt/clickhouse-deploy/backups/

# 查看备份信息
cat /opt/clickhouse-deploy/backups/clickhouse_backup_YYYYMMDD_HHMMSS/backup_info.txt

# 设置定时备份
crontab -e
# 添加: 0 2 * * * /opt/clickhouse-deploy/scripts/backup.sh
```

## 2. 监控运维

### 2.1 系统监控

#### 运行监控脚本

```bash
# 执行监控检查
./scripts/monitor.sh

# 定时监控（添加到crontab）
# 每5分钟执行一次监控
*/5 * * * * /opt/clickhouse-deploy/scripts/monitor.sh
```

#### 查看系统资源

```bash
# 查看容器资源使用
docker stats clickhouse-server

# 查看系统资源
htop
df -h
free -h
```

### 2.2 ClickHouse监控

#### 查看系统表

```sql
-- 查看系统指标
SELECT * FROM system.metrics;

-- 查看系统事件
SELECT * FROM system.events;

-- 查看当前进程
SELECT * FROM system.processes;

-- 查看查询日志
SELECT * FROM system.query_log ORDER BY event_time DESC LIMIT 10;
```

#### 性能监控查询

```sql
-- 查看慢查询
SELECT 
    query,
    query_duration_ms,
    user,
    client_hostname
FROM system.query_log 
WHERE query_duration_ms > 1000
ORDER BY query_duration_ms DESC
LIMIT 10;

-- 查看内存使用
SELECT 
    metric,
    value,
    description
FROM system.metrics 
WHERE metric LIKE '%Memory%';

-- 查看缓存命中率
SELECT 
    metric,
    value
FROM system.metrics 
WHERE metric IN ('MarkCacheHits', 'MarkCacheMisses');
```

## 3. 监控告警机制

### 3.1 系统监控配置

#### 3.1.1 安装监控工具

```bash
# 安装系统监控工具
sudo yum install -y htop iotop nethogs

# 安装网络监控工具
sudo yum install -y iftop nload

# 安装日志分析工具
sudo yum install -y logwatch
```

#### 3.1.2 配置系统监控

```bash
# 创建监控脚本目录
mkdir -p /opt/monitoring/scripts

# 创建系统资源监控脚本
cat > /opt/monitoring/scripts/system_monitor.sh << 'EOF'
#!/bin/bash
# 系统资源监控脚本

LOG_FILE="/opt/monitoring/logs/system_monitor.log"
ALERT_EMAIL="admin@example.com"

# 创建日志目录
mkdir -p /opt/monitoring/logs

# 记录监控数据
echo "$(date '+%Y-%m-%d %H:%M:%S') - CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')%" >> $LOG_FILE
echo "$(date '+%Y-%m-%d %H:%M:%S') - Memory: $(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')%" >> $LOG_FILE
echo "$(date '+%Y-%m-%d %H:%M:%S') - Disk: $(df /opt/clickhouse-deploy | tail -1 | awk '{print $5}')" >> $LOG_FILE

# 检查告警条件
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')
MEMORY_USAGE=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
DISK_USAGE=$(df /opt/clickhouse-deploy | tail -1 | awk '{print $5}' | sed 's/%//')

# CPU告警
if (( $(echo "$CPU_USAGE > 80" | bc -l) )); then
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ALERT: CPU usage is ${CPU_USAGE}%" >> $LOG_FILE
fi

# 内存告警
if (( $(echo "$MEMORY_USAGE > 85" | bc -l) )); then
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ALERT: Memory usage is ${MEMORY_USAGE}%" >> $LOG_FILE
fi

# 磁盘告警
if [ "$DISK_USAGE" -gt 85 ]; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ALERT: Disk usage is ${DISK_USAGE}%" >> $LOG_FILE
fi
EOF

chmod +x /opt/monitoring/scripts/system_monitor.sh
```

#### 3.1.3 设置定时监控

```bash
# 编辑crontab
crontab -e

# 添加以下监控任务
# 每5分钟执行系统监控
*/5 * * * * /opt/monitoring/scripts/system_monitor.sh

# 每10分钟执行ClickHouse监控
*/10 * * * * /opt/clickhouse-deploy/scripts/monitor.sh

# 每天凌晨2点执行备份
0 2 * * * /opt/clickhouse-deploy/scripts/backup.sh
```

### 3.2 ClickHouse监控配置

#### 3.2.1 启用查询日志

```yaml
# 编辑 clickhouse/config/config.yml
clickhouse:
  # 添加查询日志配置
  query_log:
    database: system
    table: query_log
    partition_by: toYYYYMM(event_date)
    flush_interval_milliseconds: 7500
    log_query_settings: 1
    log_query_threads: 1
```

#### 3.2.2 创建监控视图

```sql
-- 连接ClickHouse后执行
-- 创建慢查询监控视图
CREATE VIEW system.slow_queries AS
SELECT 
    query,
    query_duration_ms,
    user,
    client_hostname,
    event_time
FROM system.query_log 
WHERE query_duration_ms > 5000
ORDER BY query_duration_ms DESC;

-- 创建性能监控视图
CREATE VIEW system.performance_metrics AS
SELECT 
    metric,
    value,
    description
FROM system.metrics 
WHERE metric IN (
    'MemoryTracking',
    'MarkCacheHits',
    'MarkCacheMisses',
    'UncompressedCacheHits',
    'UncompressedCacheMisses'
);
```

#### 3.2.3 监控查询示例

```sql
-- 查看慢查询
SELECT 
    query,
    query_duration_ms,
    user,
    event_time
FROM system.query_log 
WHERE query_duration_ms > 1000
ORDER BY query_duration_ms DESC
LIMIT 10;

-- 查看内存使用
SELECT 
    metric,
    value,
    description
FROM system.metrics 
WHERE metric LIKE '%Memory%';

-- 查看缓存命中率
SELECT 
    'Mark Cache Hit Rate' as metric,
    round(MarkCacheHits / (MarkCacheHits + MarkCacheMisses) * 100, 2) as hit_rate
FROM system.metrics 
WHERE metric IN ('MarkCacheHits', 'MarkCacheMisses');
```

### 3.3 告警机制

#### 3.3.1 邮件告警配置

```bash
# 安装邮件工具
sudo yum install -y mailx

# 配置邮件服务（以Gmail为例）
sudo tee /etc/mail.rc << EOF
set from=your-email@gmail.com
set smtp=smtp.gmail.com:587
set smtp-use-starttls
set smtp-auth=login
set smtp-auth-user=your-email@gmail.com
set smtp-auth-password=your-app-password
EOF
```

#### 3.3.2 告警脚本

```bash
# 创建告警脚本
cat > /opt/monitoring/scripts/alert.sh << 'EOF'
#!/bin/bash
# 告警脚本

ALERT_EMAIL="admin@example.com"
LOG_FILE="/opt/monitoring/logs/alert.log"

send_alert() {
    local subject="$1"
    local message="$2"
    
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $subject: $message" >> $LOG_FILE
    
    # 发送邮件告警
    echo "$message" | mail -s "$subject" $ALERT_EMAIL
}

# 检查ClickHouse服务状态
if ! docker-compose ps | grep -q "clickhouse-server.*Up"; then
    send_alert "ClickHouse Service Alert" "ClickHouse service is down!"
fi

# 检查内存使用
MEMORY_USAGE=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
if (( $(echo "$MEMORY_USAGE > 90" | bc -l) )); then
    send_alert "Memory Alert" "Memory usage is ${MEMORY_USAGE}%"
fi

# 检查磁盘使用
DISK_USAGE=$(df /opt/clickhouse-deploy | tail -1 | awk '{print $5}' | sed 's/%//')
if [ "$DISK_USAGE" -gt 90 ]; then
    send_alert "Disk Alert" "Disk usage is ${DISK_USAGE}%"
fi
EOF

chmod +x /opt/monitoring/scripts/alert.sh
```

#### 3.3.3 设置告警定时任务

```bash
# 添加到crontab
# 每5分钟检查一次告警
*/5 * * * * /opt/monitoring/scripts/alert.sh
```

## 4. 数据备份策略

### 4.1 备份策略设计

#### 4.1.1 备份类型

- **全量备份**: 每周一凌晨执行，保留4周
- **实时备份**: 重要数据变更时立即备份

#### 4.1.2 备份存储策略

```bash
# 创建备份目录结构
mkdir -p /opt/clickhouse-backup/{weekly}
mkdir -p /opt/clickhouse-backup/logs

# 设置备份目录权限
chmod 755 /opt/clickhouse-backup
chmod 755 /opt/clickhouse-backup/{weekly}
```

### 4.2 自动化备份脚本

#### 4.2.1 增强版备份脚本

```bash
# 创建增强版备份脚本
cat > /opt/clickhouse-deploy/scripts/enhanced_backup.sh << 'EOF'
#!/bin/bash
# 增强版ClickHouse备份脚本

set -e

# 配置变量
BACKUP_ROOT="/opt/clickhouse-backup"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="clickhouse_backup_$DATE"
RETENTION_WEEKS=4

# 备份类型
BACKUP_TYPE=${1:-weekly}  # weekly

# 创建备份目录
mkdir -p $BACKUP_ROOT/{weekly,logs}

echo "=== ClickHouse 增强备份开始 ==="
echo "备份时间: $(date)"
echo "备份类型: $BACKUP_TYPE"
echo "备份目录: $BACKUP_ROOT"

# 检查ClickHouse容器是否运行
if ! docker-compose ps | grep -q "clickhouse-server.*Up"; then
    echo "错误: ClickHouse容器未运行"
    exit 1
fi

# 创建备份
echo "开始创建备份..."
docker-compose exec clickhouse clickhouse-client --query "
    BACKUP DATABASE default TO '$BACKUP_ROOT/$BACKUP_TYPE/$BACKUP_NAME'
"

# 检查备份是否成功
if [ $? -eq 0 ]; then
    echo "备份创建成功: $BACKUP_ROOT/$BACKUP_TYPE/$BACKUP_NAME"
    
    # 压缩备份文件
    echo "压缩备份文件..."
    cd $BACKUP_ROOT/$BACKUP_TYPE
    tar -czf "${BACKUP_NAME}.tar.gz" "$BACKUP_NAME"
    rm -rf "$BACKUP_NAME"
    
    echo "备份压缩完成: ${BACKUP_NAME}.tar.gz"
    
    # 记录备份日志
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $BACKUP_TYPE backup completed: ${BACKUP_NAME}.tar.gz" >> $BACKUP_ROOT/logs/backup.log
    
    # 清理旧备份
    echo "清理旧备份文件..."
    find $BACKUP_ROOT/weekly -name "*.tar.gz" -mtime +$((RETENTION_WEEKS * 7)) -delete
    
else
    echo "错误: 备份创建失败"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $BACKUP_TYPE backup failed" >> $BACKUP_ROOT/logs/backup.log
    exit 1
fi

# 显示备份统计
echo "=== 备份统计 ==="
echo "当前备份文件:"
ls -lh $BACKUP_ROOT/$BACKUP_TYPE/*.tar.gz 2>/dev/null || echo "无备份文件"

echo "=== 备份完成 ==="
EOF

chmod +x /opt/clickhouse-deploy/scripts/enhanced_backup.sh
```

#### 4.2.2 备份恢复脚本

```bash
# 创建备份恢复脚本
cat > /opt/clickhouse-deploy/scripts/restore.sh << 'EOF'
#!/bin/bash
# ClickHouse备份恢复脚本

set -e

BACKUP_ROOT="/opt/clickhouse-backup"
BACKUP_TYPE=${1:-weekly}
BACKUP_FILE=${2}

if [ -z "$BACKUP_FILE" ]; then
    echo "用法: $0 <backup_type> <backup_file>"
    echo "示例: $0 weekly clickhouse_backup_20231201_020000.tar.gz"
    exit 1
fi

BACKUP_PATH="$BACKUP_ROOT/$BACKUP_TYPE/$BACKUP_FILE"

if [ ! -f "$BACKUP_PATH" ]; then
    echo "错误: 备份文件不存在: $BACKUP_PATH"
    exit 1
fi

echo "=== ClickHouse 备份恢复 ==="
echo "备份文件: $BACKUP_PATH"

# 停止服务
echo "停止ClickHouse服务..."
docker-compose down

# 清理现有数据
echo "清理现有数据..."
sudo rm -rf clickhouse/data/*

# 解压备份文件
echo "解压备份文件..."
cd $BACKUP_ROOT/$BACKUP_TYPE
tar -xzf "$BACKUP_FILE"

# 恢复数据
echo "恢复数据..."
BACKUP_DIR=$(basename "$BACKUP_FILE" .tar.gz)
docker-compose up -d

# 等待服务启动
echo "等待服务启动..."
sleep 30

# 恢复数据
echo "执行数据恢复..."
docker-compose exec clickhouse clickhouse-client --query "
    RESTORE DATABASE default FROM '$BACKUP_ROOT/$BACKUP_TYPE/$BACKUP_DIR'
"

# 清理临时文件
rm -rf "$BACKUP_DIR"

echo "=== 备份恢复完成 ==="
EOF

chmod +x /opt/clickhouse-deploy/scripts/restore.sh
```

### 4.3 备份策略实施

#### 4.3.1 设置定时备份

```bash
# 编辑crontab
crontab -e

# 添加以下备份任务
# 每周一凌晨2点执行全量备份
0 2 * * 1 /opt/clickhouse-deploy/scripts/enhanced_backup.sh weekly
```

#### 4.3.2 备份验证脚本

```bash
# 创建备份验证脚本
cat > /opt/clickhouse-deploy/scripts/verify_backup.sh << 'EOF'
#!/bin/bash
# 备份验证脚本

BACKUP_ROOT="/opt/clickhouse-backup"
BACKUP_TYPE=${1:-weekly}

echo "=== 备份验证 ==="
echo "检查 $BACKUP_TYPE 备份..."

# 检查备份文件
BACKUP_COUNT=$(find $BACKUP_ROOT/$BACKUP_TYPE -name "*.tar.gz" | wc -l)
echo "备份文件数量: $BACKUP_COUNT"

# 检查最新备份
LATEST_BACKUP=$(find $BACKUP_ROOT/$BACKUP_TYPE -name "*.tar.gz" -printf '%T@ %p\n' | sort -n | tail -1 | cut -f2- -d" ")
if [ -n "$LATEST_BACKUP" ]; then
    echo "最新备份: $(basename $LATEST_BACKUP)"
    echo "备份大小: $(du -h $LATEST_BACKUP | cut -f1)"
    echo "备份时间: $(stat -c %y $LATEST_BACKUP)"
else
    echo "警告: 未找到备份文件"
fi

# 检查备份日志
echo "最近的备份日志:"
tail -5 $BACKUP_ROOT/logs/backup.log 2>/dev/null || echo "无备份日志"

echo "=== 验证完成 ==="
EOF

chmod +x /opt/clickhouse-deploy/scripts/verify_backup.sh
```

### 4.4 备份监控和告警

#### 4.4.1 备份监控脚本

```bash
# 创建备份监控脚本
cat > /opt/monitoring/scripts/backup_monitor.sh << 'EOF'
#!/bin/bash
# 备份监控脚本

BACKUP_ROOT="/opt/clickhouse-backup"
ALERT_EMAIL="admin@example.com"

# 检查最近备份
LATEST_BACKUP=$(find $BACKUP_ROOT/weekly -name "*.tar.gz" -printf '%T@ %p\n' 2>/dev/null | sort -n | tail -1 | cut -f2- -d" ")

if [ -z "$LATEST_BACKUP" ]; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ALERT: No backup found!" | mail -s "Backup Alert" $ALERT_EMAIL
    exit 1
fi

# 检查备份时间（超过7天告警）
BACKUP_TIME=$(stat -c %Y "$LATEST_BACKUP")
CURRENT_TIME=$(date +%s)
TIME_DIFF=$((CURRENT_TIME - BACKUP_TIME))

if [ $TIME_DIFF -gt 604800 ]; then  # 7天 = 604800秒
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ALERT: Backup is older than 7 days!" | mail -s "Backup Alert" $ALERT_EMAIL
fi

# 检查备份大小（小于1MB告警）
BACKUP_SIZE=$(stat -c %s "$LATEST_BACKUP")
if [ $BACKUP_SIZE -lt 1048576 ]; then  # 1MB = 1048576字节
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ALERT: Backup size is too small!" | mail -s "Backup Alert" $ALERT_EMAIL
fi
EOF

chmod +x /opt/monitoring/scripts/backup_monitor.sh
```

#### 4.4.2 设置备份监控定时任务

```bash
# 添加到crontab
# 每天检查一次备份状态
0 8 * * * /opt/monitoring/scripts/backup_monitor.sh
```

### 4.5 备份策略最佳实践

#### 4.5.1 备份策略建议

- **RTO (Recovery Time Objective)**: 目标恢复时间 < 30分钟
- **RPO (Recovery Point Objective)**: 目标恢复点 < 1周
- **备份保留期**: 每周备份保留4周

#### 4.5.2 备份测试

```bash
# 定期测试备份恢复
# 每月测试一次备份恢复流程
0 5 1 * * /opt/clickhouse-deploy/scripts/verify_backup.sh weekly
```

## 5. 故障排查

### 5.1 常见问题

#### 问题1: 容器启动失败

**症状：**

- 容器状态为Exited
- 无法访问ClickHouse服务

**排查步骤：**

```bash
# 1. 查看容器日志
docker-compose logs clickhouse

# 2. 检查配置文件语法
docker-compose exec clickhouse clickhouse-server --config-file=/etc/clickhouse-server/config.xml --validate-config

# 3. 检查端口占用
sudo netstat -tlnp | grep :8123
sudo netstat -tlnp | grep :9000

# 4. 检查目录权限
ls -la clickhouse/data/
ls -la clickhouse/logs/
```

**解决方案：**

```bash
# 修复权限问题
sudo chown -R 101:101 clickhouse/data
sudo chown -R 101:101 clickhouse/logs

# 重新启动服务
docker-compose down
docker-compose up -d
```

#### 问题2: 内存不足

**症状：**

- 查询执行失败
- 系统响应缓慢
- 内存使用率过高

**排查步骤：**

```bash
# 1. 检查内存使用
docker stats clickhouse-server
free -h

# 2. 查看ClickHouse内存配置
docker-compose exec clickhouse clickhouse-client --query "
    SELECT name, value FROM system.settings 
    WHERE name LIKE '%memory%'
"
```

**解决方案：**

```bash
# 调整内存配置
# 编辑 users.xml 文件中的内存相关配置
# 重启服务
docker-compose restart
```

#### 问题3: 磁盘空间不足

**症状：**

- 写入操作失败
- 系统告警磁盘空间不足

**排查步骤：**

```bash
# 1. 检查磁盘使用
df -h
du -sh clickhouse/data/

# 2. 查看ClickHouse数据大小
docker-compose exec clickhouse clickhouse-client --query "
    SELECT 
        database,
        table,
        formatReadableSize(sum(bytes)) as size
    FROM system.parts 
    WHERE active
    GROUP BY database, table
    ORDER BY sum(bytes) DESC
"
```

**解决方案：**

```bash
# 清理旧数据
docker-compose exec clickhouse clickhouse-client --query "
    OPTIMIZE TABLE database.table FINAL
"

# 删除过期分区
docker-compose exec clickhouse clickhouse-client --query "
    ALTER TABLE database.table DROP PARTITION '2023-01'
"
```

### 5.2 性能问题排查

#### 慢查询分析

```sql
-- 查看慢查询
SELECT 
    query,
    query_duration_ms,
    user,
    client_hostname,
    event_time
FROM system.query_log 
WHERE query_duration_ms > 5000
ORDER BY query_duration_ms DESC
LIMIT 20;

-- 分析查询执行计划
EXPLAIN SELECT * FROM table WHERE condition;
```

#### 资源使用分析

```sql
-- 查看表大小
SELECT 
    database,
    table,
    formatReadableSize(sum(bytes)) as size,
    sum(rows) as rows
FROM system.parts 
WHERE active
GROUP BY database, table
ORDER BY sum(bytes) DESC;

-- 查看分区信息
SELECT 
    database,
    table,
    partition,
    formatReadableSize(sum(bytes)) as size
FROM system.parts 
WHERE active
GROUP BY database, table, partition
ORDER BY sum(bytes) DESC;
```

## 6. 性能优化

### 6.1 配置优化

#### 内存优化

```yaml
# 根据服务器内存调整
clickhouse:
  # 内存配置
  max_memory_usage: 12000000000
  max_memory_usage_for_user: 10000000000
  uncompressed_cache_size: 6442450944
  mark_cache_size: 3221225472
```

#### 并发优化

```yaml
# 根据CPU核心数调整
clickhouse:
  # 并发配置
  max_threads: 4
  max_insert_threads: 4
  max_concurrent_queries: 100
```

### 6.2 表结构优化

#### 分区策略

```sql
-- 按日期分区
CREATE TABLE events (
    event_date Date,
    event_time DateTime,
    user_id UInt32,
    event_type String
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(event_date)
ORDER BY (event_date, event_time);
```

#### 索引优化

```sql
-- 创建跳数索引
ALTER TABLE table ADD INDEX idx_user_id user_id TYPE minmax GRANULARITY 4;

-- 创建投影
ALTER TABLE table ADD PROJECTION proj_user_id (
    SELECT user_id, count()
    GROUP BY user_id
);
```

### 6.3 查询优化

#### 查询优化技巧

```sql
-- 使用PREWHERE优化
SELECT * FROM table PREWHERE user_id = 123 WHERE event_type = 'click';

-- 使用LIMIT优化
SELECT * FROM table WHERE condition LIMIT 1000;

-- 使用采样优化
SELECT * FROM table SAMPLE 0.1 WHERE condition;
```

## 7. 安全运维

### 7.1 用户管理

#### 创建用户

```sql
-- 创建只读用户
CREATE USER readonly IDENTIFIED BY 'readonly123';
GRANT SELECT ON *.* TO readonly;

-- 创建写入用户
CREATE USER writer IDENTIFIED BY 'writer123';
GRANT INSERT, SELECT ON database.* TO writer;
```

#### 权限管理

```sql
-- 查看用户权限
SHOW GRANTS FOR readonly;

-- 撤销权限
REVOKE SELECT ON database.table FROM readonly;
```

### 7.2 网络安全

#### 防火墙配置

```bash
# 开放ClickHouse端口
sudo firewall-cmd --permanent --add-port=8123/tcp
sudo firewall-cmd --permanent --add-port=9000/tcp
sudo firewall-cmd --reload

# 限制访问IP
sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="192.168.1.0/24" port protocol="tcp" port="8123" accept'
```

#### SSL配置

```yaml
# 启用SSL
clickhouse:
  https_port: 8443
  certificate_file: /etc/clickhouse-server/server.crt
  private_key_file: /etc/clickhouse-server/server.key
```

### 7.3 Web用户访问限制（RBAC 示例）

本节给出完整步骤：从创建 `webuser`，到最小权限授权与验证。若你的 `webuser` 已在 `users.xml` 中存在，可从“步骤2 连接”或“步骤3 创建角色与授权”开始。

- 步骤1 创建（或确认）用户

```sql
-- 如需通过SQL创建用户（若已在 users.xml 中定义，可跳过）
CREATE USER IF NOT EXISTS webuser IDENTIFIED BY 'WebUser_2024_Secure!';

-- 可选：如需强制只读（将禁止 INSERT/DDL），请谨慎使用
-- ALTER USER webuser SETTINGS readonly = 1;
```

- 步骤2 连接（以 `admin` 用户执行以下授权）

```bash
docker-compose exec clickhouse clickhouse-client -u admin --password 'Admin_2024_Secure!' --multiquery | cat
```

- 步骤3 创建角色与授权（最小权限示例）

```sql
-- 读权限角色：允许读取 db_a 与 db_b 下所有表
CREATE ROLE IF NOT EXISTS r_web_ro;
GRANT SELECT ON db_a.* TO r_web_ro;
GRANT SELECT ON db_b.* TO r_web_ro;

-- 写入角色：仅允许向 db_a.events 插入，其余仅可读
CREATE ROLE IF NOT EXISTS r_web_events_ingest;
GRANT SELECT, INSERT ON db_a.events TO r_web_events_ingest;
```

- 步骤4 清理遗留的直接权限（如果之前给过 `webuser` 直授权限）

```sql
REVOKE ALL ON *.* FROM USER webuser;
```

- 步骤5 将角色授予 `webuser` 并设为默认角色

```sql
GRANT r_web_ro, r_web_events_ingest TO webuser;
SET DEFAULT ROLE r_web_ro, r_web_events_ingest TO webuser;
```

- 步骤6 关闭 `webuser` 自主权限管理，避免自我提权（配置方式）

```xml
<users>
  <!-- ... -->
  <webuser>
    <!-- ... -->
    <access_management>0</access_management>
  </webuser>
</users>
```

修改配置后可通过下述命令使其生效：

```sql
SYSTEM RELOAD CONFIG;
```

- 可选加固

  - 进一步只读（如需）：

    ```sql
    ALTER USER webuser SETTINGS readonly = 1;
    ```

  - 行级访问控制示例（针对特定表行做细粒度限制）：

    ```sql
    CREATE ROW POLICY IF NOT EXISTS p_web_ro ON db_a.table1
    FOR SELECT USING user_id = 123 TO r_web_ro;
    ```

- 验证
  - 允许：`SELECT` 访问 `db_a.*`、`db_b.*`；向 `db_a.events` 执行 `INSERT`
  - 拒绝：其他库表访问以及 `CREATE/ALTER/DROP/TRUNCATE` 等 DDL

## 8. 升级维护

### 8.1 版本升级

#### 升级步骤

```bash
# 1. 备份数据
./scripts/backup.sh

# 2. 停止服务
docker-compose down

# 3. 更新镜像版本
# 编辑 docker-compose.yml 中的镜像版本

# 4. 重新部署
docker-compose up -d

# 5. 验证升级
docker-compose exec clickhouse clickhouse-client --query "SELECT version()"
```

#### 升级检查清单

- [ ] 数据备份完成
- [ ] 配置文件兼容性检查
- [ ] 服务启动验证
- [ ] 功能测试通过
- [ ] 性能测试通过

### 8.2 维护计划

#### 日常维护

- [ ] 每日监控检查
- [ ] 每周备份验证
- [ ] 每月性能分析
- [ ] 每季度安全审计

#### 定期维护

- [ ] 清理过期日志
- [ ] 优化表结构
- [ ] 更新安全补丁
- [ ] 容量规划评估

## 9. 应急响应

### 9.1 服务中断处理

#### 立即响应

1. 检查服务状态
2. 查看错误日志
3. 评估影响范围
4. 通知相关人员

#### 恢复步骤

1. 停止问题服务
2. 分析根本原因
3. 实施修复方案
4. 验证服务恢复
5. 监控服务状态

### 9.2 数据恢复

#### 数据丢失处理

1. 停止写入操作
2. 评估数据丢失范围
3. 从备份恢复数据
4. 验证数据完整性
5. 恢复服务运行

## 10. 新增脚本功能详解

### 10.1 系统优化功能

#### 系统优化脚本详解

`system-optimization.sh` 脚本提供了全面的系统级性能优化：

```bash
# 运行系统优化
sudo ./scripts/system-optimization.sh
```

**优化内容包括：**

1. **时钟源优化**
   - 检测当前时钟源
   - 建议使用 tsc 时钟源
   - 提供 GRUB 配置建议

2. **延迟统计启用**
   - 临时启用延迟统计
   - 永久配置到 sysctl.conf

3. **文件描述符限制**
   - 设置软限制为 65536
   - 设置硬限制为 65536

4. **内核参数优化**
   - 网络参数优化（somaxconn, netdev_max_backlog, tcp_max_syn_backlog）
   - 内存参数优化（swappiness, dirty_ratio, dirty_background_ratio）
   - I/O 参数优化（dirty_writeback_centisecs, dirty_expire_centisecs）

**注意事项：**
- 需要 root 权限运行
- 部分配置需要重启系统生效
- 建议在生产环境使用前在测试环境验证

### 10.2 平台兼容性测试

#### 平台测试脚本详解

`platform-test.sh` 脚本提供全面的平台兼容性测试：

```bash
# 运行平台测试
./scripts/platform-test.sh
```

**测试内容包括：**

1. **系统环境检测**
   - 操作系统类型和版本
   - 内核版本
   - 系统架构
   - 内存容量
   - 磁盘空间

2. **Docker环境测试**
   - Docker版本检查
   - Docker Compose版本检查
   - Docker服务状态
   - Docker权限验证

3. **ClickHouse功能测试**
   - 服务启动测试
   - 数据库连接测试
   - 基本查询测试
   - 性能基准测试

4. **网络连接测试**
   - 端口监听状态
   - 网络连通性
   - 防火墙配置

### 10.3 用户管理工具

#### 用户测试脚本详解

`test-users.sh` 脚本用于测试用户配置和权限：

```bash
# 运行用户测试
./scripts/test-users.sh
```

**测试内容包括：**

1. **用户连接测试**
   - 管理员用户连接测试
   - Web用户连接测试
   - 密码验证

2. **权限验证**
   - 用户权限查询
   - 权限信息显示
   - 权限配置验证

3. **安全配置检查**
   - 用户配置完整性
   - 权限设置合理性

### 10.4 密码安全工具

#### 密码哈希生成工具详解

`generate-password-hash.sh` 脚本用于生成安全的密码哈希：

```bash
# 命令行参数方式
./scripts/generate-password-hash.sh "your_secure_password"

# 交互式输入方式
./scripts/generate-password-hash.sh
```

**功能特性：**

1. **SHA256哈希生成**
   - 使用 SHA256 算法
   - 生成十六进制哈希值

2. **多种输入方式**
   - 支持命令行参数
   - 支持交互式输入
   - 密码隐藏显示

3. **配置示例**
   - 提供 users.xml 配置示例
   - 便于直接复制使用

### 10.5 自动化运维集成

#### 定时任务配置

```bash
# 编辑 crontab
crontab -e

# 完整的定时任务配置
# 每小时健康检查
0 * * * * /opt/clickhouse-deploy/scripts/health-check.sh

# 每5分钟监控检查
*/5 * * * * /opt/clickhouse-deploy/scripts/monitor.sh --once

# 每天凌晨2点备份
0 2 * * * /opt/clickhouse-deploy/scripts/backup.sh

# 每周系统优化检查
0 3 * * 0 /opt/clickhouse-deploy/scripts/system-optimization.sh

# 每天平台测试
0 4 * * * /opt/clickhouse-deploy/scripts/platform-test.sh

# 每天用户配置测试
0 5 * * * /opt/clickhouse-deploy/scripts/test-users.sh
```

#### 监控告警集成

```bash
# 配置邮件告警
# 编辑 monitor.conf 或 health-check.conf
ALERT_EMAIL="admin@example.com"

# 配置告警阈值
ALERT_THRESHOLD_MEMORY=80
ALERT_THRESHOLD_CONNECTIONS=100
ALERT_THRESHOLD_DISK=80
ALERT_THRESHOLD_SLOW_QUERIES=10
```

## 总结

本运维手册提供了ClickHouse Docker部署的完整运维指南，包括新增的自动化脚本功能。运维人员应熟练掌握这些操作，确保ClickHouse服务的稳定运行。

### 关键要点：

1. **自动化部署**: 使用一键部署脚本快速部署
2. **日常监控**: 定期检查服务状态和系统资源
3. **备份策略**: 建立完善的数据备份和恢复机制
4. **系统优化**: 使用自动化脚本优化系统性能
5. **平台测试**: 定期进行兼容性和功能测试
6. **用户管理**: 安全的用户配置和权限管理
7. **安全防护**: 实施适当的安全措施保护数据安全
8. **应急响应**: 建立快速响应机制处理突发事件

### 脚本使用建议：

1. **生产环境**: 优先使用自动化脚本，减少人工操作错误
2. **测试环境**: 在测试环境充分验证脚本功能
3. **定期维护**: 建立定时任务自动执行维护操作
4. **监控告警**: 配置邮件告警及时发现问题
5. **文档记录**: 记录脚本使用和配置变更
