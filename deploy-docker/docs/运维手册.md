# ClickHouse 运维手册

## 概述

本文档提供ClickHouse Docker部署的运维操作指南，包括日常维护、故障排查、性能优化等内容。

## 1. 日常运维操作

### 1.1 服务管理

#### 启动服务

```bash
# 启动ClickHouse服务
docker-compose up -d

# 查看服务状态
docker-compose ps
```

#### 停止服务

```bash
# 停止ClickHouse服务
docker-compose down

# 停止并删除数据卷
docker-compose down -v
```

#### 重启服务

```bash
# 重启ClickHouse服务
docker-compose restart

# 重启特定服务
docker-compose restart clickhouse
```

### 1.2 日志管理

#### 查看实时日志

```bash
# 查看ClickHouse日志
docker-compose logs -f clickhouse

# 查看最近100行日志
docker-compose logs --tail=100 clickhouse
```

#### 日志文件位置

```bash
# 容器内日志路径
/var/log/clickhouse-server/

# 宿主机日志路径
./clickhouse/logs/
```

### 1.3 数据管理

#### 连接数据库

```bash
# 使用Docker Compose连接
docker-compose exec clickhouse clickhouse-client

# 使用密码连接
docker-compose exec clickhouse clickhouse-client --password=clickhouse123
```

#### 数据库操作

```sql
-- 查看数据库列表
SHOW DATABASES;

-- 创建数据库
CREATE DATABASE test_db;

-- 删除数据库
DROP DATABASE test_db;
```

### 1.4 备份恢复

#### 创建备份

```bash
# 运行备份脚本
./scripts/backup.sh

# 手动备份
docker-compose exec clickhouse clickhouse-client --query "
    BACKUP DATABASE default TO '/backup/default_backup'
"
```

#### 恢复数据

```bash
# 恢复数据库
docker-compose exec clickhouse clickhouse-client --query "
    RESTORE DATABASE default FROM '/backup/default_backup'
"
```

## 2. 监控运维

### 2.1 系统监控

#### 运行监控脚本

```bash
# 执行监控检查
./scripts/monitor.sh

# 定时监控（添加到crontab）
# 每5分钟执行一次监控
*/5 * * * * /opt/clickhouse-deploy/scripts/monitor.sh
```

#### 查看系统资源

```bash
# 查看容器资源使用
docker stats clickhouse-server

# 查看系统资源
htop
df -h
free -h
```

### 2.2 ClickHouse监控

#### 查看系统表

```sql
-- 查看系统指标
SELECT * FROM system.metrics;

-- 查看系统事件
SELECT * FROM system.events;

-- 查看当前进程
SELECT * FROM system.processes;

-- 查看查询日志
SELECT * FROM system.query_log ORDER BY event_time DESC LIMIT 10;
```

#### 性能监控查询

```sql
-- 查看慢查询
SELECT 
    query,
    query_duration_ms,
    user,
    client_hostname
FROM system.query_log 
WHERE query_duration_ms > 1000
ORDER BY query_duration_ms DESC
LIMIT 10;

-- 查看内存使用
SELECT 
    metric,
    value,
    description
FROM system.metrics 
WHERE metric LIKE '%Memory%';

-- 查看缓存命中率
SELECT 
    metric,
    value
FROM system.metrics 
WHERE metric IN ('MarkCacheHits', 'MarkCacheMisses');
```

## 3. 监控告警机制

### 3.1 系统监控配置

#### 3.1.1 安装监控工具

```bash
# 安装系统监控工具
sudo yum install -y htop iotop nethogs

# 安装网络监控工具
sudo yum install -y iftop nload

# 安装日志分析工具
sudo yum install -y logwatch
```

#### 3.1.2 配置系统监控

```bash
# 创建监控脚本目录
mkdir -p /opt/monitoring/scripts

# 创建系统资源监控脚本
cat > /opt/monitoring/scripts/system_monitor.sh << 'EOF'
#!/bin/bash
# 系统资源监控脚本

LOG_FILE="/opt/monitoring/logs/system_monitor.log"
ALERT_EMAIL="admin@example.com"

# 创建日志目录
mkdir -p /opt/monitoring/logs

# 记录监控数据
echo "$(date '+%Y-%m-%d %H:%M:%S') - CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')%" >> $LOG_FILE
echo "$(date '+%Y-%m-%d %H:%M:%S') - Memory: $(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')%" >> $LOG_FILE
echo "$(date '+%Y-%m-%d %H:%M:%S') - Disk: $(df /opt/clickhouse-deploy | tail -1 | awk '{print $5}')" >> $LOG_FILE

# 检查告警条件
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')
MEMORY_USAGE=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
DISK_USAGE=$(df /opt/clickhouse-deploy | tail -1 | awk '{print $5}' | sed 's/%//')

# CPU告警
if (( $(echo "$CPU_USAGE > 80" | bc -l) )); then
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ALERT: CPU usage is ${CPU_USAGE}%" >> $LOG_FILE
fi

# 内存告警
if (( $(echo "$MEMORY_USAGE > 85" | bc -l) )); then
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ALERT: Memory usage is ${MEMORY_USAGE}%" >> $LOG_FILE
fi

# 磁盘告警
if [ "$DISK_USAGE" -gt 85 ]; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ALERT: Disk usage is ${DISK_USAGE}%" >> $LOG_FILE
fi
EOF

chmod +x /opt/monitoring/scripts/system_monitor.sh
```

#### 3.1.3 设置定时监控

```bash
# 编辑crontab
crontab -e

# 添加以下监控任务
# 每5分钟执行系统监控
*/5 * * * * /opt/monitoring/scripts/system_monitor.sh

# 每10分钟执行ClickHouse监控
*/10 * * * * /opt/clickhouse-deploy/scripts/monitor.sh

# 每天凌晨2点执行备份
0 2 * * * /opt/clickhouse-deploy/scripts/backup.sh
```

### 3.2 ClickHouse监控配置

#### 3.2.1 启用查询日志

```yaml
# 编辑 clickhouse/config/config.yml
clickhouse:
  # 添加查询日志配置
  query_log:
    database: system
    table: query_log
    partition_by: toYYYYMM(event_date)
    flush_interval_milliseconds: 7500
    log_query_settings: 1
    log_query_threads: 1
```

#### 3.2.2 创建监控视图

```sql
-- 连接ClickHouse后执行
-- 创建慢查询监控视图
CREATE VIEW system.slow_queries AS
SELECT 
    query,
    query_duration_ms,
    user,
    client_hostname,
    event_time
FROM system.query_log 
WHERE query_duration_ms > 5000
ORDER BY query_duration_ms DESC;

-- 创建性能监控视图
CREATE VIEW system.performance_metrics AS
SELECT 
    metric,
    value,
    description
FROM system.metrics 
WHERE metric IN (
    'MemoryTracking',
    'MarkCacheHits',
    'MarkCacheMisses',
    'UncompressedCacheHits',
    'UncompressedCacheMisses'
);
```

#### 3.2.3 监控查询示例

```sql
-- 查看慢查询
SELECT 
    query,
    query_duration_ms,
    user,
    event_time
FROM system.query_log 
WHERE query_duration_ms > 1000
ORDER BY query_duration_ms DESC
LIMIT 10;

-- 查看内存使用
SELECT 
    metric,
    value,
    description
FROM system.metrics 
WHERE metric LIKE '%Memory%';

-- 查看缓存命中率
SELECT 
    'Mark Cache Hit Rate' as metric,
    round(MarkCacheHits / (MarkCacheHits + MarkCacheMisses) * 100, 2) as hit_rate
FROM system.metrics 
WHERE metric IN ('MarkCacheHits', 'MarkCacheMisses');
```

### 3.3 告警机制

#### 3.3.1 邮件告警配置

```bash
# 安装邮件工具
sudo yum install -y mailx

# 配置邮件服务（以Gmail为例）
sudo tee /etc/mail.rc << EOF
set from=your-email@gmail.com
set smtp=smtp.gmail.com:587
set smtp-use-starttls
set smtp-auth=login
set smtp-auth-user=your-email@gmail.com
set smtp-auth-password=your-app-password
EOF
```

#### 3.3.2 告警脚本

```bash
# 创建告警脚本
cat > /opt/monitoring/scripts/alert.sh << 'EOF'
#!/bin/bash
# 告警脚本

ALERT_EMAIL="admin@example.com"
LOG_FILE="/opt/monitoring/logs/alert.log"

send_alert() {
    local subject="$1"
    local message="$2"
    
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $subject: $message" >> $LOG_FILE
    
    # 发送邮件告警
    echo "$message" | mail -s "$subject" $ALERT_EMAIL
}

# 检查ClickHouse服务状态
if ! docker-compose ps | grep -q "clickhouse-server.*Up"; then
    send_alert "ClickHouse Service Alert" "ClickHouse service is down!"
fi

# 检查内存使用
MEMORY_USAGE=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
if (( $(echo "$MEMORY_USAGE > 90" | bc -l) )); then
    send_alert "Memory Alert" "Memory usage is ${MEMORY_USAGE}%"
fi

# 检查磁盘使用
DISK_USAGE=$(df /opt/clickhouse-deploy | tail -1 | awk '{print $5}' | sed 's/%//')
if [ "$DISK_USAGE" -gt 90 ]; then
    send_alert "Disk Alert" "Disk usage is ${DISK_USAGE}%"
fi
EOF

chmod +x /opt/monitoring/scripts/alert.sh
```

#### 3.3.3 设置告警定时任务

```bash
# 添加到crontab
# 每5分钟检查一次告警
*/5 * * * * /opt/monitoring/scripts/alert.sh
```

## 4. 数据备份策略

### 4.1 备份策略设计

#### 4.1.1 备份类型

- **全量备份**: 每周一凌晨执行，保留4周
- **实时备份**: 重要数据变更时立即备份

#### 4.1.2 备份存储策略

```bash
# 创建备份目录结构
mkdir -p /opt/clickhouse-backup/{weekly}
mkdir -p /opt/clickhouse-backup/logs

# 设置备份目录权限
chmod 755 /opt/clickhouse-backup
chmod 755 /opt/clickhouse-backup/{weekly}
```

### 4.2 自动化备份脚本

#### 4.2.1 增强版备份脚本

```bash
# 创建增强版备份脚本
cat > /opt/clickhouse-deploy/scripts/enhanced_backup.sh << 'EOF'
#!/bin/bash
# 增强版ClickHouse备份脚本

set -e

# 配置变量
BACKUP_ROOT="/opt/clickhouse-backup"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="clickhouse_backup_$DATE"
RETENTION_WEEKS=4

# 备份类型
BACKUP_TYPE=${1:-weekly}  # weekly

# 创建备份目录
mkdir -p $BACKUP_ROOT/{weekly,logs}

echo "=== ClickHouse 增强备份开始 ==="
echo "备份时间: $(date)"
echo "备份类型: $BACKUP_TYPE"
echo "备份目录: $BACKUP_ROOT"

# 检查ClickHouse容器是否运行
if ! docker-compose ps | grep -q "clickhouse-server.*Up"; then
    echo "错误: ClickHouse容器未运行"
    exit 1
fi

# 创建备份
echo "开始创建备份..."
docker-compose exec clickhouse clickhouse-client --query "
    BACKUP DATABASE default TO '$BACKUP_ROOT/$BACKUP_TYPE/$BACKUP_NAME'
"

# 检查备份是否成功
if [ $? -eq 0 ]; then
    echo "备份创建成功: $BACKUP_ROOT/$BACKUP_TYPE/$BACKUP_NAME"
    
    # 压缩备份文件
    echo "压缩备份文件..."
    cd $BACKUP_ROOT/$BACKUP_TYPE
    tar -czf "${BACKUP_NAME}.tar.gz" "$BACKUP_NAME"
    rm -rf "$BACKUP_NAME"
    
    echo "备份压缩完成: ${BACKUP_NAME}.tar.gz"
    
    # 记录备份日志
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $BACKUP_TYPE backup completed: ${BACKUP_NAME}.tar.gz" >> $BACKUP_ROOT/logs/backup.log
    
    # 清理旧备份
    echo "清理旧备份文件..."
    find $BACKUP_ROOT/weekly -name "*.tar.gz" -mtime +$((RETENTION_WEEKS * 7)) -delete
    
else
    echo "错误: 备份创建失败"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $BACKUP_TYPE backup failed" >> $BACKUP_ROOT/logs/backup.log
    exit 1
fi

# 显示备份统计
echo "=== 备份统计 ==="
echo "当前备份文件:"
ls -lh $BACKUP_ROOT/$BACKUP_TYPE/*.tar.gz 2>/dev/null || echo "无备份文件"

echo "=== 备份完成 ==="
EOF

chmod +x /opt/clickhouse-deploy/scripts/enhanced_backup.sh
```

#### 4.2.2 备份恢复脚本

```bash
# 创建备份恢复脚本
cat > /opt/clickhouse-deploy/scripts/restore.sh << 'EOF'
#!/bin/bash
# ClickHouse备份恢复脚本

set -e

BACKUP_ROOT="/opt/clickhouse-backup"
BACKUP_TYPE=${1:-weekly}
BACKUP_FILE=${2}

if [ -z "$BACKUP_FILE" ]; then
    echo "用法: $0 <backup_type> <backup_file>"
    echo "示例: $0 weekly clickhouse_backup_20231201_020000.tar.gz"
    exit 1
fi

BACKUP_PATH="$BACKUP_ROOT/$BACKUP_TYPE/$BACKUP_FILE"

if [ ! -f "$BACKUP_PATH" ]; then
    echo "错误: 备份文件不存在: $BACKUP_PATH"
    exit 1
fi

echo "=== ClickHouse 备份恢复 ==="
echo "备份文件: $BACKUP_PATH"

# 停止服务
echo "停止ClickHouse服务..."
docker-compose down

# 清理现有数据
echo "清理现有数据..."
sudo rm -rf clickhouse/data/*

# 解压备份文件
echo "解压备份文件..."
cd $BACKUP_ROOT/$BACKUP_TYPE
tar -xzf "$BACKUP_FILE"

# 恢复数据
echo "恢复数据..."
BACKUP_DIR=$(basename "$BACKUP_FILE" .tar.gz)
docker-compose up -d

# 等待服务启动
echo "等待服务启动..."
sleep 30

# 恢复数据
echo "执行数据恢复..."
docker-compose exec clickhouse clickhouse-client --query "
    RESTORE DATABASE default FROM '$BACKUP_ROOT/$BACKUP_TYPE/$BACKUP_DIR'
"

# 清理临时文件
rm -rf "$BACKUP_DIR"

echo "=== 备份恢复完成 ==="
EOF

chmod +x /opt/clickhouse-deploy/scripts/restore.sh
```

### 4.3 备份策略实施

#### 4.3.1 设置定时备份

```bash
# 编辑crontab
crontab -e

# 添加以下备份任务
# 每周一凌晨2点执行全量备份
0 2 * * 1 /opt/clickhouse-deploy/scripts/enhanced_backup.sh weekly
```

#### 4.3.2 备份验证脚本

```bash
# 创建备份验证脚本
cat > /opt/clickhouse-deploy/scripts/verify_backup.sh << 'EOF'
#!/bin/bash
# 备份验证脚本

BACKUP_ROOT="/opt/clickhouse-backup"
BACKUP_TYPE=${1:-weekly}

echo "=== 备份验证 ==="
echo "检查 $BACKUP_TYPE 备份..."

# 检查备份文件
BACKUP_COUNT=$(find $BACKUP_ROOT/$BACKUP_TYPE -name "*.tar.gz" | wc -l)
echo "备份文件数量: $BACKUP_COUNT"

# 检查最新备份
LATEST_BACKUP=$(find $BACKUP_ROOT/$BACKUP_TYPE -name "*.tar.gz" -printf '%T@ %p\n' | sort -n | tail -1 | cut -f2- -d" ")
if [ -n "$LATEST_BACKUP" ]; then
    echo "最新备份: $(basename $LATEST_BACKUP)"
    echo "备份大小: $(du -h $LATEST_BACKUP | cut -f1)"
    echo "备份时间: $(stat -c %y $LATEST_BACKUP)"
else
    echo "警告: 未找到备份文件"
fi

# 检查备份日志
echo "最近的备份日志:"
tail -5 $BACKUP_ROOT/logs/backup.log 2>/dev/null || echo "无备份日志"

echo "=== 验证完成 ==="
EOF

chmod +x /opt/clickhouse-deploy/scripts/verify_backup.sh
```

### 4.4 备份监控和告警

#### 4.4.1 备份监控脚本

```bash
# 创建备份监控脚本
cat > /opt/monitoring/scripts/backup_monitor.sh << 'EOF'
#!/bin/bash
# 备份监控脚本

BACKUP_ROOT="/opt/clickhouse-backup"
ALERT_EMAIL="admin@example.com"

# 检查最近备份
LATEST_BACKUP=$(find $BACKUP_ROOT/weekly -name "*.tar.gz" -printf '%T@ %p\n' 2>/dev/null | sort -n | tail -1 | cut -f2- -d" ")

if [ -z "$LATEST_BACKUP" ]; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ALERT: No backup found!" | mail -s "Backup Alert" $ALERT_EMAIL
    exit 1
fi

# 检查备份时间（超过7天告警）
BACKUP_TIME=$(stat -c %Y "$LATEST_BACKUP")
CURRENT_TIME=$(date +%s)
TIME_DIFF=$((CURRENT_TIME - BACKUP_TIME))

if [ $TIME_DIFF -gt 604800 ]; then  # 7天 = 604800秒
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ALERT: Backup is older than 7 days!" | mail -s "Backup Alert" $ALERT_EMAIL
fi

# 检查备份大小（小于1MB告警）
BACKUP_SIZE=$(stat -c %s "$LATEST_BACKUP")
if [ $BACKUP_SIZE -lt 1048576 ]; then  # 1MB = 1048576字节
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ALERT: Backup size is too small!" | mail -s "Backup Alert" $ALERT_EMAIL
fi
EOF

chmod +x /opt/monitoring/scripts/backup_monitor.sh
```

#### 4.4.2 设置备份监控定时任务

```bash
# 添加到crontab
# 每天检查一次备份状态
0 8 * * * /opt/monitoring/scripts/backup_monitor.sh
```

### 4.5 备份策略最佳实践

#### 4.5.1 备份策略建议

- **RTO (Recovery Time Objective)**: 目标恢复时间 < 30分钟
- **RPO (Recovery Point Objective)**: 目标恢复点 < 1周
- **备份保留期**: 每周备份保留4周

#### 4.5.2 备份测试

```bash
# 定期测试备份恢复
# 每月测试一次备份恢复流程
0 5 1 * * /opt/clickhouse-deploy/scripts/verify_backup.sh weekly
```

## 5. 故障排查

### 5.1 常见问题

#### 问题1: 容器启动失败

**症状：**

- 容器状态为Exited
- 无法访问ClickHouse服务

**排查步骤：**

```bash
# 1. 查看容器日志
docker-compose logs clickhouse

# 2. 检查配置文件语法
docker-compose exec clickhouse clickhouse-server --config-file=/etc/clickhouse-server/config.xml --validate-config

# 3. 检查端口占用
sudo netstat -tlnp | grep :8123
sudo netstat -tlnp | grep :9000

# 4. 检查目录权限
ls -la clickhouse/data/
ls -la clickhouse/logs/
```

**解决方案：**

```bash
# 修复权限问题
sudo chown -R 101:101 clickhouse/data
sudo chown -R 101:101 clickhouse/logs

# 重新启动服务
docker-compose down
docker-compose up -d
```

#### 问题2: 内存不足

**症状：**

- 查询执行失败
- 系统响应缓慢
- 内存使用率过高

**排查步骤：**

```bash
# 1. 检查内存使用
docker stats clickhouse-server
free -h

# 2. 查看ClickHouse内存配置
docker-compose exec clickhouse clickhouse-client --query "
    SELECT name, value FROM system.settings 
    WHERE name LIKE '%memory%'
"
```

**解决方案：**

```bash
# 调整内存配置
# 编辑 users.xml 文件中的内存相关配置
# 重启服务
docker-compose restart
```

#### 问题3: 磁盘空间不足

**症状：**

- 写入操作失败
- 系统告警磁盘空间不足

**排查步骤：**

```bash
# 1. 检查磁盘使用
df -h
du -sh clickhouse/data/

# 2. 查看ClickHouse数据大小
docker-compose exec clickhouse clickhouse-client --query "
    SELECT 
        database,
        table,
        formatReadableSize(sum(bytes)) as size
    FROM system.parts 
    WHERE active
    GROUP BY database, table
    ORDER BY sum(bytes) DESC
"
```

**解决方案：**

```bash
# 清理旧数据
docker-compose exec clickhouse clickhouse-client --query "
    OPTIMIZE TABLE database.table FINAL
"

# 删除过期分区
docker-compose exec clickhouse clickhouse-client --query "
    ALTER TABLE database.table DROP PARTITION '2023-01'
"
```

### 5.2 性能问题排查

#### 慢查询分析

```sql
-- 查看慢查询
SELECT 
    query,
    query_duration_ms,
    user,
    client_hostname,
    event_time
FROM system.query_log 
WHERE query_duration_ms > 5000
ORDER BY query_duration_ms DESC
LIMIT 20;

-- 分析查询执行计划
EXPLAIN SELECT * FROM table WHERE condition;
```

#### 资源使用分析

```sql
-- 查看表大小
SELECT 
    database,
    table,
    formatReadableSize(sum(bytes)) as size,
    sum(rows) as rows
FROM system.parts 
WHERE active
GROUP BY database, table
ORDER BY sum(bytes) DESC;

-- 查看分区信息
SELECT 
    database,
    table,
    partition,
    formatReadableSize(sum(bytes)) as size
FROM system.parts 
WHERE active
GROUP BY database, table, partition
ORDER BY sum(bytes) DESC;
```

## 6. 性能优化

### 6.1 配置优化

#### 内存优化

```yaml
# 根据服务器内存调整
clickhouse:
  # 内存配置
  max_memory_usage: 12000000000
  max_memory_usage_for_user: 10000000000
  uncompressed_cache_size: 6442450944
  mark_cache_size: 3221225472
```

#### 并发优化

```yaml
# 根据CPU核心数调整
clickhouse:
  # 并发配置
  max_threads: 4
  max_insert_threads: 4
  max_concurrent_queries: 100
```

### 6.2 表结构优化

#### 分区策略

```sql
-- 按日期分区
CREATE TABLE events (
    event_date Date,
    event_time DateTime,
    user_id UInt32,
    event_type String
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(event_date)
ORDER BY (event_date, event_time);
```

#### 索引优化

```sql
-- 创建跳数索引
ALTER TABLE table ADD INDEX idx_user_id user_id TYPE minmax GRANULARITY 4;

-- 创建投影
ALTER TABLE table ADD PROJECTION proj_user_id (
    SELECT user_id, count()
    GROUP BY user_id
);
```

### 6.3 查询优化

#### 查询优化技巧

```sql
-- 使用PREWHERE优化
SELECT * FROM table PREWHERE user_id = 123 WHERE event_type = 'click';

-- 使用LIMIT优化
SELECT * FROM table WHERE condition LIMIT 1000;

-- 使用采样优化
SELECT * FROM table SAMPLE 0.1 WHERE condition;
```

## 7. 安全运维

### 7.1 用户管理

#### 创建用户

```sql
-- 创建只读用户
CREATE USER readonly IDENTIFIED BY 'readonly123';
GRANT SELECT ON *.* TO readonly;

-- 创建写入用户
CREATE USER writer IDENTIFIED BY 'writer123';
GRANT INSERT, SELECT ON database.* TO writer;
```

#### 权限管理

```sql
-- 查看用户权限
SHOW GRANTS FOR readonly;

-- 撤销权限
REVOKE SELECT ON database.table FROM readonly;
```

### 7.2 网络安全

#### 防火墙配置

```bash
# 开放ClickHouse端口
sudo firewall-cmd --permanent --add-port=8123/tcp
sudo firewall-cmd --permanent --add-port=9000/tcp
sudo firewall-cmd --reload

# 限制访问IP
sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="192.168.1.0/24" port protocol="tcp" port="8123" accept'
```

#### SSL配置

```yaml
# 启用SSL
clickhouse:
  https_port: 8443
  certificate_file: /etc/clickhouse-server/server.crt
  private_key_file: /etc/clickhouse-server/server.key
```

## 8. 升级维护

### 8.1 版本升级

#### 升级步骤

```bash
# 1. 备份数据
./scripts/backup.sh

# 2. 停止服务
docker-compose down

# 3. 更新镜像版本
# 编辑 docker-compose.yml 中的镜像版本

# 4. 重新部署
docker-compose up -d

# 5. 验证升级
docker-compose exec clickhouse clickhouse-client --query "SELECT version()"
```

#### 升级检查清单

- [ ] 数据备份完成
- [ ] 配置文件兼容性检查
- [ ] 服务启动验证
- [ ] 功能测试通过
- [ ] 性能测试通过

### 8.2 维护计划

#### 日常维护

- [ ] 每日监控检查
- [ ] 每周备份验证
- [ ] 每月性能分析
- [ ] 每季度安全审计

#### 定期维护

- [ ] 清理过期日志
- [ ] 优化表结构
- [ ] 更新安全补丁
- [ ] 容量规划评估

## 9. 应急响应

### 9.1 服务中断处理

#### 立即响应

1. 检查服务状态
2. 查看错误日志
3. 评估影响范围
4. 通知相关人员

#### 恢复步骤

1. 停止问题服务
2. 分析根本原因
3. 实施修复方案
4. 验证服务恢复
5. 监控服务状态

### 9.2 数据恢复

#### 数据丢失处理

1. 停止写入操作
2. 评估数据丢失范围
3. 从备份恢复数据
4. 验证数据完整性
5. 恢复服务运行

## 总结

本运维手册提供了ClickHouse Docker部署的完整运维指南。运维人员应熟练掌握这些操作，确保ClickHouse服务的稳定运行。

### 关键要点：

1. **日常监控**: 定期检查服务状态和系统资源
2. **备份策略**: 建立完善的数据备份和恢复机制
3. **性能优化**: 根据业务需求持续优化配置和查询
4. **安全防护**: 实施适当的安全措施保护数据安全
5. **应急响应**: 建立快速响应机制处理突发事件
